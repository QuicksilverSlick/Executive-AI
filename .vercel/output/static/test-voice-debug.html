<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>WebRTC Voice Agent Debug Panel</title><style>body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background-color:#f5f5f5}.container{display:grid;grid-template-columns:1fr 1fr;gap:20px}.panel{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.full-width{grid-column:1/-1}.status{padding:10px;margin:10px 0;border-radius:5px;font-weight:700}.connected{background-color:#d4edda;color:#155724}.disconnected{background-color:#f8d7da;color:#721c24}.connecting{background-color:#fff3cd;color:#856404}.info{background-color:#d1ecf1;color:#0c5460}button{padding:10px 20px;margin:5px;border:none;border-radius:5px;background-color:#007bff;color:#fff;cursor:pointer}button:hover{background-color:#0056b3}button:disabled{background-color:#6c757d;cursor:not-allowed}#logs{background-color:#2d2d2d;color:#f0f0f0;padding:10px;border-radius:5px;height:400px;overflow-y:scroll;font-family:'Courier New',monospace;font-size:12px}.log-error{color:#ff6b6b}.log-success{color:#51cf66}.log-warning{color:#ffd93d}.log-info{color:#74c0fc}.log-event{color:#ff8cc3}.metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}.metric{padding:10px;background:#f0f0f0;border-radius:5px}.metric-label{font-size:12px;color:#666}.metric-value{font-size:18px;font-weight:700}#audioVisualizer{width:100%;height:100px;background:#000;border-radius:5px}.event-monitor{max-height:200px;overflow-y:auto;background:#f9f9f9;padding:10px;border-radius:5px;font-size:12px}.event-item{padding:5px;margin:2px 0;background:#fff;border-radius:3px}</style></head><body><h1>WebRTC Voice Agent Debug Panel</h1><div class=container><div class=panel><h2>Connection Status</h2><div class="status disconnected" id=connectionStatus>Disconnected</div><div class="status info" id=conversationStatus>Idle</div><div class=metrics><div class=metric><div class=metric-label>Token Status</div><div class=metric-value id=tokenStatus>None</div></div><div class=metric><div class=metric-label>Session ID</div><div class=metric-value id=sessionId>None</div></div><div class=metric><div class=metric-label>ICE State</div><div class=metric-value id=iceState>None</div></div><div class=metric><div class=metric-label>Data Channel</div><div class=metric-value id=dataChannelState>None</div></div></div></div><div class=panel><h2>Audio Status</h2><canvas id=audioVisualizer></canvas><div class=metrics><div class=metric><div class=metric-label>Audio Level</div><div class=metric-value id=audioLevel>0%</div></div><div class=metric><div class=metric-label>VAD Status</div><div class=metric-value id=vadStatus>Inactive</div></div><div class=metric><div class=metric-label>Local Tracks</div><div class=metric-value id=localTracks>0</div></div><div class=metric><div class=metric-label>Remote Tracks</div><div class=metric-value id=remoteTracks>0</div></div></div></div><div class="panel full-width"><h2>Controls</h2><button onclick=initializeAgent()>Initialize Agent</button> <button onclick=testResponse()>Test Response</button> <button onclick=sendTestMessage()>Send Text Message</button> <button onclick=manualResponse()>Manual Response Trigger</button> <button onclick=checkDataChannel()>Check Data Channel</button> <button onclick=checkAudioTracks()>Check Audio Tracks</button> <button onclick=clearLogs()>Clear Logs</button> <button onclick=downloadLogs()>Download Logs</button></div><div class=panel><h2>Realtime Events</h2><div class=event-monitor id=eventMonitor></div></div><div class=panel><h2>Transcripts</h2><h4>User:</h4><div id=userTranscript style=background:#f0f0f0;padding:10px;border-radius:5px;min-height:50px></div><h4>Assistant:</h4><div id=assistantTranscript style=background:#f0f0f0;padding:10px;border-radius:5px;min-height:50px></div></div><div class="panel full-width"><h2>Debug Logs</h2><div id=logs></div></div></div><script>let voiceAgent=null,allLogs=[];const logs=document.getElementById("logs"),eventMonitor=document.getElementById("eventMonitor");function log(e,n="info"){const t=(new Date).toISOString(),o={timestamp:t,message:e,type:n};allLogs.push(o);const i=document.createElement("div");i.className=`log-${n}`,i.textContent=`[${t}] ${e}`,logs.appendChild(i),logs.scrollTop=logs.scrollHeight,console.log(e)}function updateStatus(e,n,t){const o=document.getElementById(e);o&&(o.textContent=n,o.className=`status ${t}`)}function updateMetric(e,n){const t=document.getElementById(e);t&&(t.textContent=n)}function addEvent(e){const n=document.createElement("div");for(n.className="event-item",n.innerHTML=`<strong>${e.type}</strong>: ${JSON.stringify(e,null,2).substring(0,200)}...`,eventMonitor.insertBefore(n,eventMonitor.firstChild);eventMonitor.children.length>20;)eventMonitor.removeChild(eventMonitor.lastChild)}async function initializeAgent(){try{log("Starting WebRTC Voice Agent initialization...","info");const e=(await import("/src/lib/voice-agent/webrtc/main.ts")).WebRTCVoiceAgent;voiceAgent=new e({apiEndpoint:"/api/voice-agent",features:{continuousListening:!0,autoReconnect:!0,echoCancellation:!0,noiseSuppression:!0}}),setupEventHandlers(),await voiceAgent.initialize(),log("Voice agent initialized successfully!","success"),window.voiceAgent=voiceAgent}catch(e){log(`Initialization failed: ${e.message}`,"error"),console.error(e)}}function setupEventHandlers(){voiceAgent.on("connectionStateChanged",(e=>{log(`Connection state changed: ${e}`,"event"),updateStatus("connectionStatus",e,"connected"===e?"connected":"connecting"===e?"connecting":"disconnected")})),voiceAgent.on("conversationStateChanged",(e=>{log(`Conversation state changed: ${e}`,"event"),updateStatus("conversationStatus",e,"info")})),voiceAgent.on("audioLevel",(e=>{updateMetric("audioLevel",`${Math.round(100*e)}%`)})),voiceAgent.on("speechStarted",(()=>{log("Speech started","event"),updateMetric("vadStatus","Speaking")})),voiceAgent.on("speechEnded",(()=>{log("Speech ended","event"),updateMetric("vadStatus","Silent")})),voiceAgent.on("playbackStarted",(()=>{log("Playback started","event")})),voiceAgent.on("playbackFinished",(()=>{log("Playback finished","event")})),voiceAgent.on("userTranscript",(e=>{log(`User transcript: ${e.text} (final: ${e.isFinal})`,"info"),document.getElementById("userTranscript").textContent=e.text})),voiceAgent.on("assistantTranscript",(e=>{log(`Assistant transcript: ${e.text} (final: ${e.isFinal})`,"info"),document.getElementById("assistantTranscript").textContent=e.text})),voiceAgent.on("error",(e=>{log(`Error: ${e.message} (${e.type})`,"error")})),voiceAgent.on("warning",(e=>{log(`Warning: ${e}`,"warning")})),voiceAgent.connection&&(voiceAgent.connection.on("realtimeEvent",(e=>{log(`Realtime event: ${e.type}`,"event"),addEvent(e)})),voiceAgent.connection.on("audioTrack",(e=>{log("Audio track received from OpenAI!","success"),updateMetric("remoteTracks",e.getAudioTracks().length)})),voiceAgent.connection.on("dataChannelOpen",(()=>{log("Data channel opened!","success"),updateMetric("dataChannelState","Open")})),voiceAgent.connection.on("dataChannelClose",(()=>{log("Data channel closed","warning"),updateMetric("dataChannelState","Closed")})))}function testResponse(){voiceAgent&&voiceAgent.testResponse?(log("Triggering test response...","info"),voiceAgent.testResponse()):log("Voice agent not initialized or testResponse method not available","error")}function sendTestMessage(){const e=prompt("Enter a test message:","Hello, can you hear me?");e&&voiceAgent&&voiceAgent.sendMessage&&(log(`Sending message: "${e}"`,"info"),voiceAgent.sendMessage(e))}function manualResponse(){if(voiceAgent&&voiceAgent.connection){log("Manually triggering response.create event...","info");const e={event_id:`manual_msg_${Date.now()}`,type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:"Please respond with voice. This is a test."}]}};voiceAgent.connection.sendEvent(e),setTimeout((()=>{const e={event_id:`manual_resp_${Date.now()}`,type:"response.create",response:{modalities:["text","audio"],instructions:"Respond with a friendly greeting using voice."}};voiceAgent.connection.sendEvent(e),log("Response.create event sent","success")}),500)}}function checkDataChannel(){if(voiceAgent&&voiceAgent.connection&&voiceAgent.connection.dataChannel){const e=voiceAgent.connection.dataChannel;log(`Data channel state: ${e.readyState}`,"info"),log(`Data channel label: ${e.label}`,"info"),log(`Data channel bufferedAmount: ${e.bufferedAmount}`,"info"),updateMetric("dataChannelState",e.readyState)}else log("No data channel found","error")}function checkAudioTracks(){if(voiceAgent&&voiceAgent.connection&&voiceAgent.connection.peerConnection){const e=voiceAgent.connection.peerConnection,n=e.getSenders().filter((e=>e.track&&"audio"===e.track.kind)).length;log(`Local audio tracks: ${n}`,"info"),updateMetric("localTracks",n);const t=e.getReceivers(),o=t.filter((e=>e.track&&"audio"===e.track.kind)).length;log(`Remote audio tracks: ${o}`,"info"),updateMetric("remoteTracks",o),t.forEach(((e,n)=>{e.track&&"audio"===e.track.kind&&log(`Remote audio track ${n}: ${e.track.id}, state: ${e.track.readyState}, muted: ${e.track.muted}`,"info")}))}else log("No peer connection found","error")}function clearLogs(){logs.innerHTML="",allLogs=[],log("Logs cleared","info")}function downloadLogs(){const e=allLogs.map((e=>`[${e.timestamp}] [${e.type.toUpperCase()}] ${e.message}`)).join("\n"),n=new Blob([e],{type:"text/plain"}),t=URL.createObjectURL(n),o=document.createElement("a");o.href=t,o.download=`voice-agent-debug-${(new Date).toISOString()}.log`,o.click(),URL.revokeObjectURL(t)}function setupVisualizer(){const e=document.getElementById("audioVisualizer"),n=e.getContext("2d");e.width=e.offsetWidth,e.height=100,function t(){n.fillStyle="#000",n.fillRect(0,0,e.width,e.height),n.strokeStyle="#0f0",n.beginPath(),n.moveTo(0,e.height/2);for(let t=0;t<e.width;t++){const o=e.height/2+20*Math.sin(.02*t+.001*Date.now());n.lineTo(t,o)}n.stroke(),requestAnimationFrame(t)}()}function monitorPeerConnection(){setInterval((()=>{if(voiceAgent&&voiceAgent.connection&&voiceAgent.connection.peerConnection){updateMetric("iceState",voiceAgent.connection.peerConnection.iceConnectionState);const e=voiceAgent.connection.getConnectionInfo();e.sessionId&&updateMetric("sessionId",e.sessionId.substring(0,8)+"...")}}),1e3)}window.addEventListener("load",(()=>{setupVisualizer(),monitorPeerConnection();const e=console.log,n=console.error,t=console.warn;console.log=function(...n){e.apply(console,n);const t=n.map((e=>"object"==typeof e?JSON.stringify(e):e)).join(" ");(t.includes("[WebRTC")||t.includes("Realtime"))&&log(t,"info")},console.error=function(...e){n.apply(console,e);log(e.map((e=>"object"==typeof e?JSON.stringify(e):e)).join(" "),"error")},console.warn=function(...e){t.apply(console,e);log(e.map((e=>"object"==typeof e?JSON.stringify(e):e)).join(" "),"warning")}}))</script></body></html>