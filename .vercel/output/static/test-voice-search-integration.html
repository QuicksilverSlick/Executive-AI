<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Search Integration Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
        }
        .success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #dc2626;
            color: #dc2626;
        }
        .info {
            background: #dbeafe;
            border: 1px solid #2563eb;
            color: #1d4ed8;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Voice Search Integration Test</h1>
        <p>This test verifies that the web search function call integration works properly with the voice agent.</p>

        <!-- Test 1: Direct API Test -->
        <div class="test-section">
            <h2>1. Direct API Test</h2>
            <p>Test the responses-search endpoint directly</p>
            <button onclick="testDirectAPI()">Test API</button>
            <div id="direct-api-result"></div>
        </div>

        <!-- Test 2: Function Call Simulation -->
        <div class="test-section">
            <h2>2. Function Call Simulation</h2>
            <p>Simulate a web_search function call from the voice agent</p>
            <button onclick="testFunctionCall()">Test Function Call</button>
            <div id="function-call-result"></div>
        </div>

        <!-- Test 3: Voice Agent Integration -->
        <div class="test-section">
            <h2>3. Voice Agent Integration</h2>
            <p>Test the actual integration with voice agent components</p>
            <button onclick="testVoiceIntegration()">Test Voice Integration</button>
            <div id="voice-integration-result"></div>
        </div>

        <!-- Test 4: Citation Extraction -->
        <div class="test-section">
            <h2>4. Citation Extraction Test</h2>
            <p>Verify that citations are properly extracted from search results</p>
            <button onclick="testCitationExtraction()">Test Citations</button>
            <div id="citation-result"></div>
        </div>

        <!-- Debug Log -->
        <div class="test-section">
            <h2>Debug Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="debug-log" class="log"></div>
        </div>
    </div>

    <script>
        /*
         * DREAMFORGE HIVE-MIND CHAIN OF CUSTODY
         *
         * @file-purpose: End-to-end test for voice search integration
         * @version: 1.0.0
         * @init-author: test-agent
         * @init-cc-sessionId: cc-test-20250811-001
         * @init-timestamp: 2025-08-11T15:10:00Z
         * @reasoning:
         * - **Objective:** Test complete integration of web search with voice agent
         * - **Strategy:** Simulate real function calls and verify responses
         * - **Outcome:** Ensure search functionality works end-to-end
         */

        let testCounter = 0;

        function log(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.textContent = message;
            container.appendChild(result);
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }

        async function testDirectAPI() {
            log('üß™ Starting Direct API Test');
            const container = document.getElementById('direct-api-result');
            container.innerHTML = '';

            try {
                const query = 'What are the latest developments in AI?';
                log(`üì° Calling API with query: "${query}"`);

                const response = await fetch('/api/voice-agent/responses-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                log(`üìä Response status: ${response.status}`);
                log(`üìÑ Response data: ${JSON.stringify(data, null, 2).substring(0, 200)}...`);

                if (response.ok && data.success) {
                    showResult('direct-api-result', `‚úÖ API test passed: ${data.searchResults?.length || 0} results, ${data.citations?.length || 0} citations`, 'success');
                    
                    if (data.searchResults && data.searchResults.length > 0) {
                        showResult('direct-api-result', `üîç First result: ${data.searchResults[0].title}`, 'info');
                    }
                } else {
                    showResult('direct-api-result', `‚ùå API test failed: ${data.error || 'Unknown error'}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Direct API test error: ${error.message}`);
                showResult('direct-api-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testFunctionCall() {
            log('ü§ñ Starting Function Call Simulation');
            const container = document.getElementById('function-call-result');
            container.innerHTML = '';

            try {
                // Simulate the WebRTC Voice Agent function call flow
                const callId = `test_call_${++testCounter}`;
                const query = 'How to optimize JavaScript performance?';
                
                log(`üìû Simulating function call: ${callId}`);
                log(`üîç Query: "${query}"`);

                // Step 1: Call the search API (as the voice agent would)
                const searchResponse = await fetch('/api/voice-agent/responses-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query,
                        conversationContext: 'User is asking about performance optimization'
                    })
                });

                const searchData = await searchResponse.json();
                log(`üì° Search API status: ${searchResponse.status}`);

                if (!searchResponse.ok) {
                    throw new Error(`Search API error: ${searchData.error}`);
                }

                // Step 2: Simulate creating the function call result (as voice agent would)
                const functionResult = {
                    success: searchData.success,
                    query: query,
                    response: searchData.response,
                    searchResults: searchData.searchResults || [],
                    citations: searchData.citations || []
                };

                // Step 3: Simulate the OpenAI Realtime API event structure
                const realtimeEvent = {
                    event_id: `func_result_${callId}`,
                    type: 'conversation.item.create',
                    item: {
                        type: 'function_call_output',
                        call_id: callId,
                        output: JSON.stringify(functionResult)
                    }
                };

                log(`üìã Generated Realtime API event: ${JSON.stringify(realtimeEvent, null, 2).substring(0, 300)}...`);

                // Step 4: Validate the function call result
                if (functionResult.success) {
                    showResult('function-call-result', `‚úÖ Function call simulation passed`, 'success');
                    showResult('function-call-result', `üîç Search found ${functionResult.searchResults.length} results`, 'info');
                    showResult('function-call-result', `üìö Response has ${functionResult.citations.length} citations`, 'info');
                    
                    // Check if response is suitable for voice output
                    const responseText = functionResult.response;
                    if (responseText && responseText.length > 20 && /[.!?]/.test(responseText)) {
                        showResult('function-call-result', `üí¨ Response is voice-ready (${responseText.length} chars)`, 'success');
                    } else {
                        showResult('function-call-result', `‚ö†Ô∏è Response may not be suitable for voice output`, 'error');
                    }
                } else {
                    showResult('function-call-result', `‚ùå Function call failed: ${functionResult.error}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Function call simulation error: ${error.message}`);
                showResult('function-call-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testVoiceIntegration() {
            log('üé§ Starting Voice Integration Test');
            const container = document.getElementById('voice-integration-result');
            container.innerHTML = '';

            try {
                // Test the voice agent's web search configuration
                showResult('voice-integration-result', `üîß Checking voice agent configuration...`, 'info');

                // Verify the search endpoint is accessible
                const endpointTest = await fetch('/api/voice-agent/responses-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: 'test connection' })
                });

                if (!endpointTest.ok) {
                    throw new Error(`Endpoint not accessible: ${endpointTest.status}`);
                }

                showResult('voice-integration-result', `‚úÖ Search endpoint accessible`, 'success');

                // Test with a voice-specific query
                const voiceQuery = 'Tell me about machine learning algorithms';
                log(`üé§ Testing voice-optimized query: "${voiceQuery}"`);

                const voiceResponse = await fetch('/api/voice-agent/responses-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: voiceQuery,
                        conversationContext: 'User is speaking via voice interface'
                    })
                });

                const voiceData = await voiceResponse.json();

                if (voiceResponse.ok && voiceData.success) {
                    showResult('voice-integration-result', `‚úÖ Voice-optimized search successful`, 'success');
                    
                    // Check response quality for voice
                    const response = voiceData.response;
                    if (response && response.length >= 50) {
                        showResult('voice-integration-result', `üí¨ Response is appropriate length for speech (${response.length} chars)`, 'success');
                    }

                    if (voiceData.searchResults && voiceData.searchResults.length > 0) {
                        showResult('voice-integration-result', `üìä Found ${voiceData.searchResults.length} search results`, 'info');
                    }

                    // Test function call output format
                    const functionOutput = JSON.stringify({
                        success: voiceData.success,
                        query: voiceQuery,
                        response: voiceData.response,
                        searchResults: voiceData.searchResults,
                        citations: voiceData.citations
                    });

                    log(`üìã Function output size: ${functionOutput.length} bytes`);
                    
                    if (functionOutput.length < 50000) { // Reasonable size limit
                        showResult('voice-integration-result', `‚úÖ Function output is reasonable size`, 'success');
                    } else {
                        showResult('voice-integration-result', `‚ö†Ô∏è Function output may be too large`, 'error');
                    }

                } else {
                    throw new Error(`Voice search failed: ${voiceData.error}`);
                }

            } catch (error) {
                log(`‚ùå Voice integration test error: ${error.message}`);
                showResult('voice-integration-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testCitationExtraction() {
            log('üìö Starting Citation Extraction Test');
            const container = document.getElementById('citation-result');
            container.innerHTML = '';

            try {
                // Test with a query that should return citations
                const query = 'Latest research on neural networks';
                log(`üîç Testing citation extraction with: "${query}"`);

                const response = await fetch('/api/voice-agent/responses-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(`Search failed: ${data.error}`);
                }

                log(`üìä Response received with ${data.citations?.length || 0} citations`);

                if (data.citations && data.citations.length > 0) {
                    showResult('citation-result', `‚úÖ Citations extracted successfully (${data.citations.length} citations)`, 'success');

                    // Validate citation format
                    const citation = data.citations[0];
                    const requiredFields = ['type', 'url', 'title'];
                    const hasAllFields = requiredFields.every(field => citation[field]);

                    if (hasAllFields) {
                        showResult('citation-result', `‚úÖ Citation format is valid`, 'success');
                        showResult('citation-result', `üîó Example citation: ${citation.title}`, 'info');
                    } else {
                        showResult('citation-result', `‚ö†Ô∏è Citation missing required fields`, 'error');
                    }

                    // Test URL validity
                    try {
                        new URL(citation.url);
                        showResult('citation-result', `‚úÖ Citation URLs are valid`, 'success');
                    } catch {
                        showResult('citation-result', `‚ùå Invalid citation URL: ${citation.url}`, 'error');
                    }

                } else {
                    showResult('citation-result', `‚ö†Ô∏è No citations found (may be expected for some queries)`, 'info');
                }

                // Test search results correlation
                if (data.searchResults && data.searchResults.length > 0) {
                    showResult('citation-result', `üìÑ Search results: ${data.searchResults.length} items`, 'info');
                    
                    // Check if search results have proper structure
                    const result = data.searchResults[0];
                    const resultFields = ['title', 'url', 'snippet', 'source'];
                    const hasResultFields = resultFields.every(field => result[field]);

                    if (hasResultFields) {
                        showResult('citation-result', `‚úÖ Search results have proper structure`, 'success');
                    } else {
                        showResult('citation-result', `‚ùå Search results missing required fields`, 'error');
                    }
                }

            } catch (error) {
                log(`‚ùå Citation extraction test error: ${error.message}`);
                showResult('citation-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Voice Search Integration Test initialized');
            log('üìç Test environment: ' + window.location.origin);
        });
    </script>
</body>
</html>