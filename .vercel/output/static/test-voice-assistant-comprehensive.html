<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant Comprehensive Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .test-section h2 {
            color: #1e40af;
            margin-bottom: 16px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-section h2::before {
            content: 'üß™';
            font-size: 1.2rem;
        }

        .test-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 6px;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .test-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .test-button:active {
            transform: translateY(0);
        }

        .test-button.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .test-button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .test-button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .status-panel {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            border-left: 4px solid #3b82f6;
        }

        .status-panel.success {
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .status-panel.error {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .status-panel.warning {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .results-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }

        .result-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .result-item.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .result-item.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .result-item.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .result-item.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fed7aa;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
        }

        .metric-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .controls-panel {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 500;
            color: #374151;
        }

        .control-group input,
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
            width: 0%;
        }

        .keyboard-hint {
            background: #1f2937;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            margin: 16px 0;
        }

        .performance-chart {
            height: 200px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin: 16px 0;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #0f172a;
                color: #e2e8f0;
            }

            .test-section,
            .header,
            .controls-panel,
            .metric-card {
                background: #1e293b;
                border-color: #334155;
            }

            .status-panel {
                background: #334155;
            }

            .results-container {
                background: #1e293b;
                border-color: #334155;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>üé§ Voice Assistant Test Suite</h1>
            <p>Comprehensive testing environment for all voice agent features</p>
        </div>

        <!-- Test Controls -->
        <div class="controls-panel">
            <h3>Test Configuration</h3>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="test-theme">Theme</label>
                    <select id="test-theme">
                        <option value="auto">Auto</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="test-position">Position</label>
                    <select id="test-position">
                        <option value="bottom-right">Bottom Right</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="top-right">Top Right</option>
                        <option value="top-left">Top Left</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="auto-minimize">Auto Minimize</label>
                    <select id="auto-minimize">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="test-speed">Test Speed</label>
                    <select id="test-speed">
                        <option value="normal">Normal</option>
                        <option value="fast">Fast</option>
                        <option value="slow">Slow</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Metrics Dashboard -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="tests-passed">0</div>
                <div class="metric-label">Tests Passed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="tests-failed">0</div>
                <div class="metric-label">Tests Failed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="coverage-percent">0%</div>
                <div class="metric-label">Coverage</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avg-response-time">0ms</div>
                <div class="metric-label">Avg Response</div>
            </div>
        </div>

        <!-- Test Sections -->
        <div class="test-grid">
            <!-- Push-to-Talk Tests -->
            <div class="test-section">
                <h2>Push-to-Talk Functionality</h2>
                <button class="test-button" onclick="testMicrophoneButton()">Test Mic Button</button>
                <button class="test-button" onclick="testSpacebarToggle()">Test Spacebar</button>
                <button class="test-button" onclick="testVisualStates()">Test Visual States</button>
                <button class="test-button" onclick="testKeyboardShortcuts()">Test Shortcuts</button>
                <div class="results-container" id="ptt-results"></div>
            </div>

            <!-- Transcript Display Tests -->
            <div class="test-section">
                <h2>Transcript Display</h2>
                <button class="test-button" onclick="testUserMessages()">Test User Messages</button>
                <button class="test-button" onclick="testAIMessages()">Test AI Messages</button>
                <button class="test-button" onclick="testMessageFormatting()">Test Formatting</button>
                <button class="test-button" onclick="testScrollBehavior()">Test Scrolling</button>
                <div class="results-container" id="transcript-results"></div>
            </div>

            <!-- Voice Activity Tests -->
            <div class="test-section">
                <h2>Voice Activity Visualization</h2>
                <button class="test-button" onclick="testAudioLevels()">Test Audio Levels</button>
                <button class="test-button" onclick="testWaveformAnimation()">Test Waveform</button>
                <button class="test-button" onclick="testVoiceDetection()">Test Voice Detection</button>
                <button class="test-button" onclick="testVisualizationPerf()">Test Performance</button>
                <div class="results-container" id="voice-activity-results"></div>
            </div>

            <!-- Text Input Tests -->
            <div class="test-section">
                <h2>Text Input Functionality</h2>
                <button class="test-button" onclick="testTypingInput()">Test Typing</button>
                <button class="test-button" onclick="testEnterKey()">Test Enter Key</button>
                <button class="test-button" onclick="testConnectionStates()">Test Connection</button>
                <button class="test-button" onclick="testInputValidation()">Test Validation</button>
                <div class="results-container" id="text-input-results"></div>
            </div>

            <!-- UI/UX Tests -->
            <div class="test-section">
                <h2>Modern UI/UX</h2>
                <button class="test-button" onclick="testAnimations()">Test Animations</button>
                <button class="test-button" onclick="testResponsiveDesign()">Test Responsive</button>
                <button class="test-button" onclick="testDarkMode()">Test Dark Mode</button>
                <button class="test-button" onclick="testAccessibility()">Test A11y</button>
                <div class="results-container" id="uiux-results"></div>
            </div>

            <!-- Error Handling Tests -->
            <div class="test-section">
                <h2>Error Handling</h2>
                <button class="test-button danger" onclick="testMicPermissionError()">Test Mic Error</button>
                <button class="test-button danger" onclick="testConnectionError()">Test Connection</button>
                <button class="test-button danger" onclick="testRecoveryMechanisms()">Test Recovery</button>
                <button class="test-button" onclick="testErrorMessages()">Test Messages</button>
                <div class="results-container" id="error-results"></div>
            </div>

            <!-- Settings Tests -->
            <div class="test-section">
                <h2>Settings & Features</h2>
                <button class="test-button" onclick="testMuteToggle()">Test Mute</button>
                <button class="test-button" onclick="testVoiceActivation()">Test Activation</button>
                <button class="test-button" onclick="testSettingsPersistence()">Test Persistence</button>
                <button class="test-button" onclick="testCustomization()">Test Customization</button>
                <div class="results-container" id="settings-results"></div>
            </div>

            <!-- Performance Tests -->
            <div class="test-section">
                <h2>Performance & Analytics</h2>
                <button class="test-button" onclick="testLoadingTime()">Test Loading</button>
                <button class="test-button" onclick="testMemoryUsage()">Test Memory</button>
                <button class="test-button" onclick="testEventTracking()">Test Analytics</button>
                <button class="test-button" onclick="runBenchmarks()">Run Benchmarks</button>
                <div class="results-container" id="performance-results"></div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="status-panel">
            <h3>Quick Actions</h3>
            <button class="test-button success" onclick="runAllTests()">üöÄ Run All Tests</button>
            <button class="test-button secondary" onclick="clearResults()">üßπ Clear Results</button>
            <button class="test-button" onclick="exportResults()">üìä Export Results</button>
            <button class="test-button" onclick="resetVoiceAgent()">üîÑ Reset Agent</button>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="test-progress"></div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="keyboard-hint">
            <strong>Keyboard Shortcuts:</strong>
            Space = Toggle Voice | Escape = Close Panel | Tab = Navigate | R = Run Tests | C = Clear
        </div>

        <!-- Performance Chart -->
        <div class="performance-chart" id="performance-chart">
            <canvas id="perf-canvas" width="100%" height="200"></canvas>
        </div>
    </div>

    <!-- Voice Assistant Widget -->
    <div id="voice-assistant-widget" class="voice-assistant-widget bottom-right" 
         data-theme="auto" data-auto-minimize="true">
        <div id="voice-fab" class="voice-fab">
            <button class="voice-fab-button" aria-label="Open voice assistant">
                üé§
            </button>
        </div>
        <div id="voice-widget-panel" class="voice-widget-panel hidden">
            <div class="voice-header">
                <div class="voice-status-indicator"></div>
                <div id="voice-status-text">Ready to talk</div>
                <button id="voice-minimize-btn" aria-label="Minimize panel">√ó</button>
            </div>
            <div class="voice-controls">
                <button id="voice-main-btn" class="voice-main-button" aria-label="Start/stop listening">
                    <div class="voice-pulse-ring"></div>
                    üé§
                </button>
                <button id="voice-mute-btn" aria-label="Toggle mute">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.794L4.168 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.168l4.215-3.794z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <button id="voice-activation-toggle" aria-label="Toggle voice activation">üîÑ</button>
            </div>
            <canvas id="voice-waveform-canvas" width="200" height="60" aria-label="Audio visualization"></canvas>
            <div class="voice-transcript-container" aria-live="polite" aria-label="Conversation transcript"></div>
            <button id="voice-cta-btn" class="voice-cta-button">üìÖ Schedule Call</button>
            <div id="voice-keyboard-hint" class="voice-keyboard-hint">Press Space to talk</div>
        </div>
    </div>

    <script type="module">
        // Import voice assistant core
        import VoiceAssistantCore from './src/components/voice-agent/voice-assistant-core.js';
        
        // Global test variables
        let testMetrics = {
            passed: 0,
            failed: 0,
            total: 0,
            coverage: 0,
            responseTime: []
        };

        let testStartTime = 0;
        let voiceAssistant = null;

        // Initialize voice assistant
        async function initializeVoiceAssistant() {
            try {
                voiceAssistant = new VoiceAssistantCore();
                await voiceAssistant.initialize();
                window.VoiceAssistantCore = voiceAssistant;
                logResult('initialization', 'Voice assistant initialized successfully', 'success');
            } catch (error) {
                logResult('initialization', `Initialization failed: ${error.message}`, 'error');
            }
        }

        // Test utility functions
        function logResult(category, message, type = 'info') {
            const container = document.getElementById(`${category}-results`) || 
                            document.getElementById('performance-results');
            
            if (container) {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${type}`;
                resultItem.innerHTML = `
                    <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                    <small>${new Date().toLocaleTimeString()}</small>
                `;
                container.appendChild(resultItem);
                container.scrollTop = container.scrollHeight;
            }

            // Update metrics
            if (type === 'success') testMetrics.passed++;
            if (type === 'error') testMetrics.failed++;
            testMetrics.total++;
            
            updateMetrics();
        }

        function updateMetrics() {
            document.getElementById('tests-passed').textContent = testMetrics.passed;
            document.getElementById('tests-failed').textContent = testMetrics.failed;
            document.getElementById('coverage-percent').textContent = 
                Math.round((testMetrics.passed / testMetrics.total) * 100) + '%';
            
            if (testMetrics.responseTime.length > 0) {
                const avg = testMetrics.responseTime.reduce((a, b) => a + b, 0) / testMetrics.responseTime.length;
                document.getElementById('avg-response-time').textContent = Math.round(avg) + 'ms';
            }

            // Update progress bar
            const progress = (testMetrics.passed + testMetrics.failed) / Math.max(testMetrics.total, 1) * 100;
            document.getElementById('test-progress').style.width = progress + '%';
        }

        async function measureTest(testFn, category, description) {
            const start = performance.now();
            try {
                await testFn();
                const duration = performance.now() - start;
                testMetrics.responseTime.push(duration);
                logResult(category, `${description} (${Math.round(duration)}ms)`, 'success');
            } catch (error) {
                const duration = performance.now() - start;
                logResult(category, `${description} failed: ${error.message} (${Math.round(duration)}ms)`, 'error');
            }
        }

        // Push-to-Talk Tests
        window.testMicrophoneButton = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const initialState = voiceAssistant.state.isListening;
                const mainBtn = document.getElementById('voice-main-btn');
                
                // Simulate click
                mainBtn.click();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (voiceAssistant.state.isListening === initialState) {
                    throw new Error('Button click did not change listening state');
                }
            }, 'ptt', 'Microphone button click test');
        };

        window.testSpacebarToggle = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const initialExpanded = voiceAssistant.state.isExpanded;
                
                // Simulate spacebar press
                const spaceEvent = new KeyboardEvent('keydown', {
                    code: 'Space',
                    bubbles: true
                });
                document.body.dispatchEvent(spaceEvent);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (voiceAssistant.state.isExpanded === initialExpanded) {
                    throw new Error('Spacebar did not toggle panel state');
                }
            }, 'ptt', 'Spacebar toggle test');
        };

        window.testVisualStates = async () => {
            await measureTest(async () => {
                const mainBtn = document.getElementById('voice-main-btn');
                const statusIndicator = document.querySelector('.voice-status-indicator');
                
                if (!mainBtn || !statusIndicator) {
                    throw new Error('Required UI elements not found');
                }
                
                // Test that elements exist and have proper classes
                if (!mainBtn.classList.length) {
                    throw new Error('Main button missing state classes');
                }
            }, 'ptt', 'Visual states test');
        };

        window.testKeyboardShortcuts = async () => {
            await measureTest(async () => {
                // Test Escape key
                const escapeEvent = new KeyboardEvent('keydown', {
                    code: 'Escape',
                    bubbles: true
                });
                
                if (voiceAssistant && voiceAssistant.state.isExpanded) {
                    document.dispatchEvent(escapeEvent);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    if (voiceAssistant.state.isExpanded) {
                        throw new Error('Escape key did not close panel');
                    }
                }
            }, 'ptt', 'Keyboard shortcuts test');
        };

        // Transcript Display Tests
        window.testUserMessages = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const testMessage = {
                    role: 'user',
                    content: 'Test user message for display verification',
                    timestamp: new Date().toISOString()
                };
                
                voiceAssistant.handleMessageReceived(testMessage);
                
                const userMessages = document.querySelectorAll('.user-message');
                if (userMessages.length === 0) {
                    throw new Error('User message not displayed in transcript');
                }
            }, 'transcript', 'User message display test');
        };

        window.testAIMessages = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const testMessage = {
                    role: 'assistant',
                    content: 'Test AI response message',
                    timestamp: new Date().toISOString()
                };
                
                voiceAssistant.handleMessageReceived(testMessage);
                
                const aiMessages = document.querySelectorAll('.assistant-message');
                if (aiMessages.length === 0) {
                    throw new Error('AI message not displayed in transcript');
                }
            }, 'transcript', 'AI message display test');
        };

        window.testMessageFormatting = async () => {
            await measureTest(async () => {
                const transcriptContainer = document.querySelector('.voice-transcript-container');
                if (!transcriptContainer) {
                    throw new Error('Transcript container not found');
                }
                
                // Check if messages have proper formatting elements
                const messages = transcriptContainer.querySelectorAll('.voice-message');
                messages.forEach(message => {
                    const timestamp = message.querySelector('.text-xs');
                    if (!timestamp) {
                        throw new Error('Message missing timestamp formatting');
                    }
                });
            }, 'transcript', 'Message formatting test');
        };

        window.testScrollBehavior = async () => {
            await measureTest(async () => {
                const transcriptContainer = document.querySelector('.voice-transcript-container');
                if (!transcriptContainer) {
                    throw new Error('Transcript container not found');
                }
                
                // Add multiple messages to test scrolling
                for (let i = 0; i < 5; i++) {
                    voiceAssistant.handleMessageReceived({
                        role: i % 2 === 0 ? 'user' : 'assistant',
                        content: `Test message ${i} for scroll behavior`,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Should auto-scroll to bottom
                if (transcriptContainer.scrollTop < transcriptContainer.scrollHeight - transcriptContainer.clientHeight - 10) {
                    throw new Error('Transcript did not auto-scroll to bottom');
                }
            }, 'transcript', 'Scroll behavior test');
        };

        // Voice Activity Tests
        window.testAudioLevels = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const canvas = document.getElementById('voice-waveform-canvas');
                if (!canvas) throw new Error('Waveform canvas not found');
                
                const ctx = canvas.getContext('2d');
                const originalStroke = ctx.stroke;
                let strokeCalled = false;
                
                ctx.stroke = () => {
                    strokeCalled = true;
                    originalStroke.call(ctx);
                };
                
                // Simulate audio level update
                voiceAssistant.updateAudioVisualization(0.8);
                
                if (!strokeCalled) {
                    throw new Error('Canvas stroke not called during visualization update');
                }
            }, 'voice-activity', 'Audio levels test');
        };

        window.testWaveformAnimation = async () => {
            await measureTest(async () => {
                const canvas = document.getElementById('voice-waveform-canvas');
                if (!canvas) throw new Error('Waveform canvas not found');
                
                // Test canvas dimensions
                if (canvas.width !== 200 || canvas.height !== 60) {
                    throw new Error('Canvas dimensions incorrect');
                }
                
                // Test multiple audio levels
                for (let level of [0.1, 0.5, 0.9]) {
                    voiceAssistant.updateAudioVisualization(level);
                }
            }, 'voice-activity', 'Waveform animation test');
        };

        window.testVoiceDetection = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const statusIndicator = document.querySelector('.voice-status-indicator');
                if (!statusIndicator) throw new Error('Status indicator not found');
                
                // Test voice activity detection
                voiceAssistant.handleVoiceActivity(true);
                if (!statusIndicator.classList.contains('listening')) {
                    throw new Error('Status indicator not updated for voice activity');
                }
                
                voiceAssistant.handleVoiceActivity(false);
                if (statusIndicator.classList.contains('listening')) {
                    throw new Error('Status indicator not cleared after voice activity stopped');
                }
            }, 'voice-activity', 'Voice detection test');
        };

        window.testVisualizationPerf = async () => {
            await measureTest(async () => {
                const start = performance.now();
                
                // Run multiple visualization updates
                for (let i = 0; i < 100; i++) {
                    voiceAssistant.updateAudioVisualization(Math.random());
                }
                
                const duration = performance.now() - start;
                
                if (duration > 100) { // 100ms for 100 updates should be reasonable
                    throw new Error(`Visualization performance too slow: ${duration}ms for 100 updates`);
                }
            }, 'voice-activity', 'Visualization performance test');
        };

        // Error Handling Tests
        window.testMicPermissionError = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const error = {
                    type: 'microphone_permission_denied',
                    message: 'Permission denied for microphone',
                    recoverable: true
                };
                
                voiceAssistant.handleError(error);
                
                if (!voiceAssistant.state.errorState) {
                    throw new Error('Error state not set');
                }
                
                const statusText = document.getElementById('voice-status-text');
                if (!statusText.textContent.includes('Microphone access denied')) {
                    throw new Error('Error message not displayed correctly');
                }
            }, 'error', 'Microphone permission error test');
        };

        window.testConnectionError = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const error = {
                    type: 'connection_failed',
                    message: 'Network connection failed',
                    recoverable: true
                };
                
                voiceAssistant.handleError(error);
                
                // Should show error message with retry option
                const errorMessage = document.querySelector('.voice-error-message');
                if (!errorMessage) {
                    throw new Error('Error message container not created');
                }
            }, 'error', 'Connection error test');
        };

        // Settings Tests
        window.testMuteToggle = async () => {
            await measureTest(async () => {
                if (!voiceAssistant) throw new Error('Voice assistant not initialized');
                
                const initialMuted = voiceAssistant.state.isMuted;
                voiceAssistant.toggleMute();
                
                if (voiceAssistant.state.isMuted === initialMuted) {
                    throw new Error('Mute state not toggled');
                }
                
                // Toggle back
                voiceAssistant.toggleMute();
                if (voiceAssistant.state.isMuted !== initialMuted) {
                    throw new Error('Mute state not restored');
                }
            }, 'settings', 'Mute toggle test');
        };

        // UI/UX Tests
        window.testAnimations = async () => {
            await measureTest(async () => {
                const panel = document.getElementById('voice-widget-panel');
                if (!panel) throw new Error('Voice panel not found');
                
                // Test panel visibility animation
                voiceAssistant.expandPanel();
                if (!panel.classList.contains('visible')) {
                    throw new Error('Panel not marked as visible after expand');
                }
                
                voiceAssistant.minimizePanel();
                if (!panel.classList.contains('hidden')) {
                    throw new Error('Panel not marked as hidden after minimize');
                }
            }, 'uiux', 'Animations test');
        };

        window.testDarkMode = async () => {
            await measureTest(async () => {
                const container = document.getElementById('voice-assistant-widget');
                const theme = container.dataset.theme;
                
                if (!['auto', 'light', 'dark'].includes(theme)) {
                    throw new Error('Invalid theme configuration');
                }
            }, 'uiux', 'Dark mode support test');
        };

        window.testAccessibility = async () => {
            await measureTest(async () => {
                // Check for ARIA attributes
                const announceRegion = voiceAssistant.announceRegion;
                if (!announceRegion) {
                    throw new Error('Screen reader announcement region not found');
                }
                
                if (announceRegion.getAttribute('aria-live') !== 'polite') {
                    throw new Error('Announcement region missing proper ARIA attributes');
                }
                
                // Test announcement
                voiceAssistant.announce('Test accessibility announcement');
                if (announceRegion.textContent !== 'Test accessibility announcement') {
                    throw new Error('Announcement not properly set');
                }
            }, 'uiux', 'Accessibility test');
        };

        // Global test functions
        window.runAllTests = async () => {
            const testFunctions = [
                'testMicrophoneButton', 'testSpacebarToggle', 'testVisualStates', 'testKeyboardShortcuts',
                'testUserMessages', 'testAIMessages', 'testMessageFormatting', 'testScrollBehavior',
                'testAudioLevels', 'testWaveformAnimation', 'testVoiceDetection',
                'testMicPermissionError', 'testConnectionError',
                'testMuteToggle', 'testAnimations', 'testDarkMode', 'testAccessibility'
            ];
            
            logResult('performance', 'Starting comprehensive test suite...', 'info');
            
            for (const testFn of testFunctions) {
                try {
                    await window[testFn]();
                    await new Promise(resolve => setTimeout(resolve, 100)); // Brief pause between tests
                } catch (error) {
                    logResult('performance', `Test ${testFn} failed: ${error.message}`, 'error');
                }
            }
            
            logResult('performance', 'All tests completed!', 'success');
        };

        window.clearResults = () => {
            const resultContainers = document.querySelectorAll('.results-container');
            resultContainers.forEach(container => {
                container.innerHTML = '';
            });
            
            testMetrics = { passed: 0, failed: 0, total: 0, coverage: 0, responseTime: [] };
            updateMetrics();
        };

        window.resetVoiceAgent = async () => {
            if (voiceAssistant) {
                await voiceAssistant.cleanup();
            }
            await initializeVoiceAssistant();
            logResult('performance', 'Voice agent reset successfully', 'success');
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            switch (e.key.toLowerCase()) {
                case 'r':
                    e.preventDefault();
                    runAllTests();
                    break;
                case 'c':
                    e.preventDefault();
                    clearResults();
                    break;
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeVoiceAssistant();
            logResult('performance', 'Test suite initialized', 'success');
        });

        // Configuration changes
        document.getElementById('test-theme').addEventListener('change', (e) => {
            const widget = document.getElementById('voice-assistant-widget');
            widget.dataset.theme = e.target.value;
            logResult('settings', `Theme changed to ${e.target.value}`, 'info');
        });

        document.getElementById('test-position').addEventListener('change', (e) => {
            const widget = document.getElementById('voice-assistant-widget');
            widget.className = `voice-assistant-widget ${e.target.value}`;
            logResult('settings', `Position changed to ${e.target.value}`, 'info');
        });

        document.getElementById('auto-minimize').addEventListener('change', (e) => {
            const widget = document.getElementById('voice-assistant-widget');
            widget.dataset.autoMinimize = e.target.value;
            logResult('settings', `Auto-minimize ${e.target.value === 'true' ? 'enabled' : 'disabled'}`, 'info');
        });

        // Expose functions globally for testing
        window.testFunctions = {
            testMicrophoneButton,
            testSpacebarToggle,
            testVisualStates,
            testKeyboardShortcuts,
            testUserMessages,
            testAIMessages,
            testMessageFormatting,
            testScrollBehavior,
            testAudioLevels,
            testWaveformAnimation,
            testVoiceDetection,
            testMicPermissionError,
            testConnectionError,
            testMuteToggle,
            testAnimations,
            testDarkMode,
            testAccessibility
        };
    </script>

    <!-- Load voice assistant styles -->
    <link rel="stylesheet" href="./src/components/voice-agent/voice-assistant.css">
</body>
</html>