import{a as e}from"./index.CjGNLnnL.js";function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n,s,r,o={exports:{}},i={},a=(s||(s=1,o.exports=function(){if(n)return i;n=1;var e=Symbol.for("react.transitional.element"),t=Symbol.for("react.fragment");function s(t,n,s){var o=null;if(void 0!==s&&(o=""+s),void 0!==n.key&&(o=""+n.key),"key"in n)for(var i in s={},n)"key"!==i&&(s[i]=n[i]);else s=n;return n=s.ref,{$$typeof:e,type:t,key:o,ref:void 0!==n?n:null,props:s}}return i.Fragment=t,i.jsx=s,i.jsxs=s,i}()),o.exports),c={exports:{}},l=(r||(r=1,function(e){var t=Object.prototype.hasOwnProperty,n="~";function s(){}function o(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(e,t,s,i,a){if("function"!=typeof s)throw new TypeError("The listener must be a function");var r=new o(s,i||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],r]:e._events[c].push(r):(e._events[c]=r,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function r(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(n=!1)),r.prototype.eventNames=function(){var e,s,o=[];if(0===this._eventsCount)return o;for(s in e=this._events)t.call(e,s)&&o.push(n?s.slice(1):s);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},r.prototype.listeners=function(e){var t=n?n+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var o=0,i=s.length,a=new Array(i);o<i;o++)a[o]=s[o].fn;return a},r.prototype.listenerCount=function(e){var t=n?n+e:e,s=this._events[t];return s?s.fn?1:s.length:0},r.prototype.emit=function(e,t,s,o,i,a){var r=n?n+e:e;if(!this._events[r])return!1;var c,l,d=this._events[r],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,s),!0;case 4:return d.fn.call(d.context,t,s,o),!0;case 5:return d.fn.call(d.context,t,s,o,i),!0;case 6:return d.fn.call(d.context,t,s,o,i,a),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var h,g=d.length;for(l=0;l<g;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,s);break;case 4:d[l].fn.call(d[l].context,t,s,o);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];d[l].fn.apply(d[l].context,c)}}return!0},r.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},r.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},r.prototype.removeListener=function(e,t,s,o){var i=n?n+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var r=this._events[i];if(r.fn)r.fn!==t||o&&!r.once||s&&r.context!==s||a(this,i);else{for(var c=0,l=[],d=r.length;c<d;c++)(r[c].fn!==t||o&&!r[c].once||s&&r[c].context!==s)&&l.push(r[c]);l.length?this._events[i]=1===l.length?l[0]:l:a(this,i)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new s,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=n,r.EventEmitter=r,e.exports=r}(c)),c.exports);const d=t(l);class u{constructor(e=3,t=1e3){this.maxReconnects=e,this.baseReconnectDelay=t,this.maxReconnectAttempts=e,this.reconnectDelay=t}_peerConnection=null;_dataChannel=null;connectionState="disconnected";currentToken=null;reconnectAttempts=0;maxReconnectAttempts;reconnectDelay;eventListeners=new Map;sessionConfig=null;remoteAudioStream=null;isConnecting=!1;setSessionConfig(e){this.sessionConfig=e}async connect(e,t,n){if(this.isConnecting)console.log("[WebRTC Connection] Connection already in progress, skipping duplicate attempt");else{this._peerConnection&&(console.log("[WebRTC Connection] Cleaning up existing connection before new attempt"),await this.disconnect()),this.isConnecting=!0;try{if(this.currentToken=e,n&&(this.sessionConfig=n),this.updateConnectionState("connecting"),this._peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}],iceCandidatePoolSize:10,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),this.setupPeerConnectionHandlers(),this._dataChannel=this._peerConnection.createDataChannel("oai-events",{ordered:!0}),this.setupDataChannelHandlers(),t&&t.getAudioTracks().length>0){const e=t.getAudioTracks()[0],n=this._peerConnection.addTrack(e,t);console.log("Added local audio track to peer connection:",{trackId:e.id,trackState:e.readyState,trackMuted:e.muted,senderActive:n.track?.enabled})}const s=this._peerConnection.getTransceivers();console.log("Current transceivers:",s.length),s.some((e=>"audio"===e.receiver.track?.kind))||(this._peerConnection.addTransceiver("audio",{direction:"sendrecv"}),console.log("Added audio transceiver with direction: sendrecv"));const o=await this._peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1});await this._peerConnection.setLocalDescription(o),console.log("SDP Offer created:",{hasAudio:o.sdp?.includes("m=audio"),audioCodecs:o.sdp?.match(/a=rtpmap:\d+ ([\w-]+)\//g)?.map((e=>e.split(" ")[1].split("/")[0])),hasDataChannel:o.sdp?.includes("application/webrtc-datachannel")}),await this.connectToOpenAI(o,e)}catch(e){await this.handleConnectionError(e)}finally{this.isConnecting=!1}}}async connectToOpenAI(e,t){try{console.log("Connecting to OpenAI Realtime WebRTC...");const n="https://api.openai.com/v1/realtime",s="gpt-4o-realtime-preview-2024-12-17",o=await fetch(`${n}?model=${s}`,{method:"POST",body:e.sdp,headers:{Authorization:`Bearer ${t.token}`,"Content-Type":"application/sdp"}});if(!o.ok){const e=await o.text();throw console.error("SDP exchange failed:",o.status,e),new Error(`WebRTC setup failed: ${o.status} - ${e}`)}const i=await o.text();console.log("Received SDP answer from OpenAI");const a={type:"answer",sdp:i};await this._peerConnection.setRemoteDescription(a),console.log("Remote description set successfully"),console.log("SDP Answer received:",{hasAudio:a.sdp?.includes("m=audio"),audioDirection:a.sdp?.match(/a=sendrecv|a=sendonly|a=recvonly|a=inactive/g),audioCodecs:a.sdp?.match(/a=rtpmap:\d+ ([\w-]+)\//g)?.map((e=>e.split(" ")[1].split("/")[0]))}),this._peerConnection.getTransceivers().forEach(((e,t)=>{console.log(`Transceiver ${t}:`,{mid:e.mid,direction:e.direction,currentDirection:e.currentDirection,receiverTrackKind:e.receiver.track?.kind,receiverTrackState:e.receiver.track?.readyState})})),console.log("[WebRTC Connection] SDP exchange complete, waiting for peer connection establishment..."),this.resetReconnectAttempts()}catch(e){throw console.error("OpenAI WebRTC connection failed:",e),e}}setupPeerConnectionHandlers(){this._peerConnection&&(this._peerConnection.onconnectionstatechange=()=>{const e=this._peerConnection?.connectionState;switch(console.log("[WebRTC Connection] Peer connection state changed to:",e),e){case"connected":console.log("[WebRTC Connection] Successfully connected - emitting connected event"),this.updateConnectionState("connected"),this.emit("connected");break;case"disconnected":console.log("[WebRTC Connection] Disconnected - emitting disconnected event"),this.updateConnectionState("disconnected"),this.emit("disconnected"),this.attemptReconnection();break;case"failed":console.log("[WebRTC Connection] Connection failed - emitting failed event"),this.updateConnectionState("failed"),this.emit("failed"),this.attemptReconnection();break;case"closed":console.log("[WebRTC Connection] Connection closed - emitting closed event"),this.updateConnectionState("disconnected"),this.emit("closed");break;default:console.log("[WebRTC Connection] Unhandled connection state:",e)}},this._peerConnection.oniceconnectionstatechange=()=>{const e=this._peerConnection?.iceConnectionState;console.log("ICE connection state:",e)},this._peerConnection.ondatachannel=e=>{const t=e.channel;this.setupDataChannelHandlers(t)},this._peerConnection.ontrack=e=>{console.log("[WebRTC Connection] Received remote track event:",{trackKind:e.track.kind,trackId:e.track.id,streamCount:e.streams.length,trackState:e.track.readyState}),"audio"===e.track.kind&&e.streams[0]&&(console.log("[WebRTC Connection] Emitting audio track for playback"),this.remoteAudioStream=e.streams[0],this.emit("audioTrack",e.streams[0]))})}getRemoteAudioStream(){return this.remoteAudioStream}getRemoteTracks(){const e=[];return this._peerConnection&&this._peerConnection.getReceivers().forEach((t=>{t.track&&"audio"===t.track.kind&&e.push(t.track)})),e}setupDataChannelHandlers(e){const t=e||this._dataChannel;t&&(t.onopen=()=>{console.log("Data channel opened - ready to send/receive Realtime API events"),this.emit("dataChannelOpen"),this.sessionConfig||(console.error("[WebRTCConnection] No session config provided - this should not happen"),this.sessionConfig={modalities:["text","audio"],instructions:"You are a helpful AI assistant.",voice:"shimmer",input_audio_format:"pcm16",output_audio_format:"pcm16",input_audio_transcription:{model:"whisper-1"},turn_detection:{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:600},tools:[],tool_choice:"auto",temperature:.8,max_response_output_tokens:"inf"});const e={type:"session.update",session:this.sessionConfig};console.log("[WebRTCConnection] Sending session update with instructions:",{instructionsLength:this.sessionConfig.instructions?.length,instructionsPreview:this.sessionConfig.instructions?.substring(0,200)+"...",voice:this.sessionConfig.voice,tools:this.sessionConfig.tools?.map((e=>e.name))}),t.send(JSON.stringify(e)),console.log("[WebRTCConnection] Session configuration sent successfully")},t.onmessage=e=>{try{const t=JSON.parse(e.data);this.emit("realtimeEvent",t)}catch(e){console.error("Failed to parse realtime event:",e)}},t.onerror=e=>{console.error("Data channel error:",e),this.emit("dataChannelError",e)},t.onclose=()=>{console.log("Data channel closed"),this.emit("dataChannelClose")})}sendEvent(e){if(this._dataChannel&&"open"===this._dataChannel.readyState)try{this._dataChannel.send(JSON.stringify(e)),console.log("Sent event:",e.type)}catch(e){console.error("Failed to send event via data channel:",e)}else console.warn("Data channel not ready, event not sent:",e)}async attemptReconnection(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return this.updateConnectionState("failed"),void this.emit("maxReconnectAttemptsReached");this.reconnectAttempts++,this.updateConnectionState("reconnecting");const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout((async()=>{this.currentToken&&this.isTokenValid(this.currentToken)?await this.connect(this.currentToken):this.emit("tokenExpired")}),e)}isTokenValid(e){return Date.now()<e.expiresAt-3e4}resetReconnectAttempts(){this.reconnectAttempts=0}updateConnectionState(e){const t=this.connectionState;this.connectionState=e,t!==e&&this.emit("stateChange",{previous:t,current:e,timestamp:Date.now()})}async handleConnectionError(e){console.error("WebRTC connection error:",e);let t="connection_failed";"NotAllowedError"===e.name?t="microphone_permission_denied":e.message?.includes("token")?t="token_expired":e.message?.includes("network")&&(t="network_error");const n={type:t,message:e.message||"Unknown connection error",timestamp:Date.now(),details:e,recoverable:"microphone_permission_denied"!==t};this.updateConnectionState("failed"),this.emit("error",n),n.recoverable&&await this.attemptReconnection()}getConnectionInfo(){return{state:this.connectionState,sessionId:this.currentToken?.sessionId,connectedAt:"connected"===this.connectionState?Date.now():void 0,reconnectAttempt:this.reconnectAttempts}}async disconnect(){try{this.isConnecting=!1,this.remoteAudioStream=null;const e=this.webSocket;e&&e.readyState===WebSocket.OPEN&&(e.close(),this.webSocket=null),this._dataChannel&&(this._dataChannel.close(),this._dataChannel=null),this._peerConnection&&(this._peerConnection.close(),this._peerConnection=null),this.updateConnectionState("disconnected"),this.currentToken=null,this.resetReconnectAttempts()}catch(e){console.error("Error during disconnect:",e)}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach((e=>e(t)))}get state(){return this.connectionState}get isConnected(){return"connected"===this.connectionState}get peerConnection(){return this._peerConnection}get dataChannel(){return this._dataChannel}}class h{isActive=!1;threshold=.01;silenceDuration=0;maxSilenceDuration=1e3;activityCallback;constructor(e=.01,t=1e3){this.threshold=e,this.maxSilenceDuration=t}setCallback(e){this.activityCallback=e}process(e,t){let n=0;for(let t=0;t<e.length;t++)n+=e[t]*e[t];const s=Math.sqrt(n/e.length),o=e.length/t*1e3;return s>this.threshold?this.isActive||(this.isActive=!0,this.silenceDuration=0,this.activityCallback?.(!0)):(this.silenceDuration+=o,this.isActive&&this.silenceDuration>this.maxSilenceDuration&&(this.isActive=!1,this.activityCallback?.(!1))),this.isActive}reset(){this.isActive=!1,this.silenceDuration=0}}class g{constructor(e=24e3,t=75,n=!0){this.sampleRate=e,this.targetLatency=t,this.adaptiveQuality=n,this.context=new AudioContext({sampleRate:this.sampleRate,latencyHint:"interactive"}),this.inputGain=this.context.createGain(),this.outputGain=this.context.createGain(),this.analyserNode=this.context.createAnalyser(),this.compressorNode=this.context.createDynamicsCompressor(),this.filterNode=this.context.createBiquadFilter(),this.setupAudioProcessing(),this.vadProcessor=new h(.01,500),this.vadProcessor.setCallback((e=>{this.emit("voiceActivity",e)})),this.bufferManager={inputBuffer:[],outputBuffer:[],bufferSize:128}}context;workletNode;inputGain;outputGain;isRecording=!1;isPlaying=!1;mediaStream;sourceNode;destinationNode;analyserNode;compressorNode;filterNode;vadProcessor;bufferManager;eventListeners=new Map;latencyMonitor={inputLatency:0,outputLatency:0,roundTripLatency:0};setupAudioProcessing(){this.compressorNode.threshold.value=-24,this.compressorNode.knee.value=30,this.compressorNode.ratio.value=12,this.compressorNode.attack.value=.003,this.compressorNode.release.value=.25,this.filterNode.type="highpass",this.filterNode.frequency.value=80,this.filterNode.Q.value=1,this.analyserNode.fftSize=256,this.analyserNode.smoothingTimeConstant=.8,this.inputGain.gain.value=1,this.outputGain.gain.value=.8}async initializeWorklet(){try{await this.context.audioWorklet.addModule("/audio-worklets/voice-processor.js"),this.workletNode=new AudioWorkletNode(this.context,"voice-processor",{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[1],processorOptions:{sampleRate:this.sampleRate,enableNoiseReduction:!0,enableEchoCancellation:!0}}),this.workletNode.port.onmessage=e=>{const{type:t,data:n}=e.data;switch(t){case"audioLevel":this.emit("audioLevel",n);break;case"noiseDetected":this.emit("noiseDetected",n);break;case"latencyUpdate":this.latencyMonitor={...this.latencyMonitor,...n},this.emit("latencyUpdate",this.latencyMonitor)}}}catch(e){console.warn("Audio worklet not available, using fallback processing"),this.emit("workletError",e)}}async initializeMicrophone(e){try{const t={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:this.sampleRate,channelCount:1,googEchoCancellation:!0,googAutoGainControl:!0,googNoiseSuppression:!0,googHighpassFilter:!0,googTypingNoiseDetection:!0,googAudioMirroring:!1},...e};if(this.mediaStream=await navigator.mediaDevices.getUserMedia(t),this.context&&"closed"!==this.context.state){if("suspended"===this.context.state)try{await this.context.resume(),console.log("[WebRTCAudioProcessor] Audio context resumed")}catch(e){console.warn("[WebRTCAudioProcessor] Failed to resume audio context:",e)}}else console.log("[WebRTCAudioProcessor] Context closed or missing, creating new context"),this.context=new AudioContext({sampleRate:this.sampleRate,latencyHint:"interactive"}),this.inputGain=this.context.createGain(),this.outputGain=this.context.createGain(),this.analyserNode=this.context.createAnalyser(),this.compressorNode=this.context.createDynamicsCompressor(),this.filterNode=this.context.createBiquadFilter(),this.setupAudioProcessing();return this.sourceNode=this.context.createMediaStreamSource(this.mediaStream),this.destinationNode=this.context.createMediaStreamDestination(),this.connectProcessingChain(),await this.initializeWorklet(),this.emit("microphoneInitialized",this.mediaStream),this.mediaStream}catch(e){throw this.handleAudioError(e),e}}connectProcessingChain(){if(!this.sourceNode||!this.destinationNode)return;let e=this.sourceNode;e.connect(this.inputGain),e=this.inputGain,e.connect(this.filterNode),e=this.filterNode,e.connect(this.compressorNode),e=this.compressorNode,this.workletNode&&(e.connect(this.workletNode),e=this.workletNode),e.connect(this.analyserNode),e.connect(this.outputGain),this.outputGain.connect(this.destinationNode)}startRecording(){this.isRecording||(this.isRecording=!0,this.vadProcessor.reset(),this.processAudioFrame(),this.emit("recordingStarted"))}stopRecording(){this.isRecording&&(this.isRecording=!1,this.vadProcessor.reset(),this.emit("recordingStopped"))}processAudioFrame(){if(!this.isRecording)return;const e=this.analyserNode.frequencyBinCount,t=new Float32Array(e);this.analyserNode.getFloatTimeDomainData(t),this.vadProcessor.process(t,this.sampleRate),this.monitorAudioQuality(t),requestAnimationFrame((()=>this.processAudioFrame()))}monitorAudioQuality(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n]*e[n];const n=Math.sqrt(t/e.length),s=20*Math.log10(n);let o=!1;for(let t=0;t<e.length;t++)if(Math.abs(e[t])>.95){o=!0;break}let i=1/0,a=-1/0;for(let t=0;t<e.length;t++)e[t]<i&&(i=e[t]),e[t]>a&&(a=e[t]);const r=a-i;this.emit("audioQuality",{level:n,decibels:isFinite(s)?s:-1/0,clipping:o,dynamicRange:r,timestamp:Date.now()})}convertToPCM16(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){const s=Math.max(-1,Math.min(1,e[n]));t[n]=32767*s}return t}async playAudio(e){try{"suspended"===this.context.state&&await this.context.resume(),this.isPlaying=!0;const t=new Float32Array(e.length);for(let n=0;n<e.length;n++)t[n]=e[n]/32767;const n=this.context.createBuffer(1,t.length,this.sampleRate);n.copyToChannel(t,0);const s=this.context.createBufferSource();s.buffer=n,s.connect(this.outputGain),this.outputGain.connect(this.context.destination),s.onended=()=>{this.isPlaying=!1,this.emit("playbackFinished")},s.start(),this.emit("playbackStarted")}catch(e){this.isPlaying=!1,this.handleAudioError(e)}}interruptPlayback(){this.isPlaying&&(this.context.suspend(),setTimeout((()=>{this.context.resume()}),100),this.isPlaying=!1,this.emit("playbackInterrupted"))}setInputGain(e){this.inputGain.gain.setValueAtTime(Math.max(0,Math.min(2,e)),this.context.currentTime)}setOutputGain(e){this.outputGain.gain.setValueAtTime(Math.max(0,Math.min(2,e)),this.context.currentTime)}setMuted(e){e?this.inputGain.gain.setValueAtTime(0,this.context.currentTime):this.inputGain.gain.setValueAtTime(1,this.context.currentTime)}getProcessedStream(){return this.destinationNode?.stream}handleAudioError(e){console.error("Audio processing error:",e);let t="audio_not_supported";"NotAllowedError"===e.name?t="microphone_permission_denied":"NotFoundError"===e.name&&(t="audio_not_supported");const n={type:t,message:e.message||"Audio processing error",timestamp:Date.now(),details:e,recoverable:"microphone_permission_denied"!==t};this.emit("error",n)}getLatencyMetrics(){return{...this.latencyMonitor}}async ensureAudioContext(e=!1){if(this.context&&"closed"!==this.context.state){if("suspended"===this.context.state)if(e){console.log("[WebRTCAudioProcessor] Resuming suspended audio context after user interaction");try{await this.context.resume(),console.log("[WebRTCAudioProcessor] Audio context resumed")}catch(e){console.warn("[WebRTCAudioProcessor] Failed to resume audio context:",e)}}else console.log("[WebRTCAudioProcessor] Audio context suspended - waiting for user interaction to resume")}else console.log("[WebRTCAudioProcessor] Reinitializing closed audio context"),this.context=new AudioContext({sampleRate:this.sampleRate,latencyHint:"interactive"}),this.inputGain=this.context.createGain(),this.outputGain=this.context.createGain(),this.analyserNode=this.context.createAnalyser(),this.compressorNode=this.context.createDynamicsCompressor(),this.filterNode=this.context.createBiquadFilter(),this.setupAudioProcessing(),console.log("[WebRTCAudioProcessor] Audio context reinitialized successfully")}async cleanup(){try{if(this.stopRecording(),this.mediaStream&&(this.mediaStream.getTracks().forEach((e=>e.stop())),this.mediaStream=void 0),this.workletNode&&(this.workletNode.disconnect(),this.workletNode=void 0),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.destinationNode&&(this.destinationNode=void 0),this.context&&"closed"!==this.context.state){const e=this.context.state;console.log(`[WebRTCAudioProcessor] Closing audio context in state: ${e}`);try{await this.context.close(),console.log("[WebRTCAudioProcessor] Audio context closed successfully")}catch(e){console.warn("[WebRTCAudioProcessor] Error closing audio context:",e)}}this.eventListeners.clear()}catch(e){console.error("[WebRTCAudioProcessor] Error during audio cleanup:",e)}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach((e=>e(t)))}}class m{constructor(e=2e3){this.monitoringIntervalMs=e}peerConnection;monitoringInterval;isMonitoring=!1;baselineMetrics;eventListeners=new Map;qualityThresholds={excellent:{rtt:50,packetsLost:.01,jitter:10},good:{rtt:100,packetsLost:.05,jitter:20},fair:{rtt:200,packetsLost:.1,jitter:40},poor:{rtt:400,packetsLost:.2,jitter:80},critical:{rtt:800,packetsLost:.5,jitter:150}};qualityPresets={excellent:{audiobitrate:128e3,sampleRate:24e3,bufferSize:256,enableNoiseReduction:!0,enableEchoCancellation:!0,aggressiveOptimization:!1},good:{audiobitrate:96e3,sampleRate:16e3,bufferSize:512,enableNoiseReduction:!0,enableEchoCancellation:!0,aggressiveOptimization:!1},fair:{audiobitrate:64e3,sampleRate:16e3,bufferSize:1024,enableNoiseReduction:!1,enableEchoCancellation:!0,aggressiveOptimization:!0},poor:{audiobitrate:32e3,sampleRate:8e3,bufferSize:2048,enableNoiseReduction:!1,enableEchoCancellation:!1,aggressiveOptimization:!0},critical:{audiobitrate:16e3,sampleRate:8e3,bufferSize:4096,enableNoiseReduction:!1,enableEchoCancellation:!1,aggressiveOptimization:!0}};startMonitoring(e){this.peerConnection=e,this.isMonitoring=!0,this.measureNetworkQuality().then((e=>{this.baselineMetrics=e,this.emit("baselineEstablished",e)})),this.monitoringInterval=setInterval((async()=>{if(this.isMonitoring&&this.peerConnection){const e=await this.measureNetworkQuality();this.emit("qualityUpdate",e),this.checkQualityDegradation(e)}}),this.monitoringIntervalMs)}stopMonitoring(){this.isMonitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=void 0)}async measureNetworkQuality(){const e=Date.now(),t=this.getNetworkInformation(),n=await this.getWebRTCStatistics(),s=this.calculateQualityScore(t,n),o=this.getQualityRecommendation(s,t,n);return{connectionType:t.connectionType||"unknown",effectiveType:t.effectiveType||"unknown",downlink:t.downlink||0,rtt:t.rtt||0,packetsLost:n.packetsLost||0,packetsReceived:n.packetsReceived||0,bytesReceived:n.bytesReceived||0,bytesSent:n.bytesSent||0,jitter:n.jitter||0,qualityScore:s,recommendation:o,timestamp:Date.now(),measurementDuration:Date.now()-e}}getNetworkInformation(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e?{connectionType:e.type||"unknown",effectiveType:e.effectiveType||"unknown",downlink:e.downlink||0,rtt:e.rtt||0}:{connectionType:"unknown",effectiveType:"unknown",downlink:0,rtt:0}}async getWebRTCStatistics(){if(!this.peerConnection)return{packetsLost:0,packetsReceived:0,bytesReceived:0,bytesSent:0,jitter:0};try{const e=await this.peerConnection.getStats();let t={packetsLost:0,packetsReceived:0,bytesReceived:0,bytesSent:0,jitter:0};return e.forEach((e=>{"inbound-rtp"===e.type&&"audio"===e.mediaType?(t.packetsLost+=e.packetsLost||0,t.packetsReceived+=e.packetsReceived||0,t.bytesReceived+=e.bytesReceived||0,t.jitter+=e.jitter||0):"outbound-rtp"===e.type&&"audio"===e.mediaType&&(t.bytesSent+=e.bytesSent||0)})),t}catch(e){return console.error("Failed to get WebRTC statistics:",e),{packetsLost:0,packetsReceived:0,bytesReceived:0,bytesSent:0,jitter:0}}}calculateQualityScore(e,t){const n=Math.max(1,5-(e.rtt||0)/100),s=t.packetsReceived?(t.packetsLost||0)/t.packetsReceived:0,o=.3*n+.3*Math.max(1,5-20*s)+.2*Math.max(1,5-(t.jitter||0)/20)+.2*Math.min(5,1+(e.downlink||0)/2);return Math.max(1,Math.min(5,Math.round(10*o)/10))}getQualityRecommendation(e,t,n){const s=t.rtt||0,o=n.packetsReceived?(n.packetsLost||0)/n.packetsReceived:0,i=n.jitter||0;return s<this.qualityThresholds.excellent.rtt&&o<this.qualityThresholds.excellent.packetsLost&&i<this.qualityThresholds.excellent.jitter?"excellent":s<this.qualityThresholds.good.rtt&&o<this.qualityThresholds.good.packetsLost&&i<this.qualityThresholds.good.jitter?"good":s<this.qualityThresholds.fair.rtt&&o<this.qualityThresholds.fair.packetsLost&&i<this.qualityThresholds.fair.jitter?"fair":s<this.qualityThresholds.poor.rtt&&o<this.qualityThresholds.poor.packetsLost&&i<this.qualityThresholds.poor.jitter?"poor":"critical"}checkQualityDegradation(e){if(!this.baselineMetrics)return;const t=this.baselineMetrics.qualityScore-e.qualityScore;if(t>1){this.emit("qualityDegradation",{current:e,baseline:this.baselineMetrics,degradation:t});const n=this.getAdaptiveSettings(e.recommendation);this.emit("qualityAdjustmentRecommended",n)}Date.now()-this.baselineMetrics.timestamp>6e4&&(this.baselineMetrics=e,this.emit("baselineUpdated",e))}getAdaptiveSettings(e){return{...this.qualityPresets[e]}}async getCurrentQuality(){return await this.measureNetworkQuality()}async testLatency(e="https://api.openai.com"){const t=performance.now();try{return await fetch(`${e}/ping`,{method:"HEAD",mode:"no-cors"}),Math.round(performance.now()-t)}catch(t){return new Promise((t=>{const n=new Image,s=performance.now();n.onload=n.onerror=()=>{t(Math.round(performance.now()-s))},n.src=`${e}/favicon.ico?t=${Date.now()}`}))}}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach((e=>e(t)))}cleanup(){this.stopMonitoring(),this.eventListeners.clear(),this.peerConnection=void 0,this.baselineMetrics=void 0}}class p{constructor(e,t,n,s){this.getConnection=e,this.getAudioProcessor=t,this.getNetworkMonitor=n,this.refreshToken=s,this.initializeRecoveryStrategies()}recoveryStrategies=[];activeRecovery;eventListeners=new Map;recoveryHistory=[];circuitBreakerState="closed";circuitBreakerFailures=0;circuitBreakerTimeout;isRecovering=!1;circuitBreakerThreshold=5;circuitBreakerTimeoutMs=3e4;initializeRecoveryStrategies(){this.recoveryStrategies=[{name:"simple-reconnect",priority:1,applicable:e=>"connection_failed"===e.type||"network_error"===e.type,execute:this.executeSimpleReconnect.bind(this),maxAttempts:3,delayMs:1e3},{name:"token-refresh",priority:1,applicable:e=>"token_expired"===e.type,execute:this.executeTokenRefresh.bind(this),maxAttempts:2,delayMs:500},{name:"audio-restart",priority:2,applicable:e=>"audio_not_supported"===e.type||"microphone_permission_denied"===e.type,execute:this.executeAudioRestart.bind(this),maxAttempts:2,delayMs:2e3},{name:"quality-adjustment",priority:2,applicable:e=>"network_error"===e.type,execute:this.executeQualityAdjustment.bind(this),maxAttempts:3,delayMs:1e3},{name:"full-reset",priority:3,applicable:()=>!0,execute:this.executeFullReset.bind(this),maxAttempts:1,delayMs:5e3},{name:"fallback-mode",priority:4,applicable:()=>!0,execute:this.executeFallbackMode.bind(this),maxAttempts:1,delayMs:0}]}async handleError(e){if(this.isRecovering)return console.log("[ErrorRecoveryManager] Already recovering, skipping duplicate error"),!1;if("open"===this.circuitBreakerState)return this.emit("circuitBreakerOpen",{error:e}),!1;if(!e.recoverable)return this.emit("nonRecoverableError",{error:e}),!1;this.isRecovering=!0;const t=this.recoveryStrategies.filter((t=>t.applicable(e))).sort(((e,t)=>e.priority-t.priority));if(0===t.length)return this.emit("noRecoveryStrategy",{error:e}),this.isRecovering=!1,!1;try{for(const n of t)if(await this.executeRecoveryStrategy(n,e))return this.circuitBreakerFailures=0,this.circuitBreakerState="closed",this.isRecovering=!1,!0;return this.handleRecoveryFailure(),!1}finally{this.isRecovering=!1}}async executeRecoveryStrategy(e,t){this.activeRecovery={strategy:e.name,attempt:0,maxAttempts:e.maxAttempts,lastAttempt:Date.now(),totalAttempts:0,successful:!1,error:t},this.emit("recoveryStarted",{strategy:e.name,error:t});for(let t=1;t<=e.maxAttempts;t++){this.activeRecovery.attempt=t,this.activeRecovery.totalAttempts++;try{if(t>1){const n=e.delayMs*Math.pow(2,t-2);await this.delay(n)}if(this.emit("recoveryAttempt",{strategy:e.name,attempt:t,maxAttempts:e.maxAttempts}),await e.execute())return this.activeRecovery.successful=!0,this.recoveryHistory.push({...this.activeRecovery}),this.activeRecovery=void 0,this.emit("recoverySuccess",{strategy:e.name,attempt:t}),!0}catch(n){console.error(`Recovery strategy ${e.name} failed:`,n),this.emit("recoveryError",{strategy:e.name,attempt:t,error:n})}}return this.activeRecovery.successful=!1,this.recoveryHistory.push({...this.activeRecovery}),this.activeRecovery=void 0,this.emit("recoveryExhausted",{strategy:e.name}),!1}async executeSimpleReconnect(){try{const e=this.getConnection();if(e&&"function"==typeof e.disconnect&&"function"==typeof e.connect){await e.disconnect(),await this.delay(1e3);const t=await this.refreshToken();return await e.connect(t),e.isConnected||!1}return!1}catch(e){return console.error("Simple reconnect failed:",e),!1}}async executeTokenRefresh(){try{const e=this.getConnection();if(e&&"function"==typeof e.connect){const t=await this.refreshToken();return await e.connect(t),e.isConnected||!1}return!1}catch(e){return console.error("Token refresh failed:",e),!1}}async executeAudioRestart(){try{const e=this.getAudioProcessor();if(e){"function"==typeof e.stopRecording&&e.stopRecording(),await this.delay(1e3);const t={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:16e3}};if("function"==typeof e.initializeMicrophone)return await e.initializeMicrophone(t),!0}return!1}catch(e){return console.error("Audio restart failed:",e),!1}}async executeQualityAdjustment(){try{const e=this.getNetworkMonitor();if(e&&"function"==typeof e.getCurrentQuality){const t=await e.getCurrentQuality();if("function"==typeof e.getAdaptiveSettings){const n=e.getAdaptiveSettings("poor");this.emit("qualityAdjusted",{settings:n,quality:t})}return await this.executeSimpleReconnect()}return!1}catch(e){return console.error("Quality adjustment failed:",e),!1}}async executeFullReset(){try{const e=this.getConnection(),t=this.getAudioProcessor(),n=this.getNetworkMonitor();e&&"function"==typeof e.disconnect&&await e.disconnect(),t&&"function"==typeof t.cleanup&&await t.cleanup(),n&&"function"==typeof n.stopMonitoring&&n.stopMonitoring(),await this.delay(3e3);const s=await this.refreshToken();return t&&"function"==typeof t.initializeMicrophone&&await t.initializeMicrophone(),e&&"function"==typeof e.connect&&await e.connect(s),n&&"function"==typeof n.startMonitoring&&e&&e.peerConnection&&n.startMonitoring(e.peerConnection),e?.isConnected||!1}catch(e){return console.error("Full reset failed:",e),!1}}async executeFallbackMode(){try{return this.emit("fallbackModeActivated",{reason:"All recovery strategies exhausted",timestamp:Date.now()}),!0}catch(e){return console.error("Fallback mode activation failed:",e),!1}}handleRecoveryFailure(){this.circuitBreakerFailures++,this.circuitBreakerFailures>=this.circuitBreakerThreshold&&(this.circuitBreakerState="open",this.emit("circuitBreakerTripped",{failures:this.circuitBreakerFailures,threshold:this.circuitBreakerThreshold}),this.circuitBreakerTimeout=setTimeout((()=>{this.circuitBreakerState="half-open",this.emit("circuitBreakerHalfOpen")}),this.circuitBreakerTimeoutMs))}getRecoveryStatus(){const e=this.recoveryHistory.filter((e=>e.successful)).length;return{active:!!this.activeRecovery,currentStrategy:this.activeRecovery?.strategy,attempt:this.activeRecovery?.attempt,maxAttempts:this.activeRecovery?.maxAttempts,circuitBreakerState:this.circuitBreakerState,totalRecoveries:this.recoveryHistory.length,successfulRecoveries:e}}resetCircuitBreaker(){this.circuitBreakerState="closed",this.circuitBreakerFailures=0,this.circuitBreakerTimeout&&(clearTimeout(this.circuitBreakerTimeout),this.circuitBreakerTimeout=void 0),this.emit("circuitBreakerReset")}delay(e){return new Promise((t=>setTimeout(t,e)))}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach((e=>e(t)))}cleanup(){this.circuitBreakerTimeout&&clearTimeout(this.circuitBreakerTimeout),this.eventListeners.clear(),this.recoveryHistory=[],this.activeRecovery=void 0}}class y{static key=null;static async getKey(){if(this.key)return this.key;const e=sessionStorage.getItem("va_session_key");if(e){const t=new Uint8Array(JSON.parse(e));this.key=await crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!1,["encrypt","decrypt"])}else{this.key=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);const e=await crypto.subtle.exportKey("raw",this.key);sessionStorage.setItem("va_session_key",JSON.stringify(Array.from(new Uint8Array(e))))}return this.key}static async encrypt(e){try{const t=await this.getKey(),n=(new TextEncoder).encode(e),s=crypto.getRandomValues(new Uint8Array(12)),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},t,n),i=new Uint8Array(s.length+o.byteLength);return i.set(s),i.set(new Uint8Array(o),s.length),btoa(String.fromCharCode.apply(null,Array.from(i)))}catch(t){return console.error("[SessionCrypto] Encryption failed:",t),e}}static async decrypt(e){try{const t=await this.getKey(),n=new Uint8Array(atob(e).split("").map((e=>e.charCodeAt(0)))),s=n.slice(0,12),o=n.slice(12),i=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},t,o);return(new TextDecoder).decode(i)}catch(e){return console.error("[SessionCrypto] Decryption failed:",e),null}}}class v{static dbName="VoiceAssistantSessions";static dbVersion=1;static db=null;static async openDB(){return this.db?this.db:new Promise(((e,t)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e(this.db)},n.onupgradeneeded=e=>{const t=e.target.result;if(t.objectStoreNames.contains("sessions")||t.createObjectStore("sessions",{keyPath:"sessionId"}).createIndex("lastActivity","lastActivity",{unique:!1}),!t.objectStoreNames.contains("messages")){const e=t.createObjectStore("messages",{keyPath:"id"});e.createIndex("sessionId","sessionId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}}}))}static async saveSession(e){try{const t=await this.openDB(),n=await y.encrypt(JSON.stringify(e.messages)),s={...e,messages:n},o=await Promise.all(e.messages.map((async t=>({...t,sessionId:e.sessionId,content:await y.encrypt(t.content)})))),i=t.transaction(["sessions","messages"],"readwrite");return new Promise(((t,n)=>{const a=i.objectStore("sessions"),r=i.objectStore("messages");i.oncomplete=()=>{console.log("[SessionDatabase] Session saved successfully:",e.sessionId),t()},i.onerror=()=>{console.error("[SessionDatabase] Transaction failed:",i.error),n(i.error)};const c=a.put(s);c.onerror=()=>n(c.error),o.forEach((e=>{const t=r.put(e);t.onerror=()=>n(t.error)}))}))}catch(e){throw console.error("[SessionDatabase] Failed to save session:",e),e}}static async loadSession(e){try{const t=(await this.openDB()).transaction(["sessions"],"readonly").objectStore("sessions"),n=await new Promise(((n,s)=>{const o=t.get(e);o.onsuccess=()=>n(o.result),o.onerror=()=>s(o.error)}));if(!n)return null;const s=await y.decrypt(n.messages);if(!s)return console.warn("[SessionDatabase] Failed to decrypt session messages, returning null"),null;const o=JSON.parse(s);return{...n,messages:o}}catch(e){return console.error("[SessionDatabase] Failed to load session:",e),null}}static async getRecentSessions(e=10){try{const t=(await this.openDB()).transaction(["sessions"],"readonly").objectStore("sessions").index("lastActivity"),n=[],s=t.openCursor(null,"prev");return new Promise(((t,o)=>{s.onsuccess=async s=>{const o=s.target.result;if(o&&n.length<e){const e=o.value;try{const t=await y.decrypt(e.messages);if(t){const s=JSON.parse(t);n.push({...e,messages:s})}else console.warn("[SessionDatabase] Failed to decrypt session, skipping:",e.sessionId)}catch(e){console.error("[SessionDatabase] Failed to decrypt session:",e)}o.continue()}else t(n)},s.onerror=()=>o(s.error)}))}catch(e){return console.error("[SessionDatabase] Failed to get recent sessions:",e),[]}}static async deleteSession(e){try{const t=(await this.openDB()).transaction(["sessions","messages"],"readwrite");return new Promise(((n,s)=>{const o=t.objectStore("sessions"),i=t.objectStore("messages");t.oncomplete=()=>{console.log("[SessionDatabase] Session deleted:",e),n()},t.onerror=()=>{console.error("[SessionDatabase] Delete transaction failed:",t.error),s(t.error)};const a=o.delete(e);a.onerror=()=>s(a.error);const r=i.index("sessionId").openCursor(IDBKeyRange.only(e));r.onsuccess=e=>{const t=e.target.result;t&&(i.delete(t.primaryKey),t.continue())},r.onerror=()=>s(r.error)}))}catch(e){throw console.error("[SessionDatabase] Failed to delete session:",e),e}}static async clearCorruptedSessions(){try{console.log("[SessionDatabase] Clearing corrupted sessions...");const e=await this.openDB(),t=[],n=e.transaction(["sessions"],"readonly").objectStore("sessions");await new Promise(((e,s)=>{const o=n.openCursor();o.onsuccess=n=>{const s=n.target.result;s?(t.push({key:s.primaryKey,value:s.value}),s.continue()):e(void 0)},o.onerror=()=>s(o.error)}));const s=[];for(const e of t)try{await y.decrypt(e.value.messages)||(console.log("[SessionDatabase] Found corrupted session:",e.value.sessionId),s.push(e.key))}catch(t){console.log("[SessionDatabase] Found corrupted session:",e.value.sessionId),s.push(e.key)}if(s.length>0){const t=e.transaction(["sessions"],"readwrite"),n=t.objectStore("sessions");await new Promise(((e,o)=>{t.oncomplete=()=>{console.log(`[SessionDatabase] Deleted ${s.length} corrupted sessions`),e(void 0)},t.onerror=()=>{console.error("[SessionDatabase] Failed to delete corrupted sessions:",t.error),o(t.error)},s.forEach((e=>{n.delete(e)}))}))}else console.log("[SessionDatabase] No corrupted sessions found")}catch(e){console.error("[SessionDatabase] Failed to clear corrupted sessions:",e)}}static async cleanupOldSessions(e=6048e5){try{const t=Date.now()-e,n=(await this.openDB()).transaction(["sessions"],"readwrite");return new Promise(((e,s)=>{const o=n.objectStore("sessions"),i=o.index("lastActivity");n.oncomplete=()=>{console.log("[SessionDatabase] Old sessions cleaned up"),e()},n.onerror=()=>{console.error("[SessionDatabase] Cleanup transaction failed:",n.error),s(n.error)};const a=i.openCursor(IDBKeyRange.upperBound(t));a.onsuccess=e=>{const t=e.target.result;t&&(o.delete(t.primaryKey),t.continue())},a.onerror=()=>s(a.error)}))}catch(e){throw console.error("[SessionDatabase] Failed to cleanup old sessions:",e),e}}}class f{currentSession=null;autoSaveInterval=null;debounceTimeout=null;constructor(){this.cleanupOldSessions(),this.cleanupCorruptedSessions(),this.autoSaveInterval=setInterval((()=>{this.currentSession&&this.saveCurrentSession()}),3e4),window.addEventListener("beforeunload",(()=>{this.cleanup()}))}async createSession(e){const t=await this.loadSession(e);if(t)return console.log("[VoiceSessionPersistence] Returning existing session:",e),t;const n={sessionId:e,messages:[],connectionState:"disconnected",conversationState:"idle",startTime:Date.now(),lastActivity:Date.now(),metadata:{userAgent:navigator.userAgent,totalMessages:0,totalDuration:0}};return this.currentSession=n,await this.saveCurrentSession(),console.log("[VoiceSessionPersistence] New session created:",e),n}async loadSession(e){const t=await v.loadSession(e);return t&&(this.currentSession=t,console.log("[VoiceSessionPersistence] Session loaded:",e)),t}addMessage(e){this.currentSession&&(this.currentSession.messages.push(e),this.currentSession.lastActivity=Date.now(),this.currentSession.metadata.totalMessages++,this.debouncedSave())}updateConnectionState(e){this.currentSession&&(this.currentSession.connectionState=e,this.currentSession.lastActivity=Date.now(),this.debouncedSave())}updateConversationState(e){this.currentSession&&(this.currentSession.conversationState=e,this.currentSession.lastActivity=Date.now(),this.debouncedSave())}getCurrentSession(){return this.currentSession}async getRecentSessions(){return await v.getRecentSessions()}async deleteSession(e){await v.deleteSession(e),this.currentSession?.sessionId===e&&(this.currentSession=null)}debouncedSave(){this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout((()=>{this.saveCurrentSession()}),1e3)}async saveCurrentSession(){this.currentSession?(this.currentSession.metadata.totalDuration=Date.now()-this.currentSession.startTime,console.log("[VoiceSessionPersistence] Saving session:",{sessionId:this.currentSession.sessionId,messageCount:this.currentSession.messages.length,duration:this.currentSession.metadata.totalDuration,firstMessage:this.currentSession.messages[0]?.content?.substring(0,30)||"NONE"}),await v.saveSession(this.currentSession)):console.warn("[VoiceSessionPersistence] No current session to save")}async cleanupOldSessions(){await v.cleanupOldSessions(6048e5)}async cleanupCorruptedSessions(){try{await v.clearCorruptedSessions()}catch(e){console.warn("[VoiceSessionPersistence] Failed to cleanup corrupted sessions:",e)}}cleanup(){this.autoSaveInterval&&clearInterval(this.autoSaveInterval),this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.currentSession&&this.saveCurrentSession()}}class b{static STORAGE_KEY="voice_assistant_preferences";static getPreferences(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e)return{...this.getDefaultPreferences(),...JSON.parse(e)}}catch(e){console.error("[VoicePreferencesManager] Failed to load preferences:",e)}return this.getDefaultPreferences()}static savePreferences(e){try{const t={...this.getPreferences(),...e};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),console.log("[VoicePreferencesManager] Preferences saved")}catch(e){console.error("[VoicePreferencesManager] Failed to save preferences:",e)}}static clearPreferences(){try{localStorage.removeItem(this.STORAGE_KEY),console.log("[VoicePreferencesManager] Preferences cleared")}catch(e){console.error("[VoicePreferencesManager] Failed to clear preferences:",e)}}static getDefaultPreferences(){return{voicePersonality:"sage",isMinimized:!0,showTranscript:!0,volume:.8,theme:"auto",position:"bottom-right"}}}const w=new f;class x{static instance=null;currentSession=null;sessionPersistence;tabId;windowId;isRestoring=!1;autoSaveInterval=null;tokenRefreshCallback=null;onSessionRestored;onSessionExpired;static ACTIVE_SESSION_KEY="webrtc_active_session";static TAB_SESSION_KEY="webrtc_tab_session";static TOKEN_KEY="webrtc_session_token";static SESSION_VERSION="1.0.0";constructor(){"undefined"!=typeof window?(this.sessionPersistence=new f,this.tabId=this.generateTabId(),this.windowId=this.generateWindowId(),setTimeout((()=>{this.setupEventListeners(),this.startAutoSave()}),0),console.log("[Enhanced Session Manager] Initialized with tabId:",this.tabId)):console.log("[Enhanced Session Manager] Deferring initialization - window not available")}static getInstance(){return this.instance||"undefined"==typeof window||(this.instance=new x),this.instance}setTokenRefreshCallback(e){this.tokenRefreshCallback=e}setEventCallbacks(e){this.onSessionRestored=e.onSessionRestored,this.onSessionExpired=e.onSessionExpired}async createSession(e,t,n){console.log("[Enhanced Session Manager] Creating new session:",{sessionId:e,tokenExpiresAt:n});const s={sessionId:e,token:t,tokenExpiresAt:n,messages:[],connectionState:"connecting",conversationState:"idle",startTime:Date.now(),lastActivity:Date.now(),isActive:!0,tabId:this.tabId,windowId:this.windowId,metadata:{userAgent:navigator.userAgent,totalMessages:0,totalDuration:0,reconnectAttempts:0,version:x.SESSION_VERSION}};return this.currentSession=s,this.persistToken(),this.markTabActive(),await this.saveSession(),console.log("[Enhanced Session Manager] Session created and persisted"),s}async restoreSession(){if(this.isRestoring)return console.log("[Enhanced Session Manager] Already restoring, skipping"),{success:!1,reason:"Already restoring",shouldStartNew:!1,reconnectRequired:!1};this.isRestoring=!0;try{console.log("[Enhanced Session Manager] Attempting session restoration...");const e=this.getPersistedToken();if(!e)return console.log("[Enhanced Session Manager] No persisted token found"),{success:!1,reason:"No token found",shouldStartNew:!0,reconnectRequired:!1};if(Date.now()>=e.tokenExpiresAt){if(console.log("[Enhanced Session Manager] Token expired, attempting refresh"),!this.tokenRefreshCallback)return console.log("[Enhanced Session Manager] No token refresh callback available"),this.clearPersistedData(),{success:!1,reason:"Token expired, no refresh available",shouldStartNew:!0,reconnectRequired:!1};try{const t=await this.tokenRefreshCallback();e.token=t.token,e.tokenExpiresAt=t.expiresAt,t.sessionId!==e.sessionId&&(e.sessionId=t.sessionId),this.persistToken(e),console.log("[Enhanced Session Manager] Token refreshed successfully")}catch(e){return console.error("[Enhanced Session Manager] Token refresh failed:",e),this.clearPersistedData(),this.onSessionExpired&&this.onSessionExpired(),{success:!1,reason:"Token refresh failed",shouldStartNew:!0,reconnectRequired:!1}}}console.log("[Enhanced Session Manager] Loading session from IndexedDB for sessionId:",e.sessionId);let t=await this.sessionPersistence.loadSession(e.sessionId);if(!t){console.log("[Enhanced Session Manager] No session found for ID, trying to get most recent session");const e=await this.sessionPersistence.getRecentSessions();e&&e.length>0&&(t=e[0],console.log("[Enhanced Session Manager] Found recent session:",t.sessionId))}if(!t)return console.log("[Enhanced Session Manager] No persisted session found in IndexedDB"),{success:!0,sessionData:await this.createSession(e.sessionId,e.token,e.tokenExpiresAt),shouldStartNew:!1,reconnectRequired:!0};console.log("[Enhanced Session Manager] Loaded persisted session:",{sessionId:t.sessionId,messageCount:t.messages?t.messages.length:0,messagesArray:t.messages,hasMessages:!!t.messages&&t.messages.length>0}),t.messages&&t.messages.length>0&&t.messages.forEach(((e,t)=>{console.log(`[Enhanced Session Manager] Message ${t+1}:`,{type:e.type,hasContent:!!e.content,contentLength:e.content?e.content.length:0,contentPreview:e.content?e.content.substring(0,50):"NO CONTENT"})}));const n=t.messages?t.messages.sort(((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())):[];console.log("[Enhanced Session Manager] Sorted messages count:",n.length);const s={sessionId:e.sessionId,token:e.token,tokenExpiresAt:e.tokenExpiresAt,messages:n,connectionState:"disconnected",conversationState:"idle",startTime:t.startTime,lastActivity:Date.now(),isActive:!0,tabId:this.tabId,windowId:this.windowId,metadata:{...t.metadata,reconnectAttempts:t.metadata.reconnectAttempts||0,lastReconnectTime:Date.now(),version:x.SESSION_VERSION}};return this.currentSession=s,this.markTabActive(),console.log("[Enhanced Session Manager] Session restored successfully:",{sessionId:s.sessionId,messageCount:s.messages.length,totalDuration:s.metadata.totalDuration,firstMessage:s.messages[0]||"NONE",lastMessage:s.messages[s.messages.length-1]||"NONE"}),this.onSessionRestored&&this.onSessionRestored(s),{success:!0,sessionData:s,shouldStartNew:!1,reconnectRequired:!0}}catch(e){return console.error("[Enhanced Session Manager] Session restoration failed:",e),this.clearPersistedData(),{success:!1,reason:`Restoration error: ${e}`,shouldStartNew:!0,reconnectRequired:!1}}finally{this.isRestoring=!1}}addMessage(e){this.currentSession?(this.currentSession.messages.push(e),this.currentSession.lastActivity=Date.now(),this.currentSession.metadata.totalMessages++,this.sessionPersistence.addMessage(e),console.log("[Enhanced Session Manager] Message added:",{type:e.type,sessionId:this.currentSession.sessionId,totalMessages:this.currentSession.messages.length,content:e.content?e.content.substring(0,50)+"...":"NO CONTENT"}),this.saveSession()):console.warn("[Enhanced Session Manager] Cannot add message - no current session")}updateConnectionState(e){if(!this.currentSession)return;const t=this.currentSession.connectionState;this.currentSession.connectionState=e,this.currentSession.lastActivity=Date.now(),"connected"===e&&"connected"!==t?(this.currentSession.metadata.reconnectAttempts=0,delete this.currentSession.metadata.lastReconnectTime):"disconnected"===e&&"connected"===t&&(this.currentSession.metadata.reconnectAttempts++,this.currentSession.metadata.lastReconnectTime=Date.now()),this.sessionPersistence.updateConnectionState(e),console.log("[Enhanced Session Manager] Connection state updated:",e)}updateConversationState(e){this.currentSession&&(this.currentSession.conversationState=e,this.currentSession.lastActivity=Date.now(),this.sessionPersistence.updateConversationState(e))}getCurrentSession(){return this.currentSession}async getCurrentToken(){if(!this.currentSession)return null;const e=this.currentSession.tokenExpiresAt-3e5;if(Date.now()>=e&&this.tokenRefreshCallback)try{console.log("[Enhanced Session Manager] Refreshing token proactively");const e=await this.tokenRefreshCallback();this.currentSession.token=e.token,this.currentSession.tokenExpiresAt=e.expiresAt,e.sessionId!==this.currentSession.sessionId&&(this.currentSession.sessionId=e.sessionId),this.persistToken(),console.log("[Enhanced Session Manager] Token refreshed proactively")}catch(e){console.error("[Enhanced Session Manager] Proactive token refresh failed:",e)}return{token:this.currentSession.token,expiresAt:this.currentSession.tokenExpiresAt,sessionId:this.currentSession.sessionId}}needsReconnection(){if(!this.currentSession)return!1;const e=Date.now();return"connected"!==this.currentSession.connectionState||e-this.currentSession.lastActivity>3e5||this.currentSession.tokenExpiresAt-e<6e5}async endSession(){this.currentSession&&(console.log("[Enhanced Session Manager] Ending session:",this.currentSession.sessionId),this.currentSession.isActive=!1,this.currentSession.connectionState="disconnected",this.currentSession.lastActivity=Date.now(),await this.saveSession(),this.clearActiveSessionMarkers(),this.currentSession=null,console.log("[Enhanced Session Manager] Session ended"))}clearAllSessionData(){console.log("[Enhanced Session Manager] Clearing all session data"),this.currentSession&&this.sessionPersistence.deleteSession(this.currentSession.sessionId),this.clearPersistedData(),this.currentSession=null}getSessionStats(){return this.currentSession?{isActive:this.currentSession.isActive,sessionId:this.currentSession.sessionId,messageCount:this.currentSession.messages.length,duration:Date.now()-this.currentSession.startTime,reconnectAttempts:this.currentSession.metadata.reconnectAttempts,tokenExpiresIn:Math.max(0,this.currentSession.tokenExpiresAt-Date.now())}:{isActive:!1,sessionId:null,messageCount:0,duration:0,reconnectAttempts:0,tokenExpiresIn:0}}generateTabId(){return`tab_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateWindowId(){const e=sessionStorage.getItem("webrtc_window_id");if(e)return e;const t=`win_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return sessionStorage.setItem("webrtc_window_id",t),t}persistToken(e){try{const t=e||(this.currentSession?{sessionId:this.currentSession.sessionId,token:this.currentSession.token,tokenExpiresAt:this.currentSession.tokenExpiresAt}:null);t&&(sessionStorage.setItem(x.TOKEN_KEY,JSON.stringify(t)),console.log("[Enhanced Session Manager] Token persisted"))}catch(e){console.error("[Enhanced Session Manager] Failed to persist token:",e)}}getPersistedToken(){try{const e=sessionStorage.getItem(x.TOKEN_KEY);return e?JSON.parse(e):null}catch(e){return console.error("[Enhanced Session Manager] Failed to get persisted token:",e),null}}markTabActive(){try{const e={tabId:this.tabId,windowId:this.windowId,sessionId:this.currentSession?.sessionId,timestamp:Date.now()};sessionStorage.setItem(x.TAB_SESSION_KEY,JSON.stringify(e)),localStorage.setItem(x.ACTIVE_SESSION_KEY,JSON.stringify(e))}catch(e){console.error("[Enhanced Session Manager] Failed to mark tab active:",e)}}clearActiveSessionMarkers(){try{sessionStorage.removeItem(x.TAB_SESSION_KEY),localStorage.removeItem(x.ACTIVE_SESSION_KEY)}catch(e){console.error("[Enhanced Session Manager] Failed to clear active markers:",e)}}clearPersistedData(){try{sessionStorage.removeItem(x.TOKEN_KEY),this.clearActiveSessionMarkers(),console.log("[Enhanced Session Manager] Persisted data cleared")}catch(e){console.error("[Enhanced Session Manager] Failed to clear persisted data:",e)}}async saveSession(){if(this.currentSession)try{if(this.currentSession.metadata.totalDuration=Date.now()-this.currentSession.startTime,await this.sessionPersistence.createSession(this.currentSession.sessionId),this.currentSession.messages&&this.currentSession.messages.length>0){const e=this.sessionPersistence.getCurrentSession();e&&(e.messages=this.currentSession.messages,e.connectionState=this.currentSession.connectionState,e.conversationState=this.currentSession.conversationState,e.lastActivity=this.currentSession.lastActivity,e.metadata=this.currentSession.metadata)}console.log("[Enhanced Session Manager] Session saved with",this.currentSession.messages.length,"messages")}catch(e){console.error("[Enhanced Session Manager] Failed to save session:",e)}}setupEventListeners(){document.addEventListener("visibilitychange",(()=>{document.hidden?this.saveSession():this.currentSession&&(this.currentSession.lastActivity=Date.now())})),window.addEventListener("beforeunload",(e=>{this.currentSession&&this.saveSession()})),window.addEventListener("unload",(()=>{this.currentSession&&(this.currentSession.isActive=!1,this.clearActiveSessionMarkers())})),window.addEventListener("storage",(e=>{e.key===x.ACTIVE_SESSION_KEY&&console.log("[Enhanced Session Manager] Another tab became active")}))}startAutoSave(){this.autoSaveInterval=setInterval((()=>{this.currentSession&&this.currentSession.isActive&&this.saveSession()}),3e4)}cleanup(){this.autoSaveInterval&&(clearInterval(this.autoSaveInterval),this.autoSaveInterval=null),this.currentSession&&this.saveSession(),this.sessionPersistence.cleanup(),console.log("[Enhanced Session Manager] Cleanup completed")}}class S extends d{sessionStartTime=0;warningTimer;timeoutTimer;checkInterval;MAX_SESSION_DURATION=18e5;WARNING_THRESHOLD=3e5;RECONNECT_BUFFER=3e4;constructor(){super()}startSession(){this.sessionStartTime=Date.now(),this.clearTimers(),this.warningTimer=setTimeout((()=>{console.log("[SessionTimeout] Warning: Session will expire in 5 minutes"),this.emit("warning",5),setTimeout((()=>{console.log("[SessionTimeout] Warning: Session will expire in 3 minutes"),this.emit("warning",3)}),12e4),setTimeout((()=>{console.log("[SessionTimeout] Warning: Session will expire in 1 minute"),this.emit("warning",1)}),24e4)}),this.MAX_SESSION_DURATION-this.WARNING_THRESHOLD),this.timeoutTimer=setTimeout((()=>{console.log("[SessionTimeout] Proactively reconnecting before 30-minute timeout"),console.log(`[SessionTimeout] Session duration: ${this.getSessionDuration()/1e3}s, triggering reconnect`),this.emit("timeout")}),this.MAX_SESSION_DURATION-this.RECONNECT_BUFFER),this.startPeriodicCheck(),console.log("[SessionTimeout] Session tracking started (30 minute duration)"),console.log("[SessionTimeout] Warnings will appear at: 25min, 27min, 29min. Reconnect at: 29.5min")}stopSession(){this.clearTimers(),this.sessionStartTime=0,console.log("[SessionTimeout] Session tracking stopped")}getRemainingTime(){if(!this.sessionStartTime)return this.MAX_SESSION_DURATION;const e=Date.now()-this.sessionStartTime;return Math.max(0,this.MAX_SESSION_DURATION-e)}getRemainingTimeFormatted(){const e=this.getRemainingTime();return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`}getSessionDuration(){return this.sessionStartTime?Date.now()-this.sessionStartTime:0}isNearTimeout(){return this.getRemainingTime()<this.WARNING_THRESHOLD}resetSession(){console.log("[SessionTimeout] Resetting session timer after reconnection"),this.startSession(),this.emit("reconnected")}startPeriodicCheck(){this.checkInterval=setInterval((()=>{const e=this.getRemainingTime(),t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);t%5==0&&n<5&&console.log(`[SessionTimeout] Status: ${t}:${n.toString().padStart(2,"0")} remaining`),e<this.RECONNECT_BUFFER&&e>0&&(console.log("[SessionTimeout] Triggering proactive reconnection NOW"),this.emit("timeout"),this.clearTimers())}),6e4)}clearTimers(){this.warningTimer&&(clearTimeout(this.warningTimer),this.warningTimer=void 0),this.timeoutTimer&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=void 0)}handleTimeoutError(e){return!!e.message?.includes("maximum duration of 30 minutes")&&(console.log("[SessionTimeout] Detected 30-minute timeout error from API"),this.emit("timeout"),!0)}getSessionStats(){const e=this.getSessionDuration();return{duration:e,remaining:this.getRemainingTime(),remainingFormatted:this.getRemainingTimeFormatted(),isNearTimeout:this.isNearTimeout(),percentUsed:Math.min(100,e/this.MAX_SESSION_DURATION*100)}}destroy(){this.clearTimers(),this.removeAllListeners()}}const k={modalities:["text","audio"],instructions:'You are Sarah, a world-class AI Education Strategist for Executive AI Training, specializing in helping business owners and their teams understand and leverage AI effectively. You have an exceptional ability to assess knowledge gaps, identify learning opportunities, and create clear educational pathways that match each business\'s unique needs. You must ask the business owner all questions in the assessment and cover all section content. \n\n## Core Personality:\n- **Voice**: Patient, encouraging, warm, and excellent at making complex AI concepts accessible\n- **Tone**: Supportive, knowledgeable, and genuinely interested in their success\n- **Style**: Conversational, empathetic, and adaptive to their knowledge level\n- **Expertise**: Deep understanding of AI education, adult learning principles, and business transformation\n\n## Session Context:\nYou must get today\'s date and time (in America Chicago), as well as the business owner\'s name, business name and industry.\n\n## Voice-First Communication Principles:\n\n### Natural Speech Patterns:\n- Use discourse markers like "I mean", "you know", "actually" to sound natural\n- Include thinking sounds like "hmm" or "oh interesting" when processing their answers\n- Vary your enthusiasm based on their energy level\n- Mirror their communication style (formal vs casual)\n\n### Pronunciation Guidelines:\n- AI is pronounced "ay eye" not "aee"\n- Lead (as in sales lead) is pronounced "leed"\n- 24/7 is spoken as "twenty-four-seven"\n- Times like 2:00 PM are spoken as "two PM"\n- Websites like example.com are spoken as "example dot com"\n- Email addresses: name@company.com is "name at company dot com"\n\n### Emotional Intelligence:\nRespond to the emotional context of their voice. If they sound:\n- **Anxious**: Reassure them there are no wrong answers\n- **Excited**: Match their enthusiasm and dive deeper\n- **Confused**: Slow down and clarify with simpler language\n- **Skeptical**: Acknowledge their concerns and provide examples\n- **Overwhelmed**: Simplify and focus on one thing at a time\n\n## Session Introduction Script:\n"Hi {{ownerfirstName}}! I\'m Sara, your Executive AI Training Assessment Specialist. Thanks so much for taking the time to speak with me today about your AI education opportunities. \n\nBefore we jump in, let me quickly explain what we\'ll be doing today (you must mention all of these):\n- This assessment typically takes about 15 to 20 minutes\n- Everything we discuss is completely confidential\n- While this is normally a four hundred ninety seven dollar service, there\'s absolutely no cost to you today\n- I\'ll be asking about your current understanding of AI and your team\'s knowledge level\n- Remember, there are no wrong answers here - this is about finding your perfect starting point\n- Once we\'re done, our team will create your personalized AI Education Roadmap and text you a link to access it\n- I\'m a synthetic intelligence voice agent - which means you\'re safe to discuss things in an open and transparent way - I\'m not human and won\'t judge anything you say and I don\'t take things personally. Feel free to stop me, ask questions (there are no dumb questions - only the ones you don\'t ask) or, if ned be, ask me to repeat myself. I am built on technology so I\'m not always perfect, but I am highly specialized and have a better tha PHD level understanding of most industries. Though, I don\'t operate in the physical world where you do so, only you and your team have current, real world knowledge of exactly how your business operates. Everything you share today will help me apply my combined knowledge with your expertise to make the perfect education roadmap for you and your team/business.\n\nDoes that sound good? Any questions before we start?"\n\n## Adaptive Question Flow System:\n\n### Dynamic Path Selection:\nBased on their responses, adapt your questions:\n- If they rate themselves 1-3/10 on AI knowledge: Focus on foundational concepts\n- If they rate themselves 4-6/10: Explore specific gaps and practical applications  \n- If they rate themselves 7-10/10: Dive into advanced topics and team enablement\n\n### Smart Follow-ups:\nWhen they mention specific pain points or interests, dynamically insert relevant follow-up questions:\n- "You mentioned [specific tool/challenge]. Tell me more about that..."\n- "That\'s interesting about [their response]. How is that affecting your business?"\n- "I\'m curious about what you said regarding [topic]. Have you explored any solutions?"\n\n## Core Assessment Questions:\n\n### Section 1: Business Context and Confirmation\n\n#### Business Information Review\n1. Confirm the name of their business and what city they are located in\n2. Confirm the industry their business operates in\n3. Confirm any specific business goals or challenges they mentioned previously\n4. Conduct a web search of their business and their digital footprint and get a comprehensive understanding what they do and what their customers think of them (then share with them and confirm if they want to add anything to your assessment)\n5. Thank them for confirming and warmly transition to the education assessment\n\n\n### Section 2: Current AI Knowledge Assessment - Business Owner\n\n#### Personal AI Awareness\n5. On a scale of one to ten, with one being no knowledge and ten being expert level, how would you rate your current understanding of AI and its business applications?\n6. What does AI mean to you in the context of your business? (Listen for misconceptions or gaps)\n7. Have you had any formal or informal AI training or education before?\n\n#### AI Tool Familiarity\n8. Are you currently using any AI tools in your personal or professional life? If yes, which ones?\n9. What AI tools or technologies have you heard about but aren\'t sure how they apply to your business?\n10. Have you tried any AI tools that didn\'t work out? What happened?\n\n#### Industry AI Awareness\n11. Are you aware of how your competitors or others in your industry are using AI?\n12. What AI success stories or case studies in your industry have caught your attention?\n13. What concerns or hesitations do you have about AI in your industry?\n\n### Section 3: Team and Organizational AI Readiness\n\n#### Team Structure and Roles\n14. How many employees do you currently have?\n15. What are the main departments or roles in your organization?\n16. Who in your organization would be the key decision-makers for adopting new technologies?\n\n#### Team AI Knowledge Assessment\n17. How would you describe your team\'s overall comfort level with technology in general?\n18. On that same one to ten scale, how would you rate your team\'s current understanding of AI?\n19. Have any of your team members expressed interest in learning about AI?\n20. Have any team members expressed concerns or resistance about AI potentially affecting their jobs?\n\n#### Current Technology Usage\n21. What software or digital tools does your team currently use daily?\n22. How well does your team adapt when you introduce new technology or processes?\n23. Do you have anyone on your team who typically champions new technology adoption?\n\n### Section 4: Business Process and AI Opportunity Mapping\n\n#### Core Business Processes\n24. Walk me through a typical day in your business - what are the main activities happening?\n25. What tasks take up the most time for you personally each day?\n26. What tasks take up the most time for your team?\n\n#### Pain Points and Inefficiencies\n27. What repetitive tasks in your business feel like they should be easier or faster?\n28. Where do bottlenecks typically occur in your operations?\n29. What business processes cause the most frustration for you or your team?\n\n#### Customer Interaction Points\n30. How do customers typically find and first interact with your business?\n31. What questions do customers ask most frequently?\n32. How do you currently handle customer service and support?\n\n#### Data and Decision Making\n33. What kind of data do you collect about your business operations?\n34. How do you currently analyze this data to make decisions?\n35. What business decisions do you wish you had better information for?\n\n### Section 5: Learning Preferences and Educational Goals\n\n#### Learning Style Assessment\n36. When you need to learn something new for your business, how do you prefer to learn - videos, reading, hands-on practice, or working with an instructor?\n37. How much time per week could you realistically dedicate to AI education?\n38. Do you prefer learning independently or in a group setting with your team?\n\n#### Educational Priorities\n39. If you could understand one thing about AI better, what would it be?\n40. What AI capability would have the biggest impact on your business if you knew how to use it?\n41. Are you more interested in understanding AI strategy or hands-on tool usage?\n\n#### Team Training Considerations\n42. How does your team typically receive training on new systems or processes?\n43. Would your team benefit more from general AI awareness or role-specific AI training?\n44. Who on your team would be the best AI champions to train first?\n\n### Section 6: Competitive and Market Intelligence\n\n#### Competitor Analysis\n45. Do you know if your main competitors are using AI? In what ways?\n46. What competitive advantages do you think AI could give your business?\n47. What would happen to your market position if competitors adopt AI before you do?\n\n#### Industry Trends\n48. What major changes or trends are you seeing in your industry right now?\n49. How do you stay informed about new developments in your industry?\n50. Are there industry associations or groups discussing AI adoption in your field?\n\n### Section 7: Implementation Readiness and Timeline\n\n#### Resource Assessment\n51. What\'s your current budget range for professional development and training?\n52. Do you have IT support, either internal or external?\n53. How do you typically make decisions about investing in new business capabilities?\n\n#### Timeline and Urgency\n54. When would you ideally want to start implementing AI in your business?\n55. What\'s driving your timeline - is it opportunity, competition, or something else?\n56. What would need to happen for you to feel ready to start AI education?\n\n### Section 8: Specific AI Tool Categories and Use Cases\n\n#### Marketing and Sales AI\n57. Are you familiar with AI tools for content creation, social media, or email marketing?\n58. Would you benefit from understanding how AI can qualify and score leads?\n59. Do you know about AI-powered customer relationship management?\n\n#### Operations and Automation AI\n60. Are you aware of how AI can automate document processing and data entry?\n61. Would learning about AI for inventory or resource management be valuable?\n62. Do you understand how AI chatbots and virtual assistants work?\n\n#### Analytics and Decision Support AI\n63. Are you familiar with predictive analytics and what it could tell you about your business?\n64. Would you benefit from understanding AI-powered business intelligence tools?\n65. Do you know how AI can help with financial forecasting and planning?\n\n### Section 9: Barriers and Support Needs\n\n#### Perceived Barriers\n66. What do you see as the biggest obstacle to you personally learning about AI?\n67. What would be the biggest challenge in getting your team educated about AI?\n68. What technical limitations might affect your ability to use AI tools?\n\n#### Support Requirements\n69. What kind of ongoing support would you need after initial AI education?\n70. Would you prefer having an AI advisor or consultant available for questions?\n71. How important is it to have local or industry-specific examples in your training?\n\n### Section 10: Measuring Success and ROI\n\n#### Success Metrics\n72. How would you measure whether AI education was successful for you?\n73. What would need to change in your business for you to consider AI education worthwhile?\n74. What return on investment would justify the time spent on AI education?\n\n#### Long-term Vision\n75. Where do you see your business in three years regarding AI adoption?\n76. What role do you envision AI playing in your business\'s future growth?\n77. How would you want your business to be known regarding its use of AI?\n\n## Closing Questions and Wrap-up\n\n78. Based on everything we\'ve discussed, what aspect of AI education excites you most?\n79. What questions about AI have been on your mind that we haven\'t covered?\n80. Is there anyone else in your organization who should be involved in AI education planning?\n\n### Conversation Techniques:\n- **Acknowledgment**: "That\'s really insightful..." / "I completely understand..." / "Many business owners feel the same way..."\n- **Transitions**: "Speaking of that..." / "That brings up a great point..." / "Building on what you just said..."\n- **Clarification**: "When you say X, do you mean..." / "Help me understand..." / "Can you give me an example?"\n- **Encouragement**: "That\'s exactly the kind of thinking that leads to success..." / "You\'re already ahead of many businesses..."\n\n## Intelligent Search Integration:\n\nWhen users ask about competitors, AI tools, or industry trends:\n\n### Natural Search Acknowledgment:\n- "Let me look up what\'s happening in your industry with AI..."\n- "I\'ll check on what tools are popular in the {{steps.trigger.event.body.customData.whatIndustry}} space..."\n- "Let me find some examples of how similar businesses are using AI..."\n\n### Contextual Information Gathering:\nUse search to enhance the conversation when they:\n- Don\'t know what their competitors are doing\n- Ask about specific AI tools they\'ve heard of\n- Want examples from their industry\n- Need current pricing or availability information\n\n### Conversational Result Integration:\nWeave search results naturally into the assessment:\n- "I just found that many businesses in your industry are starting with [specific tool]..."\n- "Interestingly, your competitor [name] recently implemented [AI solution]..."\n- "The latest trends show that [industry] companies are focusing on [AI application]..."\n\n## Advanced Conversation Management:\n\n### Memory and Context:\n- Remember everything they\'ve told you throughout the conversation\n- Reference earlier answers to show you\'re listening\n- Build a mental model of their business and challenges\n- Use their language and terminology when possible\n\n### Pace Management:\n- If they\'re giving short answers: Use encouraging prompts to elaborate\n- If they\'re very detailed: Acknowledge thoroughly but keep moving\n- If they go off-topic: Gently guide back with "That\'s fascinating, and it actually relates to..."\n\n### Knowledge Level Calibration:\nAdjust your language based on their demonstrated understanding:\n- **Beginner**: Use analogies, avoid jargon, focus on benefits\n- **Intermediate**: Include some technical terms, discuss specific tools\n- **Advanced**: Engage with strategy, ROI, implementation challenges\n\n## Personalized Insights Throughout:\nBased on their industry and responses, offer mini-insights:\n- "In the {{businessIndustry}} industry, I\'m seeing a lot of success with..."\n- "Based on what you\'ve told me about your team size, you might want to consider..."\n- "Given your current tech stack, AI tools like [specific tool] would integrate well..."\n\n## Closing Excellence:\n\n### Summary and Next Steps:\n"{{ownerfirstName}}, thank you so much for being so open and thoughtful with your answers. Based on everything we\'ve discussed, I can already see some exciting opportunities for AI education in your business.\n\nYour personalized AI Education Roadmap will:\n- Start exactly where you are now, no assumptions\n- Prioritize the AI knowledge that will have the biggest impact on {{businessName}}\n- Include specific tool recommendations for the {{businessIndustry}} industry\n- Map out a learning path for both you and your team\n- Give you a clear timeline that fits your schedule\n\nOur Education Roadmap team will analyze our conversation and you\'ll receive a text with your customized roadmap within 24 hours. \n\nDo you have any questions about what happens next? [Pause for response]\n\nI\'m genuinely excited to see how AI education transforms your business, {{ownerfirstName}}. You\'re taking the exact right first step. Have a wonderful rest of your day!"\n\n## Continuous Improvement Notes:\n- Listen for emotional cues and adjust approach accordingly\n- If they seem overwhelmed, slow down and simplify\n- If they\'re excited, channel that energy into deeper exploration\n- Always end on a positive, forward-looking note\n- Make them feel smart for taking this step, regardless of their current knowledge level',voice:"shimmer",input_audio_format:"pcm16",output_audio_format:"pcm16",input_audio_transcription:{model:"whisper-1"},turn_detection:{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:700},tools:[{type:"function",name:"web_search",description:"Search the webfor current information about businesses, locations, news, AI tools, industry trends, competitor AI usage, or educational resources.\n\nIMPORTANT: Always acknowledge the search request naturally before calling this function. Use conversation context to understand what they're asking about.\nUse this when you:\n- Need information about the user's business and digital footprint\nUse this when users:\n- Ask about what AI tools are available for their industry\n- Want to know what competitors are doing with AI\n- Need information about specific AI solutions they've heard about\n- Request examples of AI success stories in their field\n- Want current information about AI training resources or costs",parameters:{type:"object",properties:{query:{type:"string",description:"the search query to execute. Include context from current or previous conversation when relevant (e.g., business name + what user is asking about or what you need to know about their business)."}},required:["query"]}},{type:"function",name:"save_assessment_note",description:"Save important observations or insights about the user's AI education needs for the Roadmap team.\n\nUse this to capture:\n- Key knowledge gaps identified\n- Specific tools they're interested in\n- Team dynamics or resistance points\n- Priority learning areas\n- Industry-specific opportunities\n- Notable quotes or concerns",parameters:{type:"object",properties:{note_type:{type:"string",enum:["knowledge_gap","opportunity","concern","priority","team_dynamic","industry_insight"],description:"Category of the note for easier analysis"},content:{type:"string",description:"The specific observation or insight to save"},importance:{type:"string",enum:["high","medium","low"],description:"How critical this insight is for the education roadmap"}},required:["note_type","content","importance"]}},{type:"function",name:"calculate_readiness_score",description:"Calculate an AI readiness score based on the assessment answers.\n\nCall this near the end of the assessment to provide a preliminary score that helps set expectations.",parameters:{type:"object",properties:{personal_knowledge:{type:"number",description:"Owner AI knowledge rating (1-10)"},team_knowledge:{type:"number",description:"Team AI knowledge rating (1-10)"},tech_adoption:{type:"number",description:"Current technology adoption level (1-10)"},urgency:{type:"number",description:"Urgency to implement AI (1-10)"},resources:{type:"number",description:"Available resources for education (1-10)"}},required:["personal_knowledge","team_knowledge","tech_adoption","urgency","resources"]}}],tool_choice:"auto",temperature:.75,max_response_output_tokens:"inf"};class C extends d{connection;audioProcessor;networkMonitor;errorRecovery;sessionManager;connectionState="disconnected";conversationState="idle";messageSequence=0;localStream=null;config;sessionConfig;sessionId="";isInitializing=!1;isInitialized=!1;isRestoring=!1;conversationContext=[];sessionMemory=new Map;performanceMetrics={latency:0,audioQuality:0,connectionStability:0};pendingHistoryInjection=[];isSessionCreated=!1;activeResponseId=null;isResponseInProgress=!1;timeoutHandler;tokenManager={token:null,expiresAt:0};constructor(e){super(),this.config=e,this.sessionConfig={...k,...e.sessionConfig},this.timeoutHandler=new S,this.setupTimeoutHandlerEvents(),this.sessionManager=x.getInstance(),this.sessionManager?(this.sessionManager.setTokenRefreshCallback((async()=>(await this.refreshToken(),{token:this.tokenManager.token,expiresAt:this.tokenManager.expiresAt,sessionId:this.sessionId}))),this.sessionManager.setEventCallbacks({onSessionRestored:e=>{console.log("[WebRTC Voice Agent] Session restored:",e.sessionId),this.handleSessionRestored(e)},onSessionExpired:()=>{console.log("[WebRTC Voice Agent] Session expired"),this.emit("sessionExpired")}})):console.log("[WebRTC Voice Agent] Session manager not available (SSR mode)"),this.connection=new u(e.maxReconnectAttempts||3,e.reconnectDelay||1e3),this.audioProcessor=new g(24e3,e.targetLatency||75,!1!==e.adaptiveQuality),this.networkMonitor=new m,this.errorRecovery=new p((()=>this.connection),(()=>this.audioProcessor),(()=>this.networkMonitor),(async()=>(this.sessionManager?await this.sessionManager.getCurrentToken():null)||(await this.refreshToken(),{token:this.tokenManager.token,expiresAt:this.tokenManager.expiresAt,sessionId:this.sessionId}))),this.setupEventHandlers(),this.initializePerformanceMonitoring()}initializePerformanceMonitoring(){this.networkMonitor.on("connectionQualityChange",(e=>{this.performanceMetrics.connectionStability=e.score,this.config.adaptiveQuality&&this.adjustQualityBasedOnNetwork(e)}))}async measureLatency(){const e=performance.now();this.sessionMemory.set("last_measurement_time",e);const t=this.sessionMemory.get("recent_latencies")||[];if(t.length>0){const e=t.reduce(((e,t)=>e+t),0)/t.length;this.performanceMetrics.latency=Math.round(e)}}adjustQualityBasedOnNetwork(e){this.config.targetLatency,e.score<.5?(this.sessionConfig.turn_detection.silence_duration_ms=1200,this.audioProcessor.setInputGain(.8)):e.score>.8&&(this.sessionConfig.turn_detection.silence_duration_ms=600,this.audioProcessor.setInputGain(1))}async initialize(){if(this.isInitializing||this.isRestoring)console.log("[WebRTC Voice Agent] Already initializing or restoring, skipping duplicate call");else if(this.isInitialized&&"connected"===this.connectionState)console.log("[WebRTC Voice Agent] Already initialized and connected");else{this.isInitializing=!0;try{console.log("[WebRTC Voice Agent] Initializing with session restoration support..."),console.log("[WebRTC Voice Agent] Attempting session restoration...");const e=this.sessionManager?await this.sessionManager.restoreSession():{success:!1,reason:"No session manager",shouldStartNew:!0,reconnectRequired:!1};e?.success&&e.sessionData?(console.log("[WebRTC Voice Agent] Session restoration successful"),this.sessionId=e.sessionData.sessionId,this.tokenManager.token=e.sessionData.token,this.tokenManager.expiresAt=e.sessionData.tokenExpiresAt,this.restoreConversationContext(e.sessionData.messages),this.emit("sessionRestored",e.sessionData),e.reconnectRequired&&(console.log("[WebRTC Voice Agent] Reconnection required for restored session"),this.emit("reconnecting"),await this.performConnection(!0))):e.shouldStartNew?(console.log("[WebRTC Voice Agent] Starting new session:",e.reason),this.pendingHistoryInjection=[],this.isSessionCreated=!1,console.log("[WebRTC Voice Agent] Getting authentication token..."),await this.refreshToken(),this.sessionManager&&await this.sessionManager.createSession(this.sessionId,this.tokenManager.token,this.tokenManager.expiresAt),await this.performConnection(!1)):(console.log("[WebRTC Voice Agent] Session restoration failed, starting fresh"),this.pendingHistoryInjection=[],this.isSessionCreated=!1,await this.refreshToken(),this.sessionManager&&await this.sessionManager.createSession(this.sessionId,this.tokenManager.token,this.tokenManager.expiresAt),await this.performConnection(!1)),this.isInitialized=!0}catch(e){this.isInitialized=!1,await this.handleError({type:"connection_failed",message:e instanceof Error?e.message:"Initialization failed",timestamp:Date.now(),details:e,recoverable:!0})}finally{this.isInitializing=!1}}}async performConnection(e){console.log(`[WebRTC Voice Agent] ${e?"Reconnecting":"Connecting"} to OpenAI...`),await this.audioProcessor.ensureAudioContext(!1),this.localStream=await this.audioProcessor.initializeMicrophone();const t={token:this.tokenManager.token,expiresAt:this.tokenManager.expiresAt,sessionId:this.sessionId};await this.connection.connect(t,this.localStream,this.sessionConfig),this.connection.peerConnection&&this.networkMonitor.startMonitoring(this.connection.peerConnection),console.log("[WebRTC Voice Agent] Connection established, session configuration will be sent when data channel opens"),this.updateConnectionState("connected"),console.log("[WebRTC Voice Agent] Emitting connectionStateChanged event: connected"),this.emit("connectionStateChanged","connected"),e&&this.emit("reconnected"),console.log("[WebRTC Voice Agent] Starting continuous audio streaming for server-side VAD"),this.audioProcessor.startRecording(),this.updateConversationState("listening"),this.emit("recordingStarted")}handleSessionRestored(e){console.log("[WebRTC Voice Agent] Handling session restoration with",e.messages.length,"messages"),this.sessionId=e.sessionId,this.restoreConversationContext(e.messages),e.messages.forEach((e=>{"user"===e.type?this.emit("userTranscript",{text:e.content,isFinal:!0}):"assistant"===e.type&&this.emit("assistantTranscript",{text:e.content,isFinal:!0})}))}restoreConversationContext(e){console.log("[WebRTC Voice Agent] Starting conversation context restoration"),console.log("[WebRTC Voice Agent] Input messages array:",e),console.log("[WebRTC Voice Agent] Number of messages to restore:",e?e.length:0),this.conversationContext=[],this.pendingHistoryInjection=[...e],e.forEach(((e,t)=>{console.log(`[WebRTC Voice Agent] Message ${t+1}:`,{type:e.type,hasContent:!!e.content,contentLength:e.content?e.content.length:0,contentPreview:e.content?e.content.substring(0,100):"NO CONTENT",timestamp:e.timestamp}),"user"===e.type&&e.content?this.conversationContext.push(`User: ${e.content}`):"assistant"===e.type&&e.content?this.conversationContext.push(`Assistant: ${e.content}`):console.warn("[WebRTC Voice Agent] Skipping message without content or invalid type:",e)})),this.conversationContext.length>10&&(this.conversationContext=this.conversationContext.slice(-10)),console.log("[WebRTC Voice Agent] Conversation context restored:",{contextEntries:this.conversationContext.length,pendingInjectionCount:this.pendingHistoryInjection.length,firstMessage:this.conversationContext[0]||"NONE",lastMessage:this.conversationContext[this.conversationContext.length-1]||"NONE"})}async injectConversationHistory(){if(console.log("[WebRTC Voice Agent] Processing conversation history restoration"),console.log("[WebRTC Voice Agent] Pending history messages:",this.pendingHistoryInjection?.length||0),this.pendingHistoryInjection&&0!==this.pendingHistoryInjection.length)try{const e=this.pendingHistoryInjection.map(((e,t)=>`${"user"===e.type?"User":"Assistant"}: ${e.content}`)).join("\n"),t={type:"session.update",session:{instructions:`${this.sessionConfig.instructions}\n\nIMPORTANT: This is a restored conversation session. Here is the conversation history from the previous session:\n\n${e}\n\nPlease continue the conversation naturally from where it left off, maintaining awareness of all previous context and any information that was discussed.`,modalities:this.sessionConfig.modalities,voice:this.sessionConfig.voice,input_audio_format:this.sessionConfig.input_audio_format,output_audio_format:this.sessionConfig.output_audio_format,input_audio_transcription:this.sessionConfig.input_audio_transcription,turn_detection:this.sessionConfig.turn_detection,tools:this.sessionConfig.tools,tool_choice:this.sessionConfig.tool_choice,temperature:this.sessionConfig.temperature,max_response_output_tokens:this.sessionConfig.max_response_output_tokens}};console.log("[WebRTC Voice Agent] Updating session with conversation context"),this.connection.sendEvent(t),this.pendingHistoryInjection.forEach((e=>{const t=`${"user"===e.type?"User":"Assistant"}: ${e.content}`;this.addToConversationContext(t)}));const n=this.pendingHistoryInjection.length;console.log(`[WebRTC Voice Agent] Context established with ${n} historical messages`),this.pendingHistoryInjection=[],setTimeout((()=>{console.log("[WebRTC Voice Agent] Agent ready for continued conversation"),this.restoreListeningState()}),500)}catch(e){console.error("[WebRTC Voice Agent] Failed to restore conversation context:",e),this.pendingHistoryInjection=[],this.restoreListeningState()}else console.log("[WebRTC Voice Agent] No conversation history to restore")}async startListening(){if("connected"!==this.connectionState)throw new Error("Cannot start listening: not connected");await this.audioProcessor.ensureAudioContext(!0),console.log("[WebRTC Voice Agent] Start listening called but already in continuous mode"),this.updateConversationState("listening"),this.emit("recordingStarted")}stopListening(){console.log("[WebRTC Voice Agent] Stop listening called but maintaining continuous audio stream"),this.emit("recordingStopped")}sendMessage(e){if("connected"!==this.connectionState)throw new Error("Cannot send message: not connected");console.log("[WebRTC Voice Agent] Sending text message:",e);const t=performance.now(),n="msg_"+ ++this.messageSequence,s={id:n,type:"user",content:e,timestamp:(new Date).toISOString()};this.sessionManager&&this.sessionManager.addMessage(s),console.log("[WebRTC Voice Agent] Emitting userTranscript for text message"),this.emit("userTranscript",{text:e,isFinal:!0}),this.addToConversationContext(`User: ${e}`);const o={event_id:n,type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:e}]}};console.log("[WebRTC Voice Agent] Sending conversation.item.create event:",o),this.connection.sendEvent(o),this.sessionMemory.set(`message_sent_${n}`,t);const i={event_id:"resp_"+ ++this.messageSequence,type:"response.create"};console.log("[WebRTC Voice Agent] Sending response.create event:",i),this.connection.sendEvent(i)}interrupt(){if("connected"!==this.connectionState)return void console.warn("Cannot interrupt: not connected");const e={event_id:"interrupt_"+ ++this.messageSequence,type:"response.cancel"};this.connection.sendEvent(e);const t={event_id:"clear_"+ ++this.messageSequence,type:"output_audio_buffer.clear"};this.connection.sendEvent(t),this.updateConversationState("idle"),this.emit("playbackFinished")}testResponse(){console.log("[WebRTC Voice Agent] Manually triggering test response");const e={event_id:"test_msg_"+ ++this.messageSequence,type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:"Hello, can you hear me? Please respond with voice."}]}};this.connection.sendEvent(e),setTimeout((()=>{const e={event_id:"test_resp_"+ ++this.messageSequence,type:"response.create",response:{modalities:["text","audio"],instructions:"Respond with a friendly greeting using voice."}};console.log("[WebRTC Voice Agent] Sending test response.create event"),this.connection.sendEvent(e)}),500)}setupEventHandlers(){this.connection.on("connected",(()=>{console.log("[WebRTC Main] Connection connected event received"),this.updateConnectionState("connected"),this.emit("connectionStateChanged","connected")})),this.connection.on("disconnected",(()=>{console.log("[WebRTC Main] Connection disconnected event received"),this.updateConnectionState("disconnected"),this.emit("connectionStateChanged","disconnected")})),this.connection.on("error",(e=>{this.handleError({type:"connection_failed",message:e.message||"Connection error",timestamp:Date.now(),details:e,recoverable:!0})})),this.connection.on("realtimeEvent",(e=>{this.handleRealtimeEvent(e)})),this.connection.on("audioTrack",(e=>{this.handleIncomingAudio(e)})),this.connection.on("dataChannelError",(e=>{console.error("[WebRTC Voice Agent] Data channel error:",e),this.handleError({type:"data_channel_error",message:e.message||"Data channel communication error",timestamp:Date.now(),details:e,recoverable:!0})})),this.connection.on("dataChannelClose",(()=>{console.warn("[WebRTC Voice Agent] Data channel closed unexpectedly"),this.handleError({type:"data_channel_closed",message:"Data channel closed during operation",timestamp:Date.now(),details:{reason:"Data channel closed"},recoverable:!0})})),this.audioProcessor.on("audioLevel",(e=>{this.emit("audioLevel",e)})),this.audioProcessor.on("vadStateChange",(e=>{e.isSpeaking?this.emit("speechStarted"):this.emit("speechEnded")})),this.networkMonitor.on("connectionQualityChange",(e=>{e.score<.5&&this.emit("warning","Poor network connection detected")})),this.errorRecovery.on("recoveryAttempt",(e=>{console.log(`Recovery attempt ${e.attemptNumber}/${e.maxAttempts}`)})),this.errorRecovery.on("recoverySuccess",(async()=>{console.log("Successfully recovered from error"),await this.ensureAudioPlayback(),this.restoreListeningState()})),this.errorRecovery.on("recoveryFailed",(()=>{console.error("Failed to recover from error, activating fallback"),this.emit("fallbackActivated")}))}handleRealtimeEvent(e){switch(console.log("[WebRTC Voice Agent] Realtime event:",e.type,e),e.type){case"session.created":console.log("Session created:",e),this.isSessionCreated=!0,this.timeoutHandler.startSession(),console.log("[WebRTC Voice Agent] Session timeout tracking started (30-minute limit)"),this.injectConversationHistory().catch((e=>{console.error("[WebRTC Voice Agent] Failed to inject conversation history:",e)}));break;case"conversation.item.created":this.handleMessageCreated(e);break;case"response.audio.delta":console.log("[WebRTC Voice Agent] Ignoring audio delta event in WebRTC mode");break;case"response.audio.done":console.log("[WebRTC Voice Agent] Audio done event (WebSocket mode)");break;case"response.text.delta":this.handleTextDelta(e);break;case"response.text.done":this.handleTextDone(e);break;case"response.function_call_arguments.delta":this.handleFunctionCallDelta(e);break;case"response.function_call_arguments.done":this.handleFunctionCallDone(e);break;case"input_audio_buffer.speech_started":console.log("User started speaking"),this.emit("speechStarted");break;case"input_audio_buffer.speech_stopped":console.log("[WebRTC Voice Agent] Speech stopped - server VAD will trigger response automatically"),this.updateConversationState("processing");break;case"output_audio_buffer.started":console.log("[WebRTC Voice Agent] Audio buffer started - beginning playback"),this.updateConversationState("speaking"),this.emit("playbackStarted");break;case"output_audio_buffer.stopped":console.log("[WebRTC Voice Agent] Audio buffer stopped - playback complete"),this.updateConversationState("idle"),this.emit("playbackFinished");break;case"output_audio_buffer.cleared":console.log("[WebRTC Voice Agent] Audio buffer cleared");break;case"response.audio_transcript.delta":e.delta&&this.emit("assistantTranscript",{text:e.delta,isFinal:!1});break;case"response.audio_transcript.done":if(console.log("[WebRTC Voice Agent] Assistant transcript completed:",e.transcript),e.transcript){this.emit("assistantTranscript",{text:e.transcript,isFinal:!0});const t={id:e.item_id||`assistant_transcript_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"assistant",content:e.transcript,timestamp:(new Date).toISOString()};this.sessionManager&&(console.log("[WebRTC Voice Agent] Saving assistant transcript to session manager:",t.content),this.sessionManager.addMessage(t)),this.addToConversationContext(`Assistant: ${e.transcript}`)}break;case"conversation.item.input_audio_transcription.completed":this.handleUserTranscriptCompleted(e);break;case"conversation.item.input_audio_transcription.failed":this.handleUserTranscriptFailed(e);break;case"conversation.item.input_audio_transcription.delta":this.handleUserTranscriptDelta(e);break;case"response.created":this.activeResponseId=e.response?.id||null,this.isResponseInProgress=!0,console.log("[WebRTC Voice Agent] Response started:",this.activeResponseId);break;case"response.done":case"response.cancelled":case"response.interrupted":this.activeResponseId&&e.response?.id!==this.activeResponseId||(this.isResponseInProgress=!1,this.activeResponseId=null,console.log("[WebRTC Voice Agent] Response ended:",e.type,e.response?.id));break;case"error":e.error?.message?.includes("active response in progress")&&(console.log("[WebRTC Voice Agent] Resetting response tracking due to error"),this.isResponseInProgress=!1,this.activeResponseId=null),this.handleRealtimeError(e);break;default:console.log("Unhandled realtime event:",e.type,e)}}handleMessageCreated(e){console.log("[WebRTC Voice Agent] Message created event received:",e);const{item:t}=e;if(!t||"message"!==t.type)return void console.log("[WebRTC Voice Agent] Skipping non-message item:",t?.type);let n=null;if("user"===t.role){if(console.log("[WebRTC Voice Agent] Processing user message:",JSON.stringify(t,null,2)),Array.isArray(t.content)){const e=t.content.find((e=>"input_text"===e.type||"text"===e.type||"input_audio_transcription"===e.type));e&&(n=e.text||e.transcript||e.content)}else"string"==typeof t.content?n=t.content:t.content&&"object"==typeof t.content&&(n=t.content.text||t.content.transcript||t.content.content);if(!n&&t.formatted_content&&(n=t.formatted_content),!n&&t.transcript&&(n=t.transcript),n){console.log("[WebRTC Voice Agent] Extracted user message text:",n),this.emit("userTranscript",{text:n,isFinal:!0});const e={id:t.id||`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"user",content:n,timestamp:(new Date).toISOString()};this.sessionManager&&(console.log("[WebRTC Voice Agent] Saving user message to session manager:",e.content),this.sessionManager.addMessage(e)),this.addToConversationContext(`User: ${n}`)}else console.log("[WebRTC Voice Agent] Could not extract text from user message"),console.log("[WebRTC Voice Agent] Item structure:",JSON.stringify(t,null,2))}else if("assistant"===t.role){if(console.log("[WebRTC Voice Agent] Processing assistant message:",JSON.stringify(t,null,2)),Array.isArray(t.content)){const e=t.content.find((e=>"text"===e.type||"audio"===e.type));e&&(n=e.text||e.transcript||e.content)}else"string"==typeof t.content?n=t.content:t.content&&"object"==typeof t.content&&(n=t.content.text||t.content.transcript||t.content.content);if(!n&&t.formatted_content&&(n=t.formatted_content),!n&&t.transcript&&(n=t.transcript),n){console.log("[WebRTC Voice Agent] Extracted assistant message text:",n),this.emit("assistantTranscript",{text:n,isFinal:!0});const e={id:t.id||`assistant_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"assistant",content:n,timestamp:(new Date).toISOString()};this.sessionManager&&(console.log("[WebRTC Voice Agent] Saving assistant message to session manager:",e.content),this.sessionManager.addMessage(e)),this.addToConversationContext(`Assistant: ${n}`)}else console.log("[WebRTC Voice Agent] Could not extract text from assistant message"),console.log("[WebRTC Voice Agent] Item structure:",JSON.stringify(t,null,2))}else"system"===t.role?console.log("[WebRTC Voice Agent] Skipping system message"):console.log("[WebRTC Voice Agent] Unhandled message role:",t.role)}handleTextDelta(e){if(e.delta){if(e.response_id&&!this.sessionMemory.has(`response_received_${e.response_id}`)){const t=performance.now();this.sessionMemory.set(`response_received_${e.response_id}`,t);const n=Array.from(this.sessionMemory.keys()).filter((e=>e.startsWith("message_sent_"))).map((e=>({key:e,time:this.sessionMemory.get(e)}))).sort(((e,t)=>t.time-e.time));if(n.length>0){const e=t-n[0].time,s=this.sessionMemory.get("recent_latencies")||[];s.push(e),s.length>10&&s.shift(),this.sessionMemory.set("recent_latencies",s),console.log(`[WebRTC Voice Agent] Response latency: ${Math.round(e)}ms`)}}this.emit("assistantTranscript",{text:e.delta,isFinal:!1})}}handleTextDone(e){e.text&&(this.emit("assistantTranscript",{text:e.text,isFinal:!0}),this.addToConversationContext(`Assistant: ${e.text}`))}handleFunctionCallDelta(e){if(console.log("[WebRTC Voice Agent] Function call arguments delta:",e),e.call_id&&e.delta){const t=this.sessionMemory.get(`function_call_${e.call_id}`)||{name:e.name||"",arguments:""};t.arguments+=e.delta,this.sessionMemory.set(`function_call_${e.call_id}`,t)}}handleFunctionCallDone(e){if(console.log("[WebRTC Voice Agent] Function call done:",e),e.call_id)try{const t=this.sessionMemory.get(`function_call_${e.call_id}`);let n,s=e.name,o=e.arguments||"";t&&(s=t.name||s,o=t.arguments||o),console.log("[WebRTC Voice Agent] Executing function call:",{name:s,arguments:o,callId:e.call_id});try{n=JSON.parse(o)}catch(t){return console.error("[WebRTC Voice Agent] Failed to parse function arguments:",t),void this.sendFunctionCallError(e.call_id,"Invalid function arguments format")}"web_search"===s?this.executeWebSearch(e.call_id,n):(console.error("[WebRTC Voice Agent] Unknown function name:",s),this.sendFunctionCallError(e.call_id,`Unknown function: ${s}`)),this.sessionMemory.delete(`function_call_${e.call_id}`)}catch(t){console.error("[WebRTC Voice Agent] Error handling function call:",t),this.sendFunctionCallError(e.call_id,"Function execution failed")}else console.error("[WebRTC Voice Agent] Function call done event missing call_id")}async executeWebSearch(e,t){try{console.log(`[WebRTC Voice Agent] Executing web search for query: "${t.query}"`);const n=this.getSearchEndpoint();console.log("[WebRTC Voice Agent] Calling search endpoint:",n);const s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t.query})}),o=await s.text();if(console.log("[WebRTC Voice Agent] Received raw search result:",o),!s.ok)throw new Error(`Search API responded with status ${s.status}: ${o}`);const i=JSON.parse(o);if(!0!==i.success||!i.response)throw!1===i.success&&i.error?new Error(i.error):new Error("Unexpected response format from search API");this.sendFunctionCallResult(e,{success:!0,query:t.query,response:i.response,searchResults:i.searchResults||[],citations:i.citations||[]})}catch(n){console.error("[WebRTC Voice Agent] Web search execution failed:",n),this.sendFunctionCallResult(e,{success:!1,error:n instanceof Error?n.message:"An unknown error occurred during the web search.",fallback:`I apologize, but my attempt to search for "${t.query}" failed.`})}}sendFunctionCallResult(e,t){const n={event_id:"func_result_"+ ++this.messageSequence,type:"conversation.item.create",item:{type:"function_call_output",call_id:e,output:JSON.stringify(t)}};console.log("[WebRTC Voice Agent] Sending function call result:",n),this.connection.sendEvent(n);const s={event_id:"resp_after_func_"+ ++this.messageSequence,type:"response.create"};console.log("[WebRTC Voice Agent] Sending response.create event to process function result"),this.connection.sendEvent(s)}getSearchEndpoint(){return"/api/voice-agent/responses-search"}sendFunctionCallError(e,t){this.sendFunctionCallResult(e,{success:!1,error:t})}handleUserTranscriptCompleted(e){if(console.log("[WebRTC Voice Agent] User transcript completed:",e),e.transcript){if(this.emit("userTranscript",{text:e.transcript,isFinal:!0}),console.log("[WebRTC Voice Agent] Emitted userTranscript (final):",e.transcript),e.item_id){const t={id:e.item_id||`user_transcript_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"user",content:e.transcript,timestamp:(new Date).toISOString()};this.sessionManager&&(console.log("[WebRTC Voice Agent] Saving user transcript to session manager:",t.content),this.sessionManager.addMessage(t))}this.addToConversationContext(`User: ${e.transcript}`)}}handleUserTranscriptDelta(e){console.log("[WebRTC Voice Agent] User transcript delta:",e),e.delta&&(this.emit("userTranscript",{text:e.delta,isFinal:!1}),console.log("[WebRTC Voice Agent] Emitted userTranscript (partial):",e.delta))}handleUserTranscriptFailed(e){console.error("[WebRTC Voice Agent] User transcript failed:",e);const t={code:"transcription_failed",type:"audio",message:e.error?.message||"User audio transcription failed",recoverable:!0,details:e};this.emit("error",t)}addToConversationContext(e){this.conversationContext.push(e),this.conversationContext.length>10&&this.conversationContext.shift(),console.log("[WebRTC Voice Agent] Updated conversation context:",this.conversationContext.slice(-3))}getConversationContext(){return this.conversationContext.slice(-5).join("\n")}handleRealtimeError(e){if(this.timeoutHandler.handleTimeoutError(e.error))return void console.log("[WebRTC Voice Agent] Session timeout detected, handler will manage reconnection");const t={type:"api_error",message:e.error?.message||"Unknown error",timestamp:Date.now(),details:e,recoverable:"invalid_api_key"!==e.error?.code};this.handleError(t)}restoreListeningState(){console.log("[WebRTC Voice Agent] Restoring listening state after recovery");try{if(this.audioProcessor&&"connected"===this.connectionState){this.audioProcessor.isListening?.()||(console.log("[WebRTC Voice Agent] Restarting microphone listening after recovery"),this.audioProcessor.startListening?.());const e={event_id:"session_update_"+ ++this.messageSequence,type:"session.update",session:{turn_detection:{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200}}};console.log("[WebRTC Voice Agent] Sending session update to restore responsiveness"),this.connection.sendEvent(e);const t={event_id:"input_buffer_enable_"+ ++this.messageSequence,type:"input_audio_buffer.clear"};this.connection.sendEvent(t),this.emit("agentReady",{message:"Agent is now ready to receive input after recovery",timestamp:Date.now()})}}catch(e){console.error("[WebRTC Voice Agent] Error restoring listening state:",e)}}updateSessionConfig(e){if(this.sessionConfig={...this.sessionConfig,...e},"connected"===this.connectionState){const t={event_id:`session_update_${Date.now()}`,type:"session.update",session:this.sessionConfig};this.connection.sendEvent(t),console.log("Updated session configuration:",e)}}changeVoice(e){this.updateSessionConfig({voice:e})}setVoiceSpeed(e){const t=Math.max(.25,Math.min(1.5,e));this.updateSessionConfig({speed:t})}setNoiseReduction(e){"auto"===e?(console.log("Auto mode not supported by API, defaulting to near_field"),this.updateSessionConfig({input_audio_noise_reduction:{type:"near_field"}})):this.updateSessionConfig({input_audio_noise_reduction:{type:e}})}setSessionMemory(e){e?(this.conversationContext=this.conversationContext.slice(-10),console.log("Session memory enabled (local management)")):(this.conversationContext=[],console.log("Session memory disabled"))}getPerformanceMetrics(){return{...this.performanceMetrics}}getSessionStats(){const e=this.sessionManager?this.sessionManager.getSessionStats():{isActive:!1,sessionId:null,messageCount:0,duration:0,reconnectAttempts:0,tokenExpiresIn:0},t={sessionId:this.sessionId,duration:Date.now()-(this.sessionMemory.get("session_start")||Date.now()),messageCount:this.messageSequence,errors:this.sessionMemory.get("error_count")||0,avgLatency:this.performanceMetrics.latency};return{...e,...t,messageCount:Math.max(e.messageCount,t.messageCount)}}handleIncomingAudio(e){console.log("[WebRTC Voice Agent] Incoming audio stream received, setting up playback");let t=document.getElementById("voice-agent-audio");t||(t=document.createElement("audio"),t.id="voice-agent-audio",t.autoplay=!0,t.muted=!1,t.volume=1,t.setAttribute("playsinline","true"),t.style.display="none",document.body.appendChild(t),t.addEventListener("play",(()=>{console.log("[WebRTC Voice Agent] Audio element started playing")})),t.addEventListener("pause",(()=>{console.log("[WebRTC Voice Agent] Audio element paused")})),t.addEventListener("error",(e=>{console.error("[WebRTC Voice Agent] Audio element error:",e)}))),t.srcObject=e,t.play().catch((async e=>{if(console.error("[WebRTC Voice Agent] Error starting audio playback:",e),"suspended"===this.audioProcessor.context.state)try{await this.audioProcessor.context.resume(),console.log("[WebRTC Voice Agent] Audio context resumed"),t.play().catch((e=>{console.error("[WebRTC Voice Agent] Retry failed:",e)}))}catch(e){console.error("[WebRTC Voice Agent] Failed to resume audio context:",e)}this.emit("error",{code:"audio_playback_failed",type:"audio",message:"Audio playback requires user interaction",details:e,recoverable:!0})})),console.log("[WebRTC Voice Agent] Audio playback configured for WebRTC stream")}async handleError(e){console.error("WebRTC Voice Agent Error:",e);const t={code:e.type,message:e.message,type:e.type,recoverable:e.recoverable,details:e.details};if(this.emit("error",t),this.isInitializing||"disconnected"===this.connectionState)console.log("[WebRTC Voice Agent] Skipping error recovery - already initializing or disconnected");else if(e.recoverable)try{await this.errorRecovery.handleError(e)}catch(e){console.error("Recovery failed:",e)}}async refreshToken(){try{this.tokenManager.refreshTimer&&clearTimeout(this.tokenManager.refreshTimer);const e=await fetch(`${this.config.apiEndpoint}/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:this.sessionId||void 0})});if(!e.ok)throw new Error(`Token refresh failed: ${e.statusText}`);const t=await e.json();this.tokenManager.token=t.token,this.tokenManager.expiresAt=t.expiresAt||Date.now()+15e5,this.sessionId=t.session_id||this.sessionId;const n=Math.max(this.tokenManager.expiresAt-Date.now()-3e5,6e4);this.tokenManager.refreshTimer=setTimeout((()=>{this.refreshToken().catch(console.error)}),n),console.log("Token refreshed successfully (mode: realtime)")}catch(e){throw console.error("Failed to refresh token:",e),e}}async reconnect(){this.isInitializing?console.log("[WebRTC Voice Agent] Already reconnecting, skipping"):(await this.disconnect(),await new Promise((e=>setTimeout(e,500))),await this.initialize())}updateConnectionState(e){if(this.connectionState!==e){const t=this.connectionState;this.connectionState=e,this.sessionManager&&this.sessionManager.updateConnectionState(e),this.emit("connectionStateChanged",e),console.log(`[WebRTC Voice Agent] Connection state changed: ${t} -> ${e}`)}}updateConversationState(e){if(this.conversationState!==e){const t=this.conversationState;this.conversationState=e,this.sessionManager&&this.sessionManager.updateConversationState(e),this.emit("conversationStateChanged",e),console.log(`[WebRTC Voice Agent] Conversation state changed: ${t} -> ${e}`)}}getStatus(){return{connectionState:this.connectionState,conversationState:this.conversationState,networkQuality:null,audioLevel:0,recoveryStatus:this.errorRecovery.getRecoveryStatus()}}async ensureAudioPlayback(){console.log("[WebRTC Voice Agent] Ensuring audio playback after recovery");const e=document.getElementById("voice-agent-audio");if(e){if(!e.srcObject||0===e.srcObject.getTracks().length){console.warn("[WebRTC Voice Agent] Audio element has no valid source, attempting to restore");const t=this.connection?.getRemoteAudioStream?.();if(t&&t.getTracks().length>0)console.log("[WebRTC Voice Agent] Restoring audio stream from connection"),e.srcObject=t;else{const t=this.connection?.getRemoteTracks?.();if(t&&t.length>0){console.log("[WebRTC Voice Agent] Creating new stream from remote tracks");const n=new MediaStream(t);e.srcObject=n}else console.error("[WebRTC Voice Agent] No remote audio available for restoration")}}e.paused&&(console.log("[WebRTC Voice Agent] Audio was paused, attempting to resume"),e.play().then((()=>{console.log("[WebRTC Voice Agent] Audio playback resumed successfully")})).catch((e=>{console.warn("[WebRTC Voice Agent] Failed to resume audio:",e)}))),e.volume<1&&(console.log("[WebRTC Voice Agent] Restoring audio volume to 1.0"),e.volume=1),e.muted&&(console.log("[WebRTC Voice Agent] Unmuting audio"),e.muted=!1)}else{console.warn("[WebRTC Voice Agent] No audio element found during recovery, creating new one");const e=this.connection?.getRemoteAudioStream?.();if(e&&e.getTracks().length>0)console.log("[WebRTC Voice Agent] Creating audio element with stored remote stream"),this.handleIncomingAudio(e);else{const e=this.connection?.getRemoteTracks?.();if(e&&e.length>0){console.log("[WebRTC Voice Agent] Creating audio element with remote tracks");const t=new MediaStream(e);this.handleIncomingAudio(t)}else console.error("[WebRTC Voice Agent] Cannot restore audio - no remote stream or tracks available")}}this.audioProcessor&&await this.audioProcessor.ensureAudioContext(!1),console.log("[WebRTC Voice Agent] Audio recovery complete - agent ready for user input")}async disconnect(){try{console.log("[WebRTC Voice Agent] Disconnecting..."),this.isInitialized=!1,this.isInitializing=!1,this.isSessionCreated=!1,this.pendingHistoryInjection=[],this.timeoutHandler.stopSession(),this.audioProcessor.stopRecording(),this.updateConversationState("idle"),this.updateConnectionState("disconnected"),this.sessionManager&&await this.sessionManager.endSession();const e=document.getElementById("voice-agent-audio");e&&(e.pause(),e.srcObject=null,e.remove()),await this.connection.disconnect(),await this.audioProcessor.cleanup(),this.networkMonitor.cleanup(),this.errorRecovery.cleanup(),console.log("[WebRTC Voice Agent] Disconnected successfully")}catch(e){console.error("Error during disconnect:",e)}}setupTimeoutHandlerEvents(){this.timeoutHandler.on("warning",(async e=>{console.log(`[WebRTC Voice Agent] Session timeout warning: ${e} minutes remaining`),await this.injectTimeoutWarning(e)})),this.timeoutHandler.on("timeout",(async()=>{console.log("[WebRTC Voice Agent] Session timeout reached, initiating proactive reconnection"),await this.injectReconnectionMessage(),this.sessionManager&&await this.sessionManager.saveSession(),await new Promise((e=>setTimeout(e,2e3))),await this.handleSessionTimeout()})),this.timeoutHandler.on("reconnected",(()=>{console.log("[WebRTC Voice Agent] Session successfully refreshed after timeout"),setTimeout((async()=>{await this.injectReconnectionSuccessMessage()}),1e3)}))}async injectTimeoutWarning(e){if("connected"===this.connectionState&&this.connection.sendEvent){this.isResponseInProgress&&(console.log("[WebRTC Voice Agent] Waiting for active response to complete before injecting warning"),await this.waitForResponseCompletion());try{const t=1===e?"Just to let you know, our session will need to refresh in about 1 minute to continue our conversation. Don't worry, I'll handle it seamlessly and we can pick up right where we left off.":`Just to let you know, our session will need to refresh in about ${e} minutes to continue our conversation. I'll take care of it automatically when the time comes.`,n={event_id:"timeout_warning_"+ ++this.messageSequence,type:"conversation.item.create",item:{type:"message",role:"assistant",content:[{type:"text",text:t}]}};console.log("[WebRTC Voice Agent] Injecting timeout warning as assistant message:",t),console.log("[WebRTC Voice Agent] Sending conversation.item.create event:",n),this.connection.sendEvent(n);const s={event_id:"timeout_warning_resp_"+ ++this.messageSequence,type:"response.create"};await new Promise((e=>setTimeout(e,200))),console.log("[WebRTC Voice Agent] Triggering voice response for timeout warning"),this.connection.sendEvent(s)}catch(e){console.error("[WebRTC Voice Agent] Failed to inject timeout warning:",e)}}else console.log("[WebRTC Voice Agent] Cannot inject timeout warning - not connected")}async waitForResponseCompletion(e=1e4){const t=Date.now();for(;this.isResponseInProgress&&Date.now()-t<e;)await new Promise((e=>setTimeout(e,100)));this.isResponseInProgress&&console.log("[WebRTC Voice Agent] Warning: Response still in progress after waiting")}async injectReconnectionMessage(){if("connected"===this.connectionState&&this.connection.sendEvent){this.isResponseInProgress&&(console.log("[WebRTC Voice Agent] Waiting for active response to complete before reconnection message"),await this.waitForResponseCompletion());try{const e="I'm refreshing our connection now to continue our conversation smoothly. This will just take a moment.",t={event_id:"reconnect_msg_"+ ++this.messageSequence,type:"conversation.item.create",item:{type:"message",role:"assistant",content:[{type:"text",text:e}]}};console.log("[WebRTC Voice Agent] Injecting reconnection assistant message"),this.connection.sendEvent(t);const n={event_id:"reconnect_resp_"+ ++this.messageSequence,type:"response.create"};await new Promise((e=>setTimeout(e,200))),console.log("[WebRTC Voice Agent] Triggering voice response for reconnection message"),this.connection.sendEvent(n)}catch(e){console.error("[WebRTC Voice Agent] Failed to inject reconnection message:",e)}}else console.log("[WebRTC Voice Agent] Cannot inject reconnection message - not connected")}async injectReconnectionSuccessMessage(){if("connected"===this.connectionState&&this.connection.sendEvent){this.isResponseInProgress&&(console.log("[WebRTC Voice Agent] Waiting for active response to complete before success message"),await this.waitForResponseCompletion());try{const e="Perfect! I'm ready to continue our conversation. How can I help you?",t={event_id:"success_msg_"+ ++this.messageSequence,type:"conversation.item.create",item:{type:"message",role:"assistant",content:[{type:"text",text:e}]}};console.log("[WebRTC Voice Agent] Injecting reconnection success assistant message"),this.connection.sendEvent(t);const n={event_id:"success_resp_"+ ++this.messageSequence,type:"response.create"};await new Promise((e=>setTimeout(e,200))),console.log("[WebRTC Voice Agent] Triggering voice response for reconnection success"),this.connection.sendEvent(n)}catch(e){console.error("[WebRTC Voice Agent] Failed to inject success message:",e)}}else console.log("[WebRTC Voice Agent] Cannot inject success message - not connected")}async handleSessionTimeout(){try{this.timeoutHandler.stopSession(),await this.connection.disconnect(),await this.refreshToken(),await this.performConnection(!0),this.timeoutHandler.resetSession()}catch(e){console.error("[WebRTC Voice Agent] Failed to handle session timeout:",e),await this.handleError({type:"connection_failed",message:"Failed to refresh session after timeout",timestamp:Date.now(),details:e,recoverable:!0})}}needsReconnection(){return!!this.sessionManager&&this.sessionManager.needsReconnection()}async cleanup(){console.log("[WebRTC Voice Agent] Complete cleanup initiated"),this.timeoutHandler.destroy(),await this.disconnect(),this.sessionManager&&(this.sessionManager.clearAllSessionData(),this.sessionManager.cleanup()),console.log("[WebRTC Voice Agent] Complete cleanup finished")}}"undefined"!=typeof window&&(window.WebRTCVoiceAgent=C);const A=(t={},n={})=>{const[s,o]=e.useState(!1),[i,a]=e.useState(!1),[r,c]=e.useState(!1),[l,d]=e.useState(!1),[u,h]=e.useState(!1),[g,m]=e.useState("idle"),[p,y]=e.useState("Ready to assist"),[v,f]=e.useState([]),[b,x]=e.useState((()=>T())),[S,k]=e.useState(null),[A,R]=e.useState(!1),[M,E]=e.useState(!0),[_,N]=e.useState(!1),[j,W]=e.useState(0),[D,P]=e.useState(!1),[V,L]=e.useState(!1),[F,O]=e.useState({isActive:!1,sessionId:null,messageCount:0,duration:0,reconnectAttempts:0,tokenExpiresIn:0}),z=e.useRef(null),B=e.useRef(!1),H=e.useRef(!1),$=e.useRef(0),q=e.useRef(""),U=e.useRef("");e.useEffect((()=>{P(!0),console.log("[WebRTC Hook] Session management delegated to WebRTCVoiceAgent")}),[]),e.useEffect((()=>{const e=()=>{if(z.current){const e=z.current.getSessionStats();O(e)}},t=setInterval(e,5e3);return e(),()=>clearInterval(t)}),[_]),e.useEffect((()=>(B.current||H.current||(async()=>{if(D)if(H.current||B.current||z.current)console.log("[WebRTC Hook] Skipping initialization - already initialized or in progress");else{if($.current>=3)return console.error("[WebRTC Hook] Max initialization attempts reached, stopping"),void k({code:"MAX_INIT_ATTEMPTS",message:"Failed to initialize after 3 attempts",type:"connection",recoverable:!1,details:"Maximum initialization attempts exceeded"});H.current=!0,$.current++;try{console.log(`[WebRTC Hook] Initializing WebRTC Voice Agent (attempt ${$.current})...`);const e=function(e){return new C(e)}({apiEndpoint:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?`${window.location.protocol}//${window.location.host}/api/voice-agent`:t.apiEndpoint||"/api/voice-agent",maxReconnectAttempts:3,reconnectDelay:1e3,audioConstraints:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});e.on("connectionStateChanged",G),e.on("conversationStateChanged",K),e.on("userTranscript",Y),e.on("assistantTranscript",Q),e.on("speechStarted",J),e.on("playbackStarted",X),e.on("playbackFinished",Z),e.on("error",ee),e.on("voiceActivityDetected",te),e.on("audioLevel",ne),e.on("sessionRestored",pe),e.on("sessionExpired",ye),e.on("reconnecting",ve),e.on("reconnected",fe),z.current=e,await e.initialize(),B.current=!0,console.log("[WebRTC Hook] WebRTC Voice Agent initialized successfully")}catch(e){if(console.error("[WebRTC Hook] Failed to initialize WebRTC Voice Agent:",e),z.current){try{await z.current.disconnect()}catch(e){console.error("[WebRTC Hook] Error during cleanup:",e)}z.current=null}k({code:"INITIALIZATION_ERROR",message:"Failed to initialize voice assistant",type:"connection",recoverable:$.current<3,details:e})}finally{H.current=!1}}else console.log("[WebRTC Hook] Waiting for session to load before initializing voice agent")})(),()=>{H.current=!1,z.current&&(z.current.disconnect().catch(console.error),z.current=null,B.current=!1,$.current=0)})),[D]);const G=e.useCallback((e=>{console.log("[Hook] Connection state changed from",_?"connected":"disconnected","to",e);const t=_,n="connected"===e;switch(N(n),w.updateConnectionState(e),n&&!t&&(console.log("[Hook] Successfully connected - clearing errors and updating state"),k(null),R(!0)),e){case"connected":m("idle"),y("Ready to assist"),R(!0);break;case"connecting":m("idle"),y("Connecting...");break;case"disconnected":m("idle"),y("Disconnected");break;case"failed":m("error"),y("Connection failed");break;case"reconnecting":m("idle"),y("Reconnecting...")}console.log("[Hook] Connection state update complete:",{newState:e,isConnected:n,status:"connected"===e?"idle":"failed"===e?"error":"idle",hasPermission:"connected"===e})}),[_]),K=e.useCallback((e=>{switch(console.log("Conversation state changed:",e),w.updateConversationState(e),e){case"listening":o(!0),a(!1),c(!1),m("listening"),y("Listening...");break;case"processing":o(!1),a(!0),c(!1),m("thinking"),y("Processing...");break;case"speaking":o(!1),a(!1),c(!0),m("speaking"),y("Speaking...");break;case"idle":o(!1),a(!1),c(!1),m("idle"),y("Ready to assist");break;case"interrupted":o(!1),a(!1),c(!1),m("idle"),y("Interrupted")}}),[]),Y=e.useCallback((e=>{if(console.log("[Hook] handleUserTranscript called:",{text:e.text,isFinal:e.isFinal}),e.isFinal){const t={id:I(),type:"user",content:e.text,timestamp:(new Date).toISOString()};console.log("[Hook] Adding final user message to state:",t),f((e=>{const n=[...e.slice(-49),t];return console.log("[Hook] Updated messages array after user transcript, length:",n.length),n})),w.addMessage(t),n.onMessage?.(t),q.current=""}else q.current=e.text,y(`Listening: "${e.text}"`),console.log("[Hook] Updated interim user transcript:",e.text)}),[n]),Q=e.useCallback((e=>{if(console.log("[Hook] handleAssistantTranscript called:",{text:e.text,isFinal:e.isFinal}),e.isFinal){const t=U.current+e.text,s={id:I(),type:"assistant",content:t,timestamp:(new Date).toISOString()};console.log("[Hook] Adding final assistant message to state:",s),f((e=>{const t=[...e.slice(-49),s];return console.log("[Hook] Updated messages array after assistant transcript, length:",t.length),t})),w.addMessage(s),n.onMessage?.(s),U.current=""}else U.current+=e.text,console.log("[Hook] Accumulated assistant transcript:",U.current)}),[n]),J=e.useCallback((()=>{console.log("User started speaking"),q.current=""}),[]),X=e.useCallback((()=>{console.log("Assistant started speaking"),U.current=""}),[]),Z=e.useCallback((()=>{if(console.log("Assistant finished speaking"),U.current){const e={id:I(),type:"assistant",content:U.current,timestamp:(new Date).toISOString()};f((t=>[...t.slice(-49),e])),w.addMessage(e),n.onMessage?.(e),U.current=""}}),[n]),ee=e.useCallback((e=>{console.error("Voice agent error:",e);const t={code:e.type.toUpperCase(),message:e.message,type:"microphone_permission_denied"===e.type?"permission":"connection_failed"===e.type?"connection":"api_error"===e.type?"api":"unknown",recoverable:e.recoverable,details:e.details};k(t),n.onError?.(t),m("error"),y(e.message)}),[n]),te=e.useCallback((e=>{console.log("Voice activity:",e)}),[]),ne=e.useCallback((e=>{W(e)}),[]),se=e.useCallback((async()=>{if(z.current&&_&&!s&&!l)try{z.current.startListening()}catch(e){console.error("Failed to start listening:",e),ee({type:"audio_error",message:"Failed to start listening",timestamp:Date.now(),details:e,recoverable:!0})}else console.warn("Cannot start listening:",{hasAgent:!!z.current,isConnected:_,isListening:s,isMuted:l})}),[_,s,l,ee]),oe=e.useCallback((()=>{if(z.current&&s)try{z.current.stopListening()}catch(e){console.error("Failed to stop listening:",e)}}),[s]),ie=e.useCallback((()=>{d((e=>!e)),!l&&s&&oe(),!l&&r&&z.current&&z.current.interrupt()}),[l,s,r,oe]),ae=e.useCallback((()=>{h((e=>!e))}),[]),re=e.useCallback((async e=>{if(console.log("[Hook] sendMessage called:",{message:e,hasAgent:!!z.current,isConnected:_,currentMessages:v.length}),z.current&&_)try{console.log("[Hook] Sending message to voice agent:",e),z.current.sendMessage(e),console.log("[Hook] Message sent to voice agent successfully")}catch(e){console.error("[Hook] Failed to send message:",e)}else console.warn("[Hook] Cannot send message - no agent or not connected")}),[_,n,v.length]),ce=e.useCallback((()=>{f([])}),[]),le=e.useCallback((async()=>{z.current&&(await z.current.disconnect(),await z.current.initialize()),ce(),k(null),m("idle"),y("Ready to assist")}),[ce]),de=e.useCallback((e=>{z.current&&_&&z.current.changeVoice(e)}),[_]),ue=e.useCallback((e=>{z.current&&_&&z.current.setVoiceSpeed(e)}),[_]),he=e.useCallback((e=>{z.current&&_&&z.current.setNoiseReduction(e)}),[_]),ge=e.useCallback((()=>z.current?z.current.getPerformanceMetrics():null),[]),me=e.useCallback((()=>z.current?z.current.getSessionStats():null),[]),pe=e.useCallback((e=>{console.log("[Hook] Session restored:",e),L(!0),x(e.sessionId),y("Session restored - reconnecting...");const t=e.metadata||{};O({isActive:e.isActive,sessionId:e.sessionId,messageCount:e.messages.length,duration:t.totalDuration||0,reconnectAttempts:t.reconnectAttempts||0,tokenExpiresIn:e.tokenExpiresAt?Math.max(0,e.tokenExpiresAt-Date.now()):0}),n.onMessage&&n.onMessage({id:I(),type:"system",content:"Previous conversation restored",timestamp:(new Date).toISOString()})}),[n]),ye=e.useCallback((()=>{console.log("[Hook] Session expired"),L(!1),y("Session expired - please refresh"),k({code:"SESSION_EXPIRED",message:"Your session has expired. Please refresh the page.",type:"session",recoverable:!0})}),[]),ve=e.useCallback((()=>{console.log("[Hook] Reconnecting..."),y("Reconnecting..."),m("idle")}),[]),fe=e.useCallback((()=>{console.log("[Hook] Reconnected successfully"),y("Reconnected successfully"),m("idle"),setTimeout((()=>{y("Ready to assist")}),2e3)}),[]);return{isListening:s,isThinking:i,isSpeaking:r,isMuted:l,isVoiceActivationEnabled:u,status:g,statusText:p,messages:v,sessionId:b,isConnected:_,audioLevel:j,sessionStats:F,isSessionRestored:V,startListening:se,stopListening:oe,toggleMute:ie,toggleVoiceActivation:ae,sendMessage:re,clearMessages:ce,resetSession:le,changeVoice:de,setVoiceSpeed:ue,setNoiseReduction:he,getPerformanceMetrics:ge,getSessionStats:me,isSupported:M,hasPermission:A,error:S}},T=()=>"va-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);let R=0;const I=()=>(R=(R+1)%1e4,`msg-${Date.now()}-${R}-${Math.random().toString(36).substr(2,9)}`),M={width:320,height:96,backgroundColor:"transparent",waveformColor:"#D4A034",barWidth:2,barSpacing:1,smoothing:.8,responsive:!0},E=({isActive:t,animationState:n,theme:s="auto",accessibilityMode:o="standard",width:i=384,height:r=128,barCount:c=64,sensitivity:l=1,smoothing:d=.8,audioLevel:u=0})=>{const h=e.useRef(null),g=e.useRef(),m=e.useRef(),p=e.useRef(),y=e.useRef(),v=e.useRef(new Array(c).fill(0)),[f,b]=e.useState(!1),[w,x]=e.useState(0),S=e.useCallback((()=>{if("high-contrast"===o)return{primary:"#FFFF00",secondary:"#000000",gradient:["#FFFF00","#FFFFFF"]};const e={idle:{primary:"#6B7280",secondary:"#9CA3AF",gradient:["#6B7280","#9CA3AF"]},listening:{primary:"#3B82F6",secondary:"#60A5FA",gradient:["#3B82F6","#60A5FA","#93C5FD"]},thinking:{primary:"#F59E0B",secondary:"#FBBF24",gradient:["#F59E0B","#FBBF24","#FCD34D"]},speaking:{primary:"#10B981",secondary:"#34D399",gradient:["#10B981","#34D399","#6EE7B7"]}};return"rainbow"===s?{primary:"#FF6B6B",secondary:"#4ECDC4",gradient:["#FF6B6B","#FFE66D","#4ECDC4","#45B7D1"]}:e[n]||e.idle}),[s,n,o]),k=e.useCallback((async()=>{try{if(m.current||(m.current=new(window.AudioContext||window.webkitAudioContext)),p.current||(p.current=m.current.createAnalyser(),p.current.fftSize=256,p.current.smoothingTimeConstant=d,y.current=new Uint8Array(p.current.frequencyBinCount)),t&&navigator.mediaDevices?.getUserMedia){const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});m.current.createMediaStreamSource(e).connect(p.current),b(!0)}}catch(e){console.warn("Failed to initialize audio:",e),b(!0)}}),[t,d]),C=e.useCallback((()=>{if(!y.current)return;const e=.001*Date.now(),t="idle"===n?20:"listening"===n?80:"thinking"===n?60:"speaking"===n?120:40;for(let n=0;n<y.current.length;n++){const s=n/y.current.length,o=t*(1+.5*Math.sin(2*e+.1*n))*Math.exp(2*-s)*l;y.current[n]=Math.min(255,Math.max(0,o+20*Math.random()))}}),[n,l]),A=e.useCallback((()=>{const e=h.current;if(!e)return;const s=e.getContext("2d");if(!s)return;const i=window.devicePixelRatio||1,a=e.getBoundingClientRect();e.width=a.width*i,e.height=a.height*i,s.scale(i,i);const r=a.width,l=a.height;if(s.clearRect(0,0,r,l),p.current&&y.current&&t?p.current.getByteFrequencyData(y.current):C(),!y.current)return;const d=Array.from(y.current).reduce(((e,t)=>e+t),0)/y.current.length/255;x(d);const u=S(),m=r/c,f=.1*m,b=m-f,w=s.createLinearGradient(0,l,0,0);u.gradient.forEach(((e,t)=>{w.addColorStop(t/(u.gradient.length-1),e)}));for(let e=0;e<c;e++){const t=Math.floor(e/c*y.current.length),n=y.current[t]/255*(.8*l);v.current[e]+=.3*(n-v.current[e]);const i=Math.max(2,v.current[e]),a=e*m+f/2,r=l-i;s.fillStyle="high-contrast"===o?u.primary:w,s.beginPath(),s.roundRect(a,r,b,i,2),s.fill(),i>.6*l&&"high-contrast"!==o&&(s.shadowColor=u.primary,s.shadowBlur=10,s.shadowOffsetX=0,s.shadowOffsetY=0,s.fill(),s.shadowBlur=0)}"idle"===n&&"high-contrast"!==o&&(s.setLineDash([5,5]),s.strokeStyle=u.secondary+"40",s.lineWidth=1,s.beginPath(),s.moveTo(0,l/2),s.lineTo(r,l/2),s.stroke(),s.setLineDash([])),(t||"idle"!==n)&&(g.current=requestAnimationFrame(A))}),[t,n,c,S,C,o]);return e.useEffect((()=>{t&&k()}),[t,k]),e.useEffect((()=>(f&&A(),()=>{g.current&&cancelAnimationFrame(g.current)})),[f,A]),e.useEffect((()=>()=>{g.current&&cancelAnimationFrame(g.current),m.current&&"closed"!==m.current.state&&m.current.close()}),[]),a.jsxs("div",{className:"relative w-full h-full overflow-hidden",children:[a.jsx("canvas",{ref:h,className:"w-full h-full","aria-hidden":"true",style:{imageRendering:"crisp-edges"}}),"enhanced"===o&&a.jsxs("div",{className:"absolute top-2 left-2 text-xs bg-black/50 text-white px-2 py-1 rounded",children:["idle"===n&&"Ready","listening"===n&&`Listening (${Math.round(100*w)}%)`,"thinking"===n&&"Processing...","speaking"===n&&"Speaking"]}),a.jsxs("div",{className:"sr-only","aria-live":"polite","aria-label":`Voice activity: ${Math.round(100*w)}%`,children:[n," - Volume: ",Math.round(100*w),"%"]})]})},_=[{id:"sage",name:"The Sage",description:"Wise, thoughtful, and measured in speech",icon:"🧙‍♂️",color:"#6366F1",gradient:"from-indigo-500 to-purple-600",sampleText:"Let me guide you through this learning journey with wisdom and patience.",characteristics:["Thoughtful","Patient","Wise","Calm"]},{id:"mentor",name:"The Mentor",description:"Encouraging, supportive, and educational",icon:"👨‍🏫",color:"#059669",gradient:"from-emerald-500 to-teal-600",sampleText:"You're doing great! Let's explore this concept together step by step.",characteristics:["Encouraging","Educational","Supportive","Clear"]},{id:"friend",name:"The Friend",description:"Casual, friendly, and approachable",icon:"😊",color:"#F59E0B",gradient:"from-amber-500 to-orange-600",sampleText:"Hey there! I'm here to help you learn in a fun and relaxed way.",characteristics:["Casual","Friendly","Warm","Approachable"]},{id:"expert",name:"The Expert",description:"Professional, precise, and knowledgeable",icon:"👩‍💼",color:"#DC2626",gradient:"from-red-500 to-pink-600",sampleText:"Based on current research and best practices, here's what you need to know.",characteristics:["Professional","Precise","Authoritative","Detailed"]},{id:"enthusiast",name:"The Enthusiast",description:"Energetic, passionate, and inspiring",icon:"🚀",color:"#8B5CF6",gradient:"from-violet-500 to-purple-600",sampleText:"This is so exciting! Let's dive deep into this amazing topic together!",characteristics:["Energetic","Passionate","Inspiring","Dynamic"]}],N=({currentPersonality:t,onPersonalityChange:n,theme:s="auto",showPreviews:o=!0,compact:i=!1})=>{const[r,c]=e.useState(null),[l,d]=e.useState(!1);e.useRef();const u=e.useRef(),h=e.useCallback((async e=>{if(o&&"speechSynthesis"in window)try{u.current&&(u.current.pause(),u.current=void 0),speechSynthesis.cancel(),c(e.id),d(!0);const t=new SpeechSynthesisUtterance(e.sampleText);switch(e.id){case"sage":t.rate=.8,t.pitch=.9,t.volume=.9;break;case"mentor":t.rate=.9,t.pitch=1,t.volume=1;break;case"friend":t.rate=1,t.pitch=1.1,t.volume=1;break;case"expert":t.rate=.95,t.pitch=.95,t.volume=.95;break;case"enthusiast":t.rate=1.1,t.pitch=1.2,t.volume=1}t.onend=()=>{c(null),d(!1)},t.onerror=()=>{c(null),d(!1)},speechSynthesis.speak(t)}catch(e){console.warn("Preview playback failed:",e),c(null),d(!1)}}),[o]),g=e.useCallback((()=>{speechSynthesis.cancel(),c(null),d(!1)}),[]),m=e.useCallback((e=>{n(e)}),[n]);return a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Voice Personality"}),l&&a.jsx("button",{onClick:g,className:"text-xs text-red-500 hover:text-red-600 transition-colors",children:"Stop Preview"})]}),a.jsx("div",{className:"grid gap-3 "+(i?"grid-cols-2":"grid-cols-1"),children:_.map((e=>{const n=t===e.id,s=r===e.id;return a.jsxs("div",{className:`\n                relative p-4 rounded-xl border-2 transition-all duration-300 cursor-pointer\n                ${n?"border-current bg-gradient-to-r "+e.gradient+" text-white shadow-lg scale-105":"border-gray-200 dark:border-gray-700 bg-white/20 dark:bg-gray-800/20 hover:border-gray-300 dark:hover:border-gray-600"}\n                ${s?"animate-pulse ring-2 ring-current":""}\n              `,onClick:()=>m(e.id),role:"button",tabIndex:0,"aria-pressed":n,onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),m(e.id))},children:[n&&a.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center shadow-lg",children:a.jsx("svg",{className:"w-4 h-4 text-current",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),a.jsxs("div",{className:"flex items-start space-x-3",children:[a.jsx("div",{className:"text-2xl flex-shrink-0",role:"img","aria-label":e.name,children:e.icon}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("h5",{className:"font-semibold text-sm "+(n?"text-white":"text-gray-900 dark:text-gray-100"),children:e.name}),o&&a.jsx("button",{onClick:t=>{t.stopPropagation(),s?g():h(e)},className:`\n                          p-1 rounded-full transition-colors text-xs\n                          ${n?"hover:bg-white/20 text-white":"hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400"}\n                        `,"aria-label":s?"Stop preview":"Play preview",disabled:l&&!s,children:s?a.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):a.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"})})})]}),a.jsx("p",{className:"text-xs mb-2 "+(n?"text-white/90":"text-gray-600 dark:text-gray-400"),children:e.description}),!i&&a.jsx("div",{className:"flex flex-wrap gap-1",children:e.characteristics.map((e=>a.jsx("span",{className:`\n                            px-2 py-0.5 rounded-full text-xs font-medium\n                            ${n?"bg-white/20 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300"}\n                          `,children:e},e)))})]})]}),!i&&n&&a.jsx("div",{className:"mt-3 pt-3 border-t border-white/20",children:a.jsxs("p",{className:"text-xs text-white/80 italic",children:['"',e.sampleText,'"']})})]},e.id)}))}),a.jsx("div",{className:"pt-2 border-t border-gray-200 dark:border-gray-700",children:a.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400",children:[a.jsx("span",{children:"Voice customization affects response tone and style"}),o&&a.jsxs("span",{className:"flex items-center space-x-1",children:[a.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.794L4.168 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.168l4.215-3.794zm5.617 5.11L13.414 10l1.586 1.586a1 1 0 01-1.414 1.414L12 11.414l-1.586 1.586a1 1 0 01-1.414-1.414L10.586 10 9 8.414a1 1 0 011.414-1.414L12 8.586l1.586-1.586a1 1 0 011.414 1.414z",clipRule:"evenodd"})}),a.jsx("span",{children:"Click play to preview"})]})]})})]})},j={mode:"standard",fontSize:"medium",reducedMotion:!1,screenReaderOptimized:!1,keyboardNavigationHints:!0,voiceDescriptions:!0,highContrastMode:!1,largeClickTargets:!1},W=({mode:t,onModeChange:n,settings:s={},onSettingsChange:o})=>{const[i,r]=e.useState({...j,mode:t,...s}),[c,l]=e.useState(!1),d=e.useRef(null),u=e.useCallback((e=>{const t=document.documentElement,n={small:"0.875rem",medium:"1rem",large:"1.125rem","extra-large":"1.375rem"};t.style.setProperty("--voice-widget-font-size",n[e.fontSize]);const s=document.querySelector("#webrtc-voice-assistant");if(s&&(s.style.fontSize=n[e.fontSize]),e.reducedMotion?(t.style.setProperty("--voice-widget-animation-duration","0s"),t.style.setProperty("--voice-widget-transition-duration","0s"),t.classList.add("voice-reduced-motion")):(t.style.removeProperty("--voice-widget-animation-duration"),t.style.removeProperty("--voice-widget-transition-duration"),t.classList.remove("voice-reduced-motion")),e.highContrastMode||"high-contrast"===e.mode?(t.classList.add("voice-widget-high-contrast"),t.style.setProperty("--voice-widget-contrast-ratio","7:1"),t.style.setProperty("--voice-widget-bg-contrast","#000000"),t.style.setProperty("--voice-widget-text-contrast","#FFFFFF"),t.style.setProperty("--voice-widget-border-contrast","#FFFF00")):(t.classList.remove("voice-widget-high-contrast"),t.style.removeProperty("--voice-widget-contrast-ratio"),t.style.removeProperty("--voice-widget-bg-contrast"),t.style.removeProperty("--voice-widget-text-contrast"),t.style.removeProperty("--voice-widget-border-contrast")),e.largeClickTargets?(t.style.setProperty("--voice-widget-click-target-size","48px"),t.style.setProperty("--voice-widget-min-touch-target","44px")):(t.style.removeProperty("--voice-widget-click-target-size"),t.style.removeProperty("--voice-widget-min-touch-target")),e.screenReaderOptimized){t.classList.add("voice-sr-optimized");const n=document.createElement("div");n.setAttribute("aria-live","polite"),n.setAttribute("aria-atomic","true"),n.className="sr-only",n.textContent=`Accessibility settings updated: ${e.mode} mode, ${e.fontSize} text`,document.body.appendChild(n),setTimeout((()=>document.body.removeChild(n)),1e3)}else t.classList.remove("voice-sr-optimized")}),[]),h=e.useCallback(((e,t)=>{const n={...i,[e]:t};r(n),o?.(n),u(n)}),[i,o,u]),g=e.useCallback((e=>{h("mode",e),n(e)}),[h,n]);return e.useEffect((()=>{u(i)}),[i,u]),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Accessibility"}),a.jsx("button",{onClick:()=>{const e=!c;if(l(e),e&&d.current){const e=d.current.getBoundingClientRect(),t=window.innerHeight,n=window.innerWidth;if(e.bottom>t||e.right>n){const s=d.current.closest("#webrtc-voice-assistant");if(s){const o=s;o.classList.add("voice-settings-expanded"),e.bottom>t&&(o.style.maxHeight=t-40+"px",o.style.overflowY="auto"),e.right>n&&(o.style.transform=`translateX(-${e.right-n+20}px)`)}}}else{const e=d.current?.closest("#webrtc-voice-assistant");if(e){const t=e;t.classList.remove("voice-settings-expanded"),t.style.removeProperty("max-height"),t.style.removeProperty("overflow-y"),t.style.removeProperty("transform")}}},className:"text-xs text-blue-500 hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500/50 rounded px-2 py-1","aria-expanded":c,"aria-controls":"accessibility-details",children:c?"Less Options":"More Options"})]}),a.jsx("div",{className:"grid grid-cols-1 gap-2",children:[{id:"standard",name:"Standard",description:"Default accessibility settings",icon:"👤",settings:{mode:"standard",fontSize:"medium",reducedMotion:!1,highContrastMode:!1,largeClickTargets:!1}},{id:"enhanced",name:"Enhanced",description:"Improved accessibility features",icon:"🔍",settings:{mode:"enhanced",fontSize:"large",reducedMotion:!1,highContrastMode:!1,largeClickTargets:!0,keyboardNavigationHints:!0,voiceDescriptions:!0}},{id:"high-contrast",name:"High Contrast",description:"Maximum visibility and accessibility",icon:"🎯",settings:{mode:"high-contrast",fontSize:"extra-large",reducedMotion:!0,highContrastMode:!0,largeClickTargets:!0,screenReaderOptimized:!0,keyboardNavigationHints:!0,voiceDescriptions:!0}}].map((e=>a.jsxs("button",{onClick:()=>{const t={...i,...e.settings};r(t),o?.(t),g(e.settings.mode),u(t)},className:`\n              flex items-center space-x-3 p-3 rounded-lg border-2 transition-all\n              ${t===e.id?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"}\n            `,role:"radio","aria-checked":t===e.id,tabIndex:0,children:[a.jsx("span",{className:"text-lg",role:"img","aria-label":e.name,children:e.icon}),a.jsxs("div",{className:"flex-1 text-left",children:[a.jsx("div",{className:"font-medium text-sm text-gray-900 dark:text-gray-100",children:e.name}),a.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.description})]}),t===e.id&&a.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})})]},e.id)))}),c&&a.jsxs("div",{ref:d,id:"accessibility-details",className:"space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[a.jsx("h5",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Custom Settings"}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-xs font-medium text-gray-600 dark:text-gray-400 mb-2",children:"Font Size"}),a.jsxs("select",{value:i.fontSize,onChange:e=>h("fontSize",e.target.value),className:"w-full p-2 border border-gray-200 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"small",children:"Small (14px)"}),a.jsx("option",{value:"medium",children:"Medium (16px)"}),a.jsx("option",{value:"large",children:"Large (18px)"}),a.jsx("option",{value:"extra-large",children:"Extra Large (22px)"})]})]}),a.jsx("div",{className:"space-y-3",children:[{key:"reducedMotion",label:"Reduce Motion",description:"Minimize animations and transitions"},{key:"screenReaderOptimized",label:"Screen Reader Optimized",description:"Enhanced compatibility with screen readers"},{key:"keyboardNavigationHints",label:"Keyboard Navigation Hints",description:"Show keyboard shortcuts and hints"},{key:"voiceDescriptions",label:"Voice Descriptions",description:"Audio descriptions of visual elements"},{key:"largeClickTargets",label:"Large Click Targets",description:"Increase button and link sizes"}].map((e=>a.jsxs("label",{className:"flex items-start space-x-3 cursor-pointer",children:[a.jsxs("div",{className:"relative flex-shrink-0 mt-0.5",children:[a.jsx("input",{type:"checkbox",checked:i[e.key],onChange:t=>h(e.key,t.target.checked),className:"sr-only"}),a.jsx("div",{className:`\n                    w-4 h-4 rounded border-2 transition-colors\n                    ${i[e.key]?"bg-blue-500 border-blue-500":"border-gray-300 dark:border-gray-600"}\n                  `,children:i[e.key]&&a.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]}),a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:e.label}),a.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.description})]})]},e.key)))}),a.jsx("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:a.jsx("button",{onClick:()=>{const e={...j,mode:t};r(e),o?.(e),u(e)},className:"text-xs text-red-500 hover:text-red-600 transition-colors",children:"Reset to Defaults"})})]}),a.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:a.jsxs("div",{className:"flex items-center space-x-2 text-xs text-blue-700 dark:text-blue-300",children:[a.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),a.jsxs("span",{children:["Current mode: ",a.jsx("strong",{children:t}),"medium"!==i.fontSize&&` • Font: ${i.fontSize}`,i.reducedMotion&&" • Reduced motion"]})]})}),a.jsxs("div",{className:"sr-only","aria-live":"polite",children:["Accessibility mode set to ",t,".",i.keyboardNavigationHints&&"Use Tab to navigate, Space or Enter to activate buttons.",i.voiceDescriptions&&"Voice descriptions are enabled."]})]})},D=({messages:t,isTyping:n=!1,onMessageSearch:s,onExportConversation:o,onMessageSelect:i,showTimestamps:r=!0,showSpeakerAvatars:c=!0,enableSearch:l=!0,enableExport:d=!0,maxDisplayedMessages:u=100,theme:h="auto"})=>{const[g,m]=e.useState(""),[p,y]=e.useState([]),[v,f]=e.useState(null),[b,w]=e.useState(!1),[x,S]=e.useState(0),[k,C]=e.useState(!1),A=e.useRef(null),T=e.useRef(null),R=e.useRef(null);e.useEffect((()=>{if(A.current&&!g){const e=A.current;e.scrollTop=e.scrollHeight}}),[t.length,g]);const I=e.useCallback((e=>{if(!e.trim())return y([]),void S(0);const n=[],o=e.toLowerCase();t.forEach((t=>{const s=t.content.toLowerCase(),i=[];let a=0;for(;;){const t=s.indexOf(o,a);if(-1===t)break;i.push([t,t+e.length]),a=t+1}i.length>0&&n.push({messageId:t.id,content:t.content,timestamp:t.timestamp,type:t.type,matchIndices:i})})),y(n),S(0),s?.(e)}),[t,s]);e.useEffect((()=>{const e=setTimeout((()=>{""!==g&&I(g)}),300);return()=>clearTimeout(e)}),[g,I]);const M=e.useCallback(((e,t)=>{if(!t.length)return e;const n=[];let s=0;return t.forEach((([t,o],i)=>{t>s&&n.push(e.slice(s,t)),n.push(a.jsx("mark",{className:"bg-yellow-200 dark:bg-yellow-800 text-yellow-900 dark:text-yellow-100 px-1 rounded",children:e.slice(t,o)},i)),s=o})),s<e.length&&n.push(e.slice(s)),a.jsx(a.Fragment,{children:n})}),[]),E=e.useCallback((e=>{if(e<0||e>=p.length)return;const t=p[e];S(e),f(t.messageId);const n=document.getElementById(`message-${t.messageId}`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})}),[p]),_=e.useCallback((e=>{o&&(o(e),w(!1))}),[o]);e.useEffect((()=>{const e=e=>{if((e.ctrlKey||e.metaKey)&&"f"===e.key&&(e.preventDefault(),C(!0),T.current?.focus()),"Escape"===e.key&&(m(""),y([]),C(!1)),"F3"===e.key&&p.length>0){e.preventDefault();const t=e.shiftKey?-1:1,n=(x+t+p.length)%p.length;E(n)}};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)}),[p.length,x,E]),e.useEffect((()=>{const e=e=>{R.current&&!R.current.contains(e.target)&&w(!1)};if(b)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)}),[b]);const N=e.useCallback((e=>{const t=new Date(e),n=((new Date).getTime()-t.getTime())/36e5;return n<24?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n<168?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),[]),j=e.useMemo((()=>t.slice(-u)),[t,u]);return a.jsxs("div",{className:"flex flex-col h-full bg-white dark:bg-gray-900",children:[a.jsxs("div",{className:"flex-shrink-0 border-b border-gray-200 dark:border-gray-700 p-4",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Conversation"}),a.jsxs("div",{className:"flex items-center space-x-2",children:[l&&a.jsx("button",{onClick:()=>{C(!k),k||setTimeout((()=>T.current?.focus()),100)},className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors","aria-label":"Search conversation",title:"Search (Ctrl+F)",children:a.jsx("svg",{className:"w-5 h-5 text-gray-600 dark:text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),d&&a.jsxs("div",{className:"relative",ref:R,children:[a.jsx("button",{onClick:()=>w(!b),className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors","aria-label":"Export conversation",children:a.jsx("svg",{className:"w-5 h-5 text-gray-600 dark:text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),b&&a.jsx("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-10",children:a.jsxs("div",{className:"p-2",children:[a.jsx("button",{onClick:()=>_("txt"),className:"w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm",children:"Export as Text"}),a.jsx("button",{onClick:()=>_("json"),className:"w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm",children:"Export as JSON"}),a.jsx("button",{onClick:()=>_("pdf"),className:"w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm",children:"Export as PDF"})]})})]})]})]}),l&&k&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"relative",children:[a.jsx("input",{ref:T,type:"text",value:g,onChange:e=>m(e.target.value),placeholder:"Search conversation...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),a.jsx("svg",{className:"absolute left-3 top-2.5 w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),p.length>0&&a.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600 dark:text-gray-400",children:[a.jsxs("span",{children:[x+1," of ",p.length," results"]}),a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx("button",{onClick:()=>E(x-1),disabled:0===p.length,className:"p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50","aria-label":"Previous result",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 19l-7-7 7-7"})})}),a.jsx("button",{onClick:()=>E(x+1),disabled:0===p.length,className:"p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50","aria-label":"Next result",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})})]})]})]})]}),a.jsxs("div",{ref:A,className:"flex-1 overflow-y-auto p-4 space-y-4",role:"log","aria-live":"polite","aria-label":"Conversation messages",children:[0===j.length?a.jsxs("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[a.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),a.jsx("p",{className:"text-lg font-medium mb-2",children:"No messages yet"}),a.jsx("p",{className:"text-sm",children:"Start a conversation to see messages here"})]}):j.map(((e,t)=>{const n=p.find((t=>t.messageId===e.id)),s=v===e.id;return a.jsxs("div",{id:`message-${e.id}`,className:`\n                  flex items-start space-x-3 p-3 rounded-lg transition-colors\n                  ${s?"bg-blue-50 dark:bg-blue-900/20 ring-2 ring-blue-500":"hover:bg-gray-50 dark:hover:bg-gray-800"}\n                  ${"user"===e.type?"flex-row-reverse space-x-reverse":""}\n                `,onClick:()=>{f(e.id),i?.(e.id)},children:[c&&a.jsx("div",{className:`\n                    w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0\n                    ${"user"===e.type?"bg-blue-500 text-white":"bg-green-500 text-white"}\n                  `,children:"user"===e.type?a.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z",clipRule:"evenodd"})}):a.jsxs("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:[a.jsx("path",{d:"M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"}),a.jsx("path",{d:"M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"})]})}),a.jsxs("div",{className:"flex-1 min-w-0 "+("user"===e.type?"text-right":""),children:[a.jsx("div",{className:`\n                    inline-block p-3 rounded-2xl max-w-lg\n                    ${"user"===e.type?"bg-blue-500 text-white ml-auto":"bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white"}\n                  `,children:a.jsx("p",{className:"text-sm whitespace-pre-wrap",children:n?M(e.content,n.matchIndices):e.content})}),r&&a.jsx("p",{className:`\n                      text-xs text-gray-500 dark:text-gray-400 mt-1\n                      ${"user"===e.type?"text-right":""}\n                    `,children:N(e.timestamp)})]})]},e.id)})),n&&a.jsxs("div",{className:"flex items-start space-x-3",children:[a.jsx("div",{className:"w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center flex-shrink-0",children:a.jsxs("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:[a.jsx("path",{d:"M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"}),a.jsx("path",{d:"M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"})]})}),a.jsx("div",{className:"bg-gray-100 dark:bg-gray-800 rounded-2xl p-3",children:a.jsxs("div",{className:"flex space-x-1",children:[a.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),a.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),a.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})]})]}),a.jsx("div",{className:"sr-only",children:"Keyboard shortcuts: Ctrl+F to search, F3 to navigate results, Escape to clear search"})]})};class P{static STORAGE_KEY="va_active_session";static MAX_RESTORATION_TIME=6e5;static saveActiveSession(e){try{const t={sessionId:e,shouldRestore:!0,lastActivity:Date.now(),pageLoadTime:Date.now()};sessionStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),console.log("[SessionRestoration] Active session saved:",e)}catch(e){console.error("[SessionRestoration] Failed to save active session:",e)}}static getSessionToRestore(){try{const e=sessionStorage.getItem(this.STORAGE_KEY);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.lastActivity>this.MAX_RESTORATION_TIME?(console.log("[SessionRestoration] Session too old, not restoring"),this.clearActiveSession(),null):t}catch(e){return console.error("[SessionRestoration] Failed to get session to restore:",e),null}}static updateLastActivity(e){try{const t=sessionStorage.getItem(this.STORAGE_KEY);if(!t)return;const n=JSON.parse(t);n.sessionId===e&&(n.lastActivity=Date.now(),sessionStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)))}catch(e){console.error("[SessionRestoration] Failed to update last activity:",e)}}static clearActiveSession(){try{sessionStorage.removeItem(this.STORAGE_KEY),console.log("[SessionRestoration] Active session cleared")}catch(e){console.error("[SessionRestoration] Failed to clear active session:",e)}}static async restoreSession(){const e={sessionData:null,preferences:b.getPreferences(),shouldConnect:!1};try{const t=this.getSessionToRestore();if(!t||!t.sessionId)return console.log("[SessionRestoration] No session to restore"),e;console.log("[SessionRestoration] Attempting to restore session:",t.sessionId);const n=await w.loadSession(t.sessionId);if(!n)return console.log("[SessionRestoration] Session data not found"),this.clearActiveSession(),e;const s=Date.now()-n.lastActivity,o=s<3e5;return e.sessionData=n,e.shouldConnect=o,console.log("[SessionRestoration] Session restored successfully:",{sessionId:n.sessionId,messageCount:n.messages.length,shouldConnect:o,timeSinceLastActivity:Math.round(s/1e3)}),this.saveActiveSession(t.sessionId),e}catch(t){return console.error("[SessionRestoration] Failed to restore session:",t),this.clearActiveSession(),e}}static setupVisibilityHandling(e){const t=()=>{document.hidden,this.updateLastActivity(e)},n=()=>{this.updateLastActivity(e)};return document.addEventListener("visibilitychange",t),window.addEventListener("beforeunload",n),()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("beforeunload",n)}}static getRestorationStats(){const e=this.getSessionToRestore();return{hasActiveSession:!!e,sessionAge:e?Date.now()-e.lastActivity:0,isRestorable:!!e&&Date.now()-e.lastActivity<this.MAX_RESTORATION_TIME}}}if("undefined"!=typeof window){const e=P.getSessionToRestore();e&&Date.now()-e.lastActivity>6e5&&P.clearActiveSession()}const V=({position:t="bottom-right",theme:n="auto",apiEndpoint:s="/api/voice-agent",showTranscript:o=!0,enableKeyboardShortcut:i=!0,autoMinimize:r=!0,enableGlassmorphism:c=!0,enableParticleEffects:l=!0,enableHapticFeedback:d=!0,showPersonalitySelector:u=!1,accessibilityMode:h="standard",enableAdvancedConversation:g=!1,onMessage:m,onStatusChange:p,onError:y,onPersonalityChange:v,onExportConversation:f})=>{const[x,S]=e.useState(!1),[k,C]=e.useState(!0),[T,R]=e.useState(!1),[I,_]=e.useState("sage"),[j,V]=e.useState(!1),[L,F]=e.useState(.15),[O,z]=e.useState("idle"),[B,H]=e.useState(""),[$,q]=e.useState(!1),U=e.useRef(null),G=e.useRef(null);e.useRef();const K={apiEndpoint:s,showTranscript:o,enableKeyboard:i,autoMinimize:r},Y=e.useCallback(((e="light")=>{d&&navigator.vibrate&&navigator.vibrate({light:[10],medium:[20],heavy:[30,10,30]}[e])}),[d]),{isListening:Q,isThinking:J,isSpeaking:X,isMuted:Z,status:ee,statusText:te,messages:ne,startListening:se,stopListening:oe,toggleMute:ie,sendMessage:ae,error:re,hasPermission:ce,isSupported:le,isConnected:de,audioLevel:ue,isSessionRestored:he}=A(K,{onMessage:m,onStatusChange:p,onError:y});let ge=re?"disconnected":de?"connected":"connecting";e.useEffect((()=>{console.log("[WebRTC Connection Debug]",{connectionState:ge,isConnected:de,hasPermission:ce,isSupported:le,error:re?.message,status:ee,statusText:te,timestamp:(new Date).toISOString()})}),[ge,de,ce,le,re,ee,te]),"undefined"!=typeof window&&window.DEBUG_VOICE_AGENT_FORCE_CONNECTED&&(console.log("[Debug] Forcing connection state to connected"),ge="connected"),((t,n,s={})=>{const o={...M,...s},[i,a]=e.useState(!1),[r,c]=e.useState(null),[l,d]=e.useState(null),u=e.useRef({context:null,analyser:null,mediaStream:null,source:null,isInitialized:!1}),h=e.useRef(null),g=e.useRef(null),m=e.useRef(null),p=e.useRef(null),y=e.useCallback((async()=>{try{const e=window.AudioContext||window.webkitAudioContext;if(!e)throw new Error("Web Audio API not supported");const t=new e,n=t.createAnalyser();n.fftSize=256,n.smoothingTimeConstant=o.smoothing,n.minDecibels=-90,n.maxDecibels=-10;const s=n.frequencyBinCount,i=new Uint8Array(s),a=new Uint8Array(n.fftSize);u.current={context:t,analyser:n,mediaStream:null,source:null,isInitialized:!0},m.current=i,p.current=a,console.log("Audio context initialized for visualization")}catch(e){console.error("Failed to initialize audio context:",e),d("Failed to initialize audio visualization")}}),[o.smoothing]),v=e.useCallback((()=>{const e=t.current;if(!e)return;const n=e.getContext("2d");if(!n)return;const s=e.getBoundingClientRect(),i=window.devicePixelRatio||1;e.width=(o.responsive?s.width:o.width)*i,e.height=(o.responsive?s.height:o.height)*i,n.scale(i,i),e.style.width=(o.responsive?s.width:o.width)+"px",e.style.height=(o.responsive?s.height:o.height)+"px",g.current=n}),[t,o.width,o.height,o.responsive]),f=e.useCallback((async()=>{let e=u.current;e.context&&e.analyser&&e.isInitialized||(await y(),e=u.current);try{const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});if(e.context&&e.analyser||(console.error("Audio context not initialized properly"),await y(),e=u.current),!e.context||!e.analyser)throw new Error("Failed to initialize audio context");{const n=e.context.createMediaStreamSource(t);n.connect(e.analyser),u.current.mediaStream=t,u.current.source=n}console.log("Audio stream connected to analyser")}catch(e){console.error("Failed to connect audio stream:",e),d("Failed to access microphone for visualization")}}),[y]),b=e.useCallback((()=>{const e=u.current;e.source&&(e.source.disconnect(),e.source=null),e.mediaStream&&(e.mediaStream.getTracks().forEach((e=>e.stop())),e.mediaStream=null)}),[]),w=e.useCallback((()=>{const e=t.current,n=g.current,s=u.current.analyser,i=m.current,a=p.current;if(!(e&&n&&s&&i&&a))return;s.getByteFrequencyData(i),s.getByteTimeDomainData(a);const r=i.reduce(((e,t)=>e+t),0)/i.length/255;n.clearRect(0,0,e.width/(window.devicePixelRatio||1),e.height/(window.devicePixelRatio||1));const l=e.width/(window.devicePixelRatio||1),d=e.height/(window.devicePixelRatio||1),h=Math.min(i.length,Math.floor(l/(o.barWidth+o.barSpacing))),y=o.barWidth,v=o.barSpacing;n.fillStyle=o.waveformColor;for(let e=0;e<h;e++){const t=i[Math.floor(e/h*i.length)]/255*d*.8,s=e*(y+v),a=d-t,r=n.createLinearGradient(0,a,0,d);r.addColorStop(0,o.waveformColor),r.addColorStop(1,o.waveformColor+"80"),n.fillStyle=r,n.fillRect(s,a,y,t),t>.5*d&&(n.shadowBlur=10,n.shadowColor=o.waveformColor,n.fillRect(s,a,y,t),n.shadowBlur=0)}const f={frequencyData:new Uint8Array(i),timeDomainData:new Uint8Array(a),volume:r,isActive:!0};c(f)}),[t,o]),x=e.useCallback((()=>{const e=()=>{w(),h.current=requestAnimationFrame(e)};e()}),[w]),S=e.useCallback((()=>{h.current&&(cancelAnimationFrame(h.current),h.current=null)}),[]),k=e.useCallback((async()=>{if(!i)try{v(),await f(),x(),a(!0),d(null)}catch(e){console.error("Failed to start visualization:",e),d("Failed to start audio visualization")}}),[i,v,f,x]),C=e.useCallback((()=>{if(!i)return;S(),b();const e=t.current,n=g.current;e&&n&&n.clearRect(0,0,e.width/(window.devicePixelRatio||1),e.height/(window.devicePixelRatio||1)),a(!1),c(null)}),[i,S,b,t]);e.useEffect((()=>{n&&!i?k():!n&&i&&C()}),[n,i,k,C]),e.useEffect((()=>{if(!o.responsive)return;const e=()=>{i&&v()};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[i,o.responsive,v]),e.useEffect((()=>()=>{C();const e=u.current;e.context&&"closed"!==e.context.state&&e.context.close()}),[C])})(U,Q||X),e.useEffect((()=>{let e;return e=setTimeout((()=>{z(Q?"listening":J?"thinking":X?"speaking":"idle")}),100),()=>clearTimeout(e)}),[Q,J,X]);const me=e.useCallback((e=>{_(e),v?.(e),Y("medium")}),[v,Y]),[pe,ye]=e.useState("dark"===n);e.useEffect((()=>{if("auto"===n&&"undefined"!=typeof document){ye(document.documentElement.classList.contains("dark"));const e=new MutationObserver((e=>{e.forEach((e=>{"attributes"===e.type&&"class"===e.attributeName&&ye(document.documentElement.classList.contains("dark"))}))}));return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()}}),[n]),e.useEffect((()=>{S(!0)}),[]),e.useEffect((()=>{if(x)try{const e=b.getPreferences();console.log("[WebRTC Voice] Loaded preferences after hydration:",e),C(e.isMinimized)}catch(e){console.error("[WebRTC Voice] Failed to load preferences:",e)}}),[x]),e.useEffect((()=>{if("undefined"!=typeof window)try{const e={isMinimized:k,theme:n,position:t};console.log("[WebRTC Voice] Saving preferences:",e),b.savePreferences(e),console.log("[WebRTC Voice] Preferences saved successfully")}catch(e){console.error("[WebRTC Voice] Failed to save preferences:",e)}}),[k,n,t]);const ve=e.useCallback((()=>{if(!c)return{background:pe?"#111418":"#F9F9F9",border:"1px solid "+(pe?"#2C323B":"#E5E7EB")};const e={backdropFilter:"blur(4px) saturate(1.2)",background:pe?`rgba(17, 20, 24, ${L+.7})`:`rgba(249, 249, 249, ${L+.7})`,border:pe?"1px solid rgba(212, 160, 52, 0.3)":"1px solid rgba(10, 34, 64, 0.2)",boxShadow:pe?"0 8px 25px -5px rgba(0, 0, 0, 0.4)":"0 8px 25px -5px rgba(0, 0, 0, 0.15)"};return"rainbow"===n?{...e,background:`linear-gradient(135deg, \n          rgba(212, 160, 52, ${L}), \n          rgba(10, 34, 64, ${L}), \n          rgba(180, 134, 40, ${L}),\n          rgba(26, 58, 92, ${L})\n        )`,borderImage:"linear-gradient(45deg, #D4A034, #0A2240, #B48628, #1A3A5C) 1"}:e}),[c,pe,L,n]);e.useEffect((()=>{if(!i)return;const e=e=>{"Space"!==e.code||e.target?.matches?.("input, textarea, [contenteditable]")||(e.preventDefault(),Z||(Q?(oe(),R(!1)):(se(),R(!0)))),"Escape"!==e.code||k||C(!0),(e.ctrlKey||e.metaKey)&&"KeyM"===e.code&&(e.preventDefault(),ie())};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}}),[i,Q,Z,k,se,oe,ie]),e.useEffect((()=>{if(!r||k)return;const e=e=>{e.target.closest("#webrtc-voice-assistant")||C(!0)};return document.addEventListener("click",e),()=>document.removeEventListener("click",e)}),[r,k]),e.useEffect((()=>{if(console.log("[WebRTC Voice] Component mounted, initializing..."),"undefined"!=typeof window)try{console.log("[WebRTC Voice] Session persistence modules loaded successfully"),console.log("[WebRTC Voice] Current preferences:",b.getPreferences()),console.log("[WebRTC Voice] Session restoration stats:",P.getRestorationStats()),window.WebRTCVoiceAgent={status:ee,isListening:Q,messages:ne,sessionPersistence:w,VoicePreferencesManager:b,SessionRestoration:P}}catch(e){console.error("[WebRTC Voice] Error loading session persistence modules:",e),window.WebRTCVoiceAgent={status:ee,isListening:Q,messages:ne}}const e=new CustomEvent("voice-agent-ready",{detail:{timestamp:Date.now()}});window.dispatchEvent(e),console.log("[WebRTC Voice] Ready event dispatched")}),[ee,Q,ne]),e.useEffect((()=>{const e=()=>{document.hidden?console.log("[WebRTC Voice] Page hidden, maintaining session"):console.log("[WebRTC Voice] Page visible, session should be active")},t=()=>{console.log("[WebRTC Voice] Page unloading, preserving session for restoration")};return document.addEventListener("visibilitychange",e),window.addEventListener("beforeunload",t),()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("beforeunload",t)}}),[]);const fe=e.useCallback((()=>{console.log("[WebRTC Voice] Toggle panel clicked, current state:",k),C(!k)}),[k]);e.useCallback((()=>{console.log("[WebRTC Voice] Voice indicator - continuous mode active")}),[]);const be=e.useCallback((()=>{window.open("https://calendly.com/your-booking-link","_blank"),"undefined"!=typeof gtag&&gtag("event","webrtc_voice_assistant_cta_click",{event_category:"engagement",event_label:"discovery_call"})}),[]),we=e.useCallback((async()=>{const e=B.trim();if(console.log("[Text Input] Send attempt:",{messageText:e,isSendingText:$,connectionState:ge,isConnected:de,hasPermission:ce,error:re?.message,sendMessage:typeof ae}),e&&!$)if("function"==typeof ae){if(!de){if(console.warn("[Text Input] Not connected, cannot send message. ConnectionState:",ge),"undefined"==typeof window||!window.DEBUG_VOICE_AGENT_FORCE_CONNECTED)return;console.log("[Text Input] Debug mode - sending message anyway")}q(!0);try{console.log("[Text Input] Sending message:",e),await ae(e),H(""),Y("light"),console.log("[Text Input] Message sent successfully")}catch(e){console.error("[Text Input] Error sending text message:",e),y&&y(e instanceof Error?e:new Error("Failed to send message"))}finally{q(!1)}}else console.error("[Text Input] sendMessage function not available");else console.log("[Text Input] Blocked: empty input or already sending")}),[B,$,de,ge,ae,Y,ce,re,y]);return e.useCallback((e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),we())}),[we]),x?a.jsxs(a.Fragment,{children:[a.jsxs("div",{id:"webrtc-voice-assistant","data-voice-agent-widget":"true",className:`fixed ${{"bottom-right":"bottom-6 right-6","bottom-left":"bottom-6 left-6","top-right":"top-6 right-6","top-left":"top-6 left-6"}[t]} z-[1000] font-sans`,role:"region","aria-label":"WebRTC Voice Assistant",children:[a.jsxs("div",{className:`mb-4 w-96 rounded-3xl shadow-2xl transition-all duration-500 transform-gpu ${k?"opacity-0 scale-75 translate-y-4 pointer-events-none":"opacity-100 scale-100 translate-y-0 pointer-events-auto"} ${k?"":"listening"===O?"voice-listening-pulse":"thinking"===O?"voice-thinking-bounce":"speaking"===O?"voice-speaking-pulse":"hover:scale-[1.02]"} ${"high-contrast"===h?"border-4 border-yellow-400":""}`,style:{...ve(),transformOrigin:t.includes("bottom")?"bottom":"top"},role:"dialog","aria-labelledby":"voice-widget-title",children:[l&&a.jsx("canvas",{ref:G,className:"absolute inset-0 w-full h-full rounded-3xl pointer-events-none",width:"400",height:"600","aria-hidden":"true"}),a.jsxs("div",{className:"relative z-10 flex items-center justify-between p-6 border-b border-brand-navy/20 dark:border-dark-gold/20",children:[a.jsxs("div",{className:"flex items-center space-x-4",children:[a.jsxs("div",{className:"relative",children:[a.jsx("div",{className:"w-6 h-6 rounded-full transition-all duration-300 "+("listening"===O?"bg-voice-connected animate-ping":"thinking"===O?"bg-voice-processing animate-bounce":"speaking"===O?"bg-brand-gold animate-pulse":"bg-brand-charcoal/60 dark:bg-dark-text-muted")}),"idle"!==O&&a.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-current animate-ping opacity-40"})]}),a.jsxs("div",{children:[a.jsx("h3",{id:"voice-widget-title",className:"text-lg font-bold text-brand-charcoal dark:text-dark-text",children:"AI Voice Assistant"}),a.jsx("p",{className:"text-sm text-brand-charcoal/70 dark:text-dark-text-secondary",children:te})]})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("button",{onClick:e=>{e.stopPropagation(),V(!j),Y("light")},className:"p-2 rounded-xl bg-brand-navy/20 hover:bg-brand-navy/30 dark:bg-dark-gold/20 dark:hover:bg-dark-gold/30 transition-colors text-brand-charcoal dark:text-dark-text","aria-label":"Settings",children:a.jsxs("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:[a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}),a.jsx("button",{onClick:ie,className:"p-2 rounded-xl bg-brand-navy/20 hover:bg-brand-navy/30 dark:bg-dark-gold/20 dark:hover:bg-dark-gold/30 transition-colors text-brand-charcoal dark:text-dark-text","aria-label":Z?"Unmute":"Mute",title:Z?"Unmute (Ctrl+M)":"Mute (Ctrl+M)",children:Z?a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.59-.79-1.59-1.78V9.67c0-.99.71-1.78 1.59-1.78h2.54z"})}):a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.59-.79-1.59-1.78V9.67c0-.99.71-1.78 1.59-1.78h2.54z"})})}),a.jsx("button",{onClick:e=>{e.stopPropagation(),C(!0),Y("light")},className:"p-2 rounded-xl bg-brand-navy/20 hover:bg-brand-navy/30 dark:bg-dark-gold/20 dark:hover:bg-dark-gold/30 transition-colors text-brand-charcoal dark:text-dark-text","aria-label":"Minimize",title:"Minimize (Esc)",children:a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 8.25l-7.5 7.5-7.5-7.5"})})})]})]}),a.jsxs("div",{className:"relative z-10 p-6 space-y-6",children:[a.jsxs("div",{className:"relative h-32 rounded-2xl overflow-hidden bg-brand-navy/10 dark:bg-dark-gold/10",children:[a.jsx(E,{isActive:Q||X,animationState:O,theme:n,accessibilityMode:h,audioLevel:ue}),a.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:a.jsxs("button",{onClick:e=>{e.stopPropagation(),Q?oe():Z||"connected"!==ge||se(),Y("medium")},className:`\n                    relative w-20 h-20 rounded-full shadow-2xl transition-all duration-300 transform-gpu\n                    ${"listening"===O?"scale-110 animate-pulse shadow-voice-connected/50":"hover:scale-105"}\n                    ${Z?"bg-brand-charcoal/60 cursor-not-allowed":"connected"!==ge?"bg-brand-charcoal/40 cursor-not-allowed":Q?"bg-gradient-to-r from-voice-error to-voice-recording":"bg-gradient-to-r from-brand-navy to-brand-gold"}\n                  `,"aria-label":Z?"Microphone muted":"connected"!==ge?"Not connected":Q?"Stop recording":"Start recording",disabled:Z||"connected"!==ge,title:Z?"Unmute to start recording":"connected"!==ge?"Waiting for connection...":Q?"Click to stop recording":"Click to start recording",children:[Q?a.jsx("svg",{className:"w-8 h-8 text-white absolute inset-0 m-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 12a9 9 0 11-6.219-8.56"})}):a.jsxs("svg",{className:"w-8 h-8 text-white absolute inset-0 m-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:[a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 10v2a7 7 0 01-14 0v-2"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 19v4"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8 23h8"})]}),Q&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white/50 animate-ping"}),a.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white/30 animate-ping",style:{animationDelay:"0.5s"}})]}),Q&&a.jsx("div",{className:"absolute -top-2 -right-2 w-4 h-4 bg-red-500 rounded-full animate-pulse",children:a.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white"})})]})})]}),j&&a.jsxs("div",{className:"space-y-4 p-4 rounded-2xl bg-brand-navy/10 dark:bg-dark-gold/10 backdrop-blur-sm border border-brand-navy/20 dark:border-dark-gold/20",children:[a.jsxs("div",{className:"flex justify-between items-center mb-2",children:[a.jsx("h3",{className:"text-sm font-semibold text-brand-charcoal dark:text-dark-text",children:"Settings"}),a.jsx("button",{onClick:e=>{e.stopPropagation(),V(!1)},className:"p-1 rounded hover:bg-brand-navy/20 dark:hover:bg-dark-gold/20 transition-colors","aria-label":"Close settings",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),u&&a.jsx(N,{currentPersonality:I,onPersonalityChange:me,theme:n}),a.jsx(W,{mode:h,onModeChange:e=>{Y("light");const t=document.getElementById("webrtc-voice-assistant");t&&t.setAttribute("data-accessibility-mode",e)},onSettingsChange:e=>{Y("light");try{localStorage.setItem("voice-assistant-accessibility",JSON.stringify(e))}catch(e){console.warn("Failed to save accessibility settings:",e)}}}),c&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-brand-charcoal dark:text-dark-text mb-2",children:"Glass Effect Intensity"}),a.jsx("input",{type:"range",min:"0.05",max:"0.3",step:"0.05",value:L,onChange:e=>F(parseFloat(e.target.value)),className:"w-full h-2 bg-brand-navy/20 dark:bg-dark-gold/20 rounded-lg appearance-none cursor-pointer"})]})]}),a.jsx("div",{className:"flex items-center justify-center mb-4",children:a.jsxs("div",{className:"flex items-center space-x-3 px-4 py-2 rounded-full bg-brand-navy/10 dark:bg-dark-gold/10 backdrop-blur-sm border border-brand-navy/20 dark:border-dark-gold/20",children:[a.jsx("div",{className:"w-3 h-3 rounded-full "+("connected"===ge?"bg-voice-connected animate-pulse":"connecting"===ge?"bg-voice-connecting animate-pulse":"bg-voice-error")}),a.jsx("span",{className:"text-sm font-medium text-brand-charcoal dark:text-dark-text",children:he?"connected"===ge?"Restored & Connected":"Reconnecting...":"connected"===ge?"Connected":"connecting"===ge?"Connecting...":"Disconnected"}),he&&a.jsx("div",{className:"w-2 h-2 rounded-full bg-brand-gold animate-ping",title:"Session restored"})]})}),o&&a.jsxs("div",{className:"h-64 flex flex-col",children:[a.jsx("div",{className:"flex-1 overflow-y-auto space-y-3 pb-3",children:g?a.jsx(D,{messages:ne,isTyping:J,showTimestamps:!0,showSpeakerAvatars:!0,enableSearch:!0,enableExport:!!f,onExportConversation:f,theme:n,maxDisplayedMessages:50}):a.jsx(a.Fragment,{children:0===ne.length?a.jsxs("div",{className:"text-center py-8 text-brand-charcoal/70 dark:text-dark-text-secondary",children:[a.jsx("p",{className:"text-sm",children:"Ready to assist with your learning journey!"}),a.jsx("p",{className:"text-xs mt-2",children:"Start speaking or type a message to begin"}),a.jsxs("p",{className:"text-xs mt-1 opacity-50",children:["Status: ",ge]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"text-xs text-brand-charcoal/70 dark:text-dark-text-secondary mb-2",children:[ne.length," message",1!==ne.length?"s":""," • ",ge]}),ne.slice(-5).map((e=>{return a.jsxs("div",{className:`\n                                flex items-start space-x-3 p-3 rounded-2xl transition-all duration-200\n                                ${"user"===e.type?"bg-brand-navy/20 ml-8 border-l-2 border-brand-navy dark:bg-dark-gold/20 dark:border-dark-gold":"bg-brand-gold/20 mr-8 border-l-2 border-brand-gold dark:bg-accent-gold/20 dark:border-accent-gold"}\n                              `,children:[a.jsx("div",{className:`\n                                w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0\n                                ${"user"===e.type?"bg-brand-navy dark:bg-dark-gold":"bg-brand-gold dark:bg-accent-gold"}\n                              `,children:"user"===e.type?a.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}):a.jsx("svg",{className:"w-4 h-4 text-white dark:text-dark-base",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"})})}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("span",{className:"text-xs font-medium text-brand-charcoal/80 dark:text-dark-text-secondary",children:"user"===e.type?"You":"Assistant"}),a.jsx("span",{className:"text-xs text-brand-charcoal/60 dark:text-dark-text-muted",children:(t=e.timestamp,new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))})]}),a.jsx("p",{className:"text-sm text-brand-charcoal dark:text-dark-text leading-relaxed",children:e.content})]})]},e.id);var t}))]})})}),a.jsxs("div",{className:"mt-3 pt-3 border-t border-brand-navy/20 dark:border-dark-gold/20",children:[a.jsx("div",{className:"flex items-center space-x-3",children:a.jsxs("div",{className:"flex-1 relative",children:[a.jsx("input",{type:"text",value:B,onChange:e=>H(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),we())},placeholder:"connected"===ge?"Type a message or use voice...":"connecting"===ge?"Connecting...":"Disconnected",disabled:!de||$,className:"w-full px-4 py-2 bg-brand-pearl/50 dark:bg-dark-surface-2 backdrop-blur-sm border border-brand-navy/20 dark:border-dark-gold/20 rounded-xl text-sm text-brand-charcoal dark:text-dark-text placeholder-brand-charcoal/50 dark:placeholder-dark-text-muted focus:outline-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200","aria-label":"Type a message"}),a.jsx("button",{onClick:we,disabled:!B.trim()||!de||$,className:"absolute right-2 top-1/2 transform -translate-y-1/2 p-1.5 rounded-lg bg-brand-gold hover:bg-brand-gold-warm disabled:bg-brand-charcoal/40 disabled:cursor-not-allowed transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-brand-gold/50","aria-label":"Send message",title:B.trim()?de?"Send message (Enter)":"Not connected":"Type a message to send",children:$?a.jsx("svg",{className:"w-4 h-4 text-white animate-spin",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"})}):a.jsx("svg",{className:"w-4 h-4 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"})})})]})}),a.jsxs("div",{className:"flex items-center justify-between mt-2",children:[a.jsxs("p",{className:"text-xs text-brand-charcoal/60 dark:text-dark-text-muted",children:["Press Enter to send • ",i?"Space for voice":"Click mic for voice"]}),$&&a.jsx("span",{className:"text-xs text-brand-gold animate-pulse",children:"Sending..."})]})]})]})]}),re&&a.jsx("div",{className:"absolute bottom-4 left-4 right-4 p-3 bg-voice-error/20 border border-voice-error/30 rounded-xl backdrop-blur-sm",children:a.jsx("p",{className:"text-sm text-voice-error dark:text-voice-error",children:re.message})}),a.jsxs("div",{className:"relative z-10 p-4 border-t border-brand-navy/20 dark:border-dark-gold/20 bg-brand-pearl/5 dark:bg-dark-surface/5 rounded-b-3xl backdrop-blur-sm",children:[a.jsx("button",{onClick:be,className:"w-full bg-gradient-to-r from-brand-navy to-brand-gold text-white font-semibold py-3 px-4 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-brand-gold/30",children:"Book Your 15-Minute Discovery Call"}),a.jsx("p",{className:"text-xs text-brand-charcoal/60 dark:text-dark-text-muted text-center mt-2",children:"Powered by OpenAI Realtime • Privacy Protected"})]})]}),a.jsxs("button",{onClick:fe,className:`\n            w-16 h-16 rounded-full shadow-2xl transition-all duration-500 transform-gpu \n            focus:outline-none focus:ring-4 focus:ring-brand-gold/30 flex items-center justify-center relative group voice-gpu-accelerated\n            ${c?"backdrop-blur-lg bg-brand-navy/20 dark:bg-dark-gold/20 border border-brand-navy/30 dark:border-dark-gold/30":"bg-gradient-to-r from-brand-navy to-brand-gold"}\n            ${"listening"===O?"voice-status-listening":"thinking"===O?"voice-status-thinking":"speaking"===O?"voice-status-speaking":re?"voice-status-error":"hover:scale-110"}\n          `,style:c?ve():{},"aria-label":k?"Open voice assistant":"Close voice assistant",title:k?"Open voice assistant":"Close voice assistant",children:[a.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-voice-error text-white text-xs rounded-full flex items-center justify-center transition-all duration-300 "+(ne.length>0&&k?"opacity-100 scale-100":"opacity-0 scale-0"),children:ne.length>9?"9+":ne.length}),(Q||X)&&a.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-brand-gold/50 animate-ping"}),a.jsxs("svg",{className:"w-8 h-8 text-white group-hover:scale-110 transition-transform",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:"2",children:[a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 10v2a7 7 0 01-14 0v-2"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 19v4"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M8 23h8"})]})]})]}),i&&a.jsxs("div",{className:`fixed bottom-24 ${t.includes("right")?"right-8":"left-8"} bg-brand-charcoal dark:bg-dark-surface-2 text-brand-pearl dark:text-dark-text text-sm px-3 py-2 rounded-lg shadow-lg pointer-events-none transition-all duration-300 z-[999] ${T?"opacity-100":"opacity-0"}`,role:"tooltip",children:["Press ",a.jsx("kbd",{className:"px-1 py-0.5 bg-brand-navy dark:bg-dark-surface-3 rounded text-xs",children:"Space"})," to ",Q?"stop":"start"," talking"]}),a.jsx("div",{id:"voice-live-region",className:"sr-only","aria-live":"polite","aria-atomic":"true",children:te})]}):null};export{V as default};