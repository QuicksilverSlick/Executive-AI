<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Search Complete Integration Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .test-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .test-description {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
    }
    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid transparent;
    }
    .log-info { border-left-color: #4a9eff; }
    .log-success { border-left-color: #4caf50; color: #a5d6a7; }
    .log-error { border-left-color: #f44336; color: #ef9a9a; }
    .log-search { border-left-color: #ff9800; color: #ffcc80; }
    .log-result { border-left-color: #9c27b0; color: #ce93d8; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }
    button:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    .status-indicator.ready { background: #4caf50; }
    .status-indicator.testing { background: #ff9800; }
    .status-indicator.error { background: #f44336; }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .code-block {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Voice Search Complete Integration Test</h1>
    <p class="subtitle">Verifying end-to-end voice agent search functionality with OpenAI Realtime API</p>

    <div class="test-section">
      <div class="test-title">
        <span class="status-indicator ready" id="statusIndicator"></span>
        Test Overview
      </div>
      <div class="test-description">
        This test verifies that:
        <ol>
          <li>The voice agent correctly triggers web_search function calls</li>
          <li>The search endpoint returns proper results with citations</li>
          <li>Search results are included in the function call response</li>
          <li>The AI naturally integrates search results into voice responses</li>
        </ol>
      </div>
    </div>

    <div class="test-section">
      <div class="test-title">üß™ Integration Flow Test</div>
      <div class="test-description">
        Simulates the complete flow from voice query to search results to voice response.
      </div>
      <button onclick="testCompleteFlow()">Run Complete Flow Test</button>
      <button onclick="testSearchEndpoint()">Test Search Endpoint Only</button>
      <button onclick="testFunctionCallFormat()">Test Function Call Format</button>
      <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="test-section">
      <div class="test-title">üìù Example Voice Conversations</div>
      <div class="test-description">
        Test these conversational search queries:
      </div>
      <div class="code-block">
User: "Can you look up information about SRI Energy?"
AI: "Let me search for information about SRI Energy for you..."
[Executes web_search function]
AI: "I found that SRI Energy is a leading renewable energy company..."</div>
      <div class="code-block">
User: "What AI tools are my restaurant competitors using?"
AI: "I'll search for AI tools being used in the restaurant industry..."
[Executes web_search function]
AI: "Based on current information, many restaurants are adopting..."</div>
    </div>

    <div class="console-output" id="console">
      <div class="log-entry log-info">Integration test console ready...</div>
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      const console = document.getElementById('console');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      console.appendChild(entry);
      console.scrollTop = console.scrollHeight;
    }

    function updateStatus(status) {
      const indicator = document.getElementById('statusIndicator');
      indicator.className = `status-indicator ${status}`;
    }

    async function testCompleteFlow() {
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      log('COMPLETE VOICE SEARCH FLOW TEST', 'info');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
      updateStatus('testing');

      try {
        // Step 1: Simulate voice query
        log('', 'info');
        log('STEP 1: Simulating voice query', 'info');
        log('User says: "What is SRI Energy company?"', 'search');

        // Step 2: Show function call that would be triggered
        log('', 'info');
        log('STEP 2: Voice agent triggers function call', 'info');
        const functionCall = {
          name: 'web_search',
          arguments: {
            query: 'SRI Energy company information renewable energy'
          }
        };
        log('Function call: ' + JSON.stringify(functionCall, null, 2), 'info');

        // Step 3: Execute actual search
        log('', 'info');
        log('STEP 3: Executing search via /api/voice-agent/responses-search', 'info');
        const startTime = Date.now();
        
        const response = await fetch('/api/voice-agent/responses-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: functionCall.arguments.query,
            conversationContext: 'User asked: What is SRI Energy company?'
          })
        });

        const responseTime = Date.now() - startTime;
        const result = await response.json();

        log(`Search completed in ${responseTime}ms`, 'success');

        // Step 4: Display search results
        log('', 'info');
        log('STEP 4: Search results received', 'info');
        
        if (result.success) {
          log('‚úì Search successful', 'success');
          
          if (result.response) {
            log('Natural language response:', 'result');
            log(result.response.substring(0, 300) + '...', 'result');
          }
          
          if (result.searchResults && result.searchResults.length > 0) {
            log(`Found ${result.searchResults.length} search results:`, 'result');
            result.searchResults.slice(0, 3).forEach((sr, i) => {
              log(`  ${i+1}. ${sr.title || 'Untitled'}`, 'result');
              log(`     Source: ${sr.source || 'Unknown'}`, 'result');
              if (sr.snippet) {
                log(`     Snippet: ${sr.snippet.substring(0, 100)}...`, 'result');
              }
            });
          }
          
          if (result.citations && result.citations.length > 0) {
            log(`Found ${result.citations.length} citations:`, 'result');
            result.citations.slice(0, 3).forEach((c, i) => {
              log(`  [${i+1}] ${c.title}: ${c.url}`, 'result');
            });
          }

          // Step 5: Show function result format
          log('', 'info');
          log('STEP 5: Function result sent back to voice agent', 'info');
          const functionResult = {
            success: true,
            query: functionCall.arguments.query,
            response: result.response,
            searchResults: result.searchResults || [],
            citations: result.citations || []
          };
          log('Function result includes:', 'info');
          log(`  - success: ${functionResult.success}`, 'info');
          log(`  - response: "${functionResult.response?.substring(0, 80)}..."`, 'info');
          log(`  - searchResults: ${functionResult.searchResults.length} results`, 'info');
          log(`  - citations: ${functionResult.citations.length} citations`, 'info');

          // Step 6: Simulate voice response
          log('', 'info');
          log('STEP 6: AI voice response (synthesized from search results)', 'info');
          log('AI would say:', 'success');
          log(`"${result.response}"`, 'success');

          log('', 'info');
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
          log('‚úÖ COMPLETE FLOW TEST PASSED', 'success');
          log('Voice agent successfully:', 'success');
          log('  1. Recognized search intent', 'success');
          log('  2. Executed web_search function', 'success');
          log('  3. Received search results with citations', 'success');
          log('  4. Included all data in function result', 'success');
          log('  5. Would synthesize natural voice response', 'success');
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
          
        } else {
          throw new Error(result.error || 'Search failed');
        }

      } catch (error) {
        log(`‚úó Test failed: ${error.message}`, 'error');
        updateStatus('error');
        return;
      }

      updateStatus('ready');
    }

    async function testSearchEndpoint() {
      log('Testing search endpoint directly...', 'info');
      updateStatus('testing');

      try {
        const queries = [
          'AI tools for restaurants',
          'SRI Energy renewable company',
          'dental practice automation software'
        ];

        for (const query of queries) {
          log(`Testing: "${query}"`, 'search');
          
          const response = await fetch('/api/voice-agent/responses-search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });

          const result = await response.json();
          
          if (result.success) {
            log(`‚úì Success - Response: ${result.response?.substring(0, 100)}...`, 'success');
            if (result.citations?.length > 0) {
              log(`  Found ${result.citations.length} citations`, 'result');
            }
          } else {
            log(`‚úó Failed: ${result.error}`, 'error');
          }
        }
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        updateStatus('error');
        return;
      }

      updateStatus('ready');
    }

    function testFunctionCallFormat() {
      log('Testing function call format...', 'info');
      
      const exampleFunctionCall = {
        type: 'function',
        name: 'web_search',
        call_id: 'call_' + Math.random().toString(36).substr(2, 9),
        arguments: {
          query: 'restaurant AI tools competitors'
        }
      };

      log('Example function call from voice agent:', 'info');
      log(JSON.stringify(exampleFunctionCall, null, 2), 'result');

      const exampleResult = {
        success: true,
        query: exampleFunctionCall.arguments.query,
        response: 'Based on my search, many restaurants are implementing AI tools for order management, customer service chatbots, and inventory optimization...',
        searchResults: [
          {
            title: 'Top AI Tools for Restaurants in 2025',
            url: 'https://example.com/ai-restaurant-tools',
            snippet: 'Leading restaurants are using AI for...',
            source: 'example.com'
          }
        ],
        citations: [
          {
            type: 'url_citation',
            title: 'Restaurant AI Adoption Report',
            url: 'https://example.com/report',
            start_index: 20,
            end_index: 45
          }
        ]
      };

      log('Expected function result format:', 'info');
      log(JSON.stringify(exampleResult, null, 2), 'result');

      log('‚úì Function call format verified', 'success');
    }

    function clearConsole() {
      document.getElementById('console').innerHTML = '<div class="log-entry log-info">Console cleared...</div>';
    }

    // Initial message
    log('Voice Search Integration Test Ready', 'info');
    log('This test verifies the complete flow from voice query ‚Üí search ‚Üí response', 'info');
    log('Click "Run Complete Flow Test" to begin', 'info');
  </script>
</body>
</html>